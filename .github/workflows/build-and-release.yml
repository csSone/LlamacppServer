name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: éªŒè¯ Java ç‰ˆæœ¬
        run: |
          echo "Java ç‰ˆæœ¬:"
          java -version
          javac -version

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          mkdir -p build/classes
          mkdir -p build/lib

      - name: å¤åˆ¶ä¾èµ–é¡¹åˆ° build/lib
        run: |
          cp lib/*.jar build/lib/
          echo "å¤åˆ¶ä¾èµ–é¡¹:"
          ls -lh build/lib/

      - name: æ„å»º classpath
        run: |
          CLASSPATH=""
          for jar in lib/*.jar; do
            if [ -z "$CLASSPATH" ]; then
              CLASSPATH="$jar"
            else
              CLASSPATH="$CLASSPATH:$jar"
            fi
          done
          echo "CLASSPATH=$CLASSPATH" >> $GITHUB_ENV

      - name: ç¼–è¯‘ Java æºç 
        run: |
          find src/main/java -name "*.java" -print0 | xargs -0 javac \
            -source 21 \
            -target 21 \
            -encoding UTF-8 \
            -d build/classes \
            -cp "$CLASSPATH"

      - name: å¤åˆ¶ resources åˆ° classes ç›®å½•
        run: |
          if [ -d "src/main/resources" ]; then
            cp -r src/main/resources/* build/classes/
            echo "å·²å¤åˆ¶ resources åˆ° classes ç›®å½•"
            echo "classes ç›®å½•å†…å®¹:"
            ls -la build/classes/
          else
            echo "resources ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶"
          fi

      - name: éªŒè¯ç¼–è¯‘ç»“æœ
        run: |
          echo "ç¼–è¯‘è¾“å‡ºæ–‡ä»¶:"
          find build/classes -type f | head -20
          echo "æ€»æ–‡ä»¶æ•°:"
          find build/classes -type f | wc -l

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (Linux)
        run: |
          mkdir -p build/jre-linux
          curl -L -o build/jre-linux.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.08-linux-x64.zip
          unzip -q build/jre-linux.zip -d build/jre-linux
          JRE_NAME=$(ls build/jre-linux | head -1)
          mv build/jre-linux/$JRE_NAME build/jre-linux/jre
          rm build/jre-linux.zip
          echo "Linux JRE ä¸‹è½½å®Œæˆ"
          ls -la build/jre-linux/jre/

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (Windows)
        run: |
          mkdir -p build/jre-win
          curl -L -o build/jre-win.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.08-win-x64.zip
          unzip -q build/jre-win.zip -d build/jre-win
          JRE_NAME=$(ls build/jre-win | head -1)
          mv build/jre-win/$JRE_NAME build/jre-win/jre
          rm build/jre-win.zip
          echo "Windows JRE ä¸‹è½½å®Œæˆ"
          ls -la build/jre-win/jre/

      - name: åˆ›å»ºå¯åŠ¨è„šæœ¬ (Linux/Mac)
        run: |
          cat > build/run.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          ./jre/bin/java -Xms64m -Xmx96m -classpath "./classes:./lib/*" org.mark.llamacpp.server.LlamaServer "$@"
          EOF
          chmod +x build/run.sh

      - name: åˆ›å»ºå¯åŠ¨è„šæœ¬ (Windows)
        run: |
          cat > build/run.bat << 'EOF'
          @echo off
          cd /d "%~dp0"
          jre\bin\java.exe -Xms64m -Xmx96m -classpath "./classes;./lib/*" org.mark.llamacpp.server.LlamaServer %*
          EOF

      - name: å¤åˆ¶ README åˆ° build ç›®å½•
        run: |
          if [ -f README.md ]; then
            cp README.md build/
          fi

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: æ‰“åŒ… Linux ç‰ˆæœ¬
        run: |
          cp -r build build-linux
          cp -r build/jre-linux/jre build-linux/jre
          rm -rf build-linux/jre-linux build-linux/jre-win
          mv build-linux llama-server-${{ steps.get_version.outputs.version }}-linux
          zip -r llama-server-${{ steps.get_version.outputs.version }}-linux.zip llama-server-${{ steps.get_version.outputs.version }}-linux

      - name: æ‰“åŒ… Windows ç‰ˆæœ¬
        run: |
          cp -r build build-win
          cp -r build/jre-win/jre build-win/jre
          rm -rf build-win/jre-linux build-win/jre-win
          mv build-win llama-server-${{ steps.get_version.outputs.version }}-windows
          zip -r llama-server-${{ steps.get_version.outputs.version }}-windows.zip llama-server-${{ steps.get_version.outputs.version }}-windows

      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # è·å–æœ€æ–°çš„ commit ä¿¡æ¯
          LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%an, %ar)")
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%B")
          
          # è·å–è‡ªä¸Šä¸€ä¸ª tag ä»¥æ¥çš„æ‰€æœ‰ commit
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS_SINCE_TAG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS_SINCE_TAG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          # ç”Ÿæˆ release notes
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Release Notes
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - ç¼–è¯‘åçš„ class æ–‡ä»¶
          - æ‰€æœ‰ä¾èµ–åº“ï¼ˆlib/*.jarï¼‰
          - ç²¾ç®€ç‰ˆ JRE 21.08ï¼ˆå†…ç½®ï¼Œæ— éœ€å®‰è£… Javaï¼‰
          - å¯åŠ¨è„šæœ¬ï¼ˆrun.sh / run.batï¼‰
          
          ### ğŸ“ ä½¿ç”¨æ–¹æ³•
          
          **Linux:**
          ```bash
          unzip llama-server-${{ steps.get_version.outputs.version }}-linux.zip
          cd llama-server-${{ steps.get_version.outputs.version }}-linux
          chmod +x run.sh
          ./run.sh
          ```
          
          **Windows:**
          ```cmd
          unzip llama-server-${{ steps.get_version.outputs.version }}-windows.zip
          cd llama-server-${{ steps.get_version.outputs.version }}-windows
          run.bat
          ```
          
          **æ³¨æ„ï¼š** æœ¬ç‰ˆæœ¬å·²å†…ç½®ç²¾ç®€ç‰ˆ JREï¼Œæ— éœ€é¢å¤–å®‰è£… Java ç¯å¢ƒã€‚
          
          ---
          
          ### ğŸ“Œ æœ€æ–°æäº¤
          EOF
          
          echo "$LATEST_COMMIT" >> release_notes.md
          echo "" >> release_notes.md
          
          # æ·»åŠ æäº¤è¯¦æƒ…
          if [ -n "$COMMITS_SINCE_TAG" ]; then
            echo "### ğŸ“‹ è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„å˜æ›´" >> release_notes.md
            echo "" >> release_notes.md
            echo "$COMMITS_SINCE_TAG" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "*æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> release_notes.md
          
          # è¾“å‡ºå†…å®¹ä¾›è°ƒè¯•
          echo "ç”Ÿæˆçš„ Release Notes:"
          cat release_notes.md
          
          # ä¿å­˜ä¸º artifact
          echo "NOTES_CONTENT<<EOF" >> $GITHUB_ENV
          cat release_notes.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: åˆ›å»º Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            llama-server-${{ steps.get_version.outputs.version }}-linux.zip
            llama-server-${{ steps.get_version.outputs.version }}-windows.zip
          body: ${{ env.NOTES_CONTENT }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}-linux
          path: llama-server-${{ steps.get_version.outputs.version }}-linux.zip
          retention-days: 30

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}-windows
          path: llama-server-${{ steps.get_version.outputs.version }}-windows.zip
          retention-days: 30
