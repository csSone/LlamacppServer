name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: éªŒè¯ Java ç‰ˆæœ¬
        run: |
          echo "Java ç‰ˆæœ¬:"
          java -version
          javac -version

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: |
          mkdir -p build/classes
          mkdir -p build/lib

      - name: å¤åˆ¶ä¾èµ–é¡¹åˆ° build/lib
        run: |
          cp lib/*.jar build/lib/
          echo "å¤åˆ¶ä¾èµ–é¡¹:"
          ls -lh build/lib/

      - name: æ„å»º classpath
        run: |
          CLASSPATH=""
          for jar in lib/*.jar; do
            if [ -z "$CLASSPATH" ]; then
              CLASSPATH="$jar"
            else
              CLASSPATH="$CLASSPATH:$jar"
            fi
          done
          echo "CLASSPATH=$CLASSPATH" >> $GITHUB_ENV

      - name: ç¼–è¯‘ Java æºç 
        run: |
          find src/main/java -name "*.java" -print0 | xargs -0 javac \
            -source 21 \
            -target 21 \
            -encoding UTF-8 \
            -d build/classes \
            -cp "$CLASSPATH"

      - name: å¤åˆ¶ resources åˆ° classes ç›®å½•
        run: |
          if [ -d "src/main/resources" ]; then
            cp -r src/main/resources/* build/classes/
            echo "å·²å¤åˆ¶ resources åˆ° classes ç›®å½•"
            echo "classes ç›®å½•å†…å®¹:"
            ls -la build/classes/
          else
            echo "resources ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶"
          fi

      - name: éªŒè¯ç¼–è¯‘ç»“æœ
        run: |
          echo "ç¼–è¯‘è¾“å‡ºæ–‡ä»¶:"
          find build/classes -type f | head -20
          echo "æ€»æ–‡ä»¶æ•°:"
          find build/classes -type f | wc -l

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (Linux)
        run: |
          mkdir -p jre-linux
          curl -L -o jre-linux.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.08-linux-x64.zip
          unzip -q jre-linux.zip -d jre-linux
          JRE_NAME=$(ls jre-linux | head -1)
          mv jre-linux/$JRE_NAME jre-linux/jre
          chmod +x jre-linux/jre/bin/java
          rm jre-linux.zip
          echo "Linux JRE ä¸‹è½½å®Œæˆ"

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (Windows)
        run: |
          mkdir -p jre-win
          curl -L -o jre-win.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.08-win-x64.zip
          unzip -q jre-win.zip -d jre-win
          JRE_NAME=$(ls jre-win | head -1)
          mv jre-win/$JRE_NAME jre-win/jre
          rm jre-win.zip
          echo "Windows JRE ä¸‹è½½å®Œæˆ"

      # - name: ä¸‹è½½ç²¾ç®€ç‰ˆ JRE (macOS)
      #   run: |
      #     mkdir -p jre-mac
      #     curl -L -o jre-mac.zip https://github.com/IIIIIllllIIIIIlllll/Mini-JRE/releases/download/v1.0.0/mini-jre-21.06-mac-x64.zip
      #     unzip -q jre-mac.zip -d jre-mac
      #     JRE_NAME=$(ls jre-mac | head -1)
      #     mv jre-mac/$JRE_NAME jre-mac/jre
      #     chmod +x jre-mac/jre/bin/java
      #     rm jre-mac.zip
      #     echo "macOS JRE ä¸‹è½½å®Œæˆ"

      - name: åˆ›å»ºå¯åŠ¨è„šæœ¬ (Linux/Mac)
        run: |
          cat > build/run.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          chmod +x ./jre/bin/java
          ./jre/bin/java -Xms64m -Xmx64m -classpath "./classes:./lib/*" org.mark.llamacpp.server.LlamaServer "$@"
          EOF
          chmod +x build/run.sh

      - name: åˆ›å»ºå¯åŠ¨è„šæœ¬ (Windows)
        run: |
          cat > build/run.bat << 'EOF'
          @echo off
          cd /d "%~dp0"
          start "" jre\bin\javaw.exe -Xms64m -Xmx64m -classpath "./classes;./lib/*" org.mark.llamacpp.server.LlamaServer %*

          EOF

      - name: å¤åˆ¶ README åˆ° build ç›®å½•
        run: |
          if [ -f README.md ]; then
            cp README.md build/
          fi

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: è·å– llama.cpp æœ€æ–°ç‰ˆæœ¬å·
        id: get_llamacpp_version
        run: |
          echo "æ­£åœ¨è·å– llama.cpp æœ€æ–°ç‰ˆæœ¬å·..."
          LLAMACPP_VERSION=$(curl -s https://api.github.com/repos/ggml-org/llama.cpp/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "llama.cpp æœ€æ–°ç‰ˆæœ¬: $LLAMACPP_VERSION"
          echo "llamacpp_version=$LLAMACPP_VERSION" >> $GITHUB_OUTPUT
          echo "LLAMACPP_VERSION=$LLAMACPP_VERSION" >> $GITHUB_ENV
          mkdir -p build/llamacpp

      - name: ä¸‹è½½ llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ (Windows CUDA12)
        run: |
          echo "ä¸‹è½½ llama.cpp Windows CUDA12 ç‰ˆæœ¬..."
          curl -L -o llama-cuda12.zip https://github.com/ggml-org/llama.cpp/releases/download/${{ steps.get_llamacpp_version.outputs.llamacpp_version }}/llama-${{ steps.get_llamacpp_version.outputs.llamacpp_version }}-bin-win-cuda-12.4-x64.zip
          mkdir win-cuda12
          unzip -q llama-cuda12.zip -d win-cuda12
          rm llama-cuda12.zip
          echo "Windows CUDA12 ç‰ˆæœ¬ä¸‹è½½å®Œæˆ"

      - name: ä¸‹è½½ llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ (Windows Vulkan)
        run: |
          echo "ä¸‹è½½ llama.cpp Windows Vulkan ç‰ˆæœ¬..."
          curl -L -o llama-vulkan.zip https://github.com/ggml-org/llama.cpp/releases/download/${{ steps.get_llamacpp_version.outputs.llamacpp_version }}/llama-${{ steps.get_llamacpp_version.outputs.llamacpp_version }}-bin-win-vulkan-x64.zip
          mkdir win-vulkan
          unzip -q llama-vulkan.zip -d win-vulkan
          rm llama-vulkan.zip
          echo "Windows Vulkan ç‰ˆæœ¬ä¸‹è½½å®Œæˆ"

      - name: ä¸‹è½½ llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ (Windows HIP)
        run: |
          echo "ä¸‹è½½ llama.cpp Windows HIP ç‰ˆæœ¬..."
          curl -L -o llama-hip.zip https://github.com/ggml-org/llama.cpp/releases/download/${{ steps.get_llamacpp_version.outputs.llamacpp_version }}/llama-${{ steps.get_llamacpp_version.outputs.llamacpp_version }}-bin-win-hip-radeon-x64.zip
          mkdir win-hip
          unzip -q llama-hip.zip -d win-hip
          rm llama-hip.zip
          echo "Windows HIP ç‰ˆæœ¬ä¸‹è½½å®Œæˆ"

      - name: ä¸‹è½½ llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ (Ubuntu Vulkan)
        run: |
          echo "ä¸‹è½½ llama.cpp Ubuntu Vulkan ç‰ˆæœ¬..."
          curl -L -o llama-ubuntu-vulkan.tar.gz https://github.com/ggml-org/llama.cpp/releases/download/${{ steps.get_llamacpp_version.outputs.llamacpp_version }}/llama-${{ steps.get_llamacpp_version.outputs.llamacpp_version }}-bin-ubuntu-vulkan-x64.tar.gz
          mkdir ubuntu-vulkan
          tar -xzf llama-ubuntu-vulkan.tar.gz -C ubuntu-vulkan
          rm llama-ubuntu-vulkan.tar.gz
          echo "Ubuntu Vulkan ç‰ˆæœ¬ä¸‹è½½å®Œæˆ"

      # - name: ä¸‹è½½ llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ (macOS ARM64)
      #   run: |
      #     echo "ä¸‹è½½ llama.cpp macOS ARM64 ç‰ˆæœ¬..."
      #     curl -L -o llama-macos-arm64.tar.gz https://github.com/ggml-org/llama.cpp/releases/download/${{ steps.get_llamacpp_version.outputs.llamacpp_version }}/llama-${{ steps.get_llamacpp_version.outputs.llamacpp_version }}-bin-macos-arm64.tar.gz
      #     mkdir macos-arm64
      #     tar -xzf llama-macos-arm64.tar.gz -C macos-arm64
      #     rm llama-macos-arm64.tar.gz
      #     echo "macOS ARM64 ç‰ˆæœ¬ä¸‹è½½å®Œæˆ"

      - name: æ‰“åŒ… Linux Vulkan ç‰ˆæœ¬
        run: |
          cp -r build build-linux-vulkan
          cp -r jre-linux/jre build-linux-vulkan/jre
          mkdir -p build-linux-vulkan/llamacpp
          cp -r ubuntu-vulkan build-linux-vulkan/llamacpp/
          mv build-linux-vulkan llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan
          zip -r llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan.zip llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan

      - name: æ‰“åŒ… Windows CUDA12 ç‰ˆæœ¬
        run: |
          cp -r build build-win-cuda12
          cp -r jre-win/jre build-win-cuda12/jre
          mkdir -p build-win-cuda12/llamacpp
          cp -r win-cuda12 build-win-cuda12/llamacpp/
          mv build-win-cuda12 llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12
          zip -r llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12.zip llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12

      - name: æ‰“åŒ… Windows Vulkan ç‰ˆæœ¬
        run: |
          cp -r build build-win-vulkan
          cp -r jre-win/jre build-win-vulkan/jre
          mkdir -p build-win-vulkan/llamacpp
          cp -r win-vulkan build-win-vulkan/llamacpp/
          mv build-win-vulkan llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan
          zip -r llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan.zip llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan

      - name: æ‰“åŒ… Windows HIP ç‰ˆæœ¬
        run: |
          cp -r build build-win-hip
          cp -r jre-win/jre build-win-hip/jre
          mkdir -p build-win-hip/llamacpp
          cp -r win-hip build-win-hip/llamacpp/
          mv build-win-hip llama-server-${{ steps.get_version.outputs.version }}-windows-hip
          zip -r llama-server-${{ steps.get_version.outputs.version }}-windows-hip.zip llama-server-${{ steps.get_version.outputs.version }}-windows-hip

      # - name: æ‰“åŒ… macOS ARM64 ç‰ˆæœ¬
      #   run: |
      #     cp -r build build-mac-arm64
      #     cp -r jre-mac/jre build-mac-arm64/jre
      #     mkdir -p build-mac-arm64/llamacpp
      #     cp -r macos-arm64 build-mac-arm64/llamacpp/
      #     mv build-mac-arm64 llama-server-${{ steps.get_version.outputs.version }}-macos-arm64
      #     zip -r llama-server-${{ steps.get_version.outputs.version }}-macos-arm64.zip llama-server-${{ steps.get_version.outputs.version }}-macos-arm64

      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # è·å–æœ€æ–°çš„ commit ä¿¡æ¯
          LATEST_COMMIT=$(git log -1 --pretty=format:"%h - %s (%an, %ar)")
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%B")
          
          # è·å–è‡ªä¸Šä¸€ä¸ª tag ä»¥æ¥çš„æ‰€æœ‰ commit
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            COMMITS_SINCE_TAG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS_SINCE_TAG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi
          
          # ç”Ÿæˆ release notes
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Release Notes
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - ç¼–è¯‘åçš„ class æ–‡ä»¶
          - æ‰€æœ‰ä¾èµ–åº“ï¼ˆlib/*.jarï¼‰
          - ç²¾ç®€ç‰ˆ JRE 21.08ï¼ˆå†…ç½®ï¼Œæ— éœ€å®‰è£… Javaï¼‰
          - å¯åŠ¨è„šæœ¬ï¼ˆrun.sh / run.batï¼‰
          - llama.cpp é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼ˆ$LLAMACPP_VERSIONï¼‰
          
          ### ğŸ“¦ å¯ç”¨ç‰ˆæœ¬
          
          **Linux:**
          - `llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan.zip` - Ubuntu Vulkan ç‰ˆæœ¬
          
          **Windows:**
          - `llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12.zip` - CUDA 12.4 ç‰ˆæœ¬ï¼ˆNVIDIA GPUï¼‰
          - `llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan.zip` - Vulkan ç‰ˆæœ¬ï¼ˆé€šç”¨ GPUï¼‰
          - `llama-server-${{ steps.get_version.outputs.version }}-windows-hip.zip` - HIP ç‰ˆæœ¬ï¼ˆAMD GPUï¼‰
          
          ### ğŸ“ ä½¿ç”¨æ–¹æ³•
          
          **Linux:**
          ```bash
          unzip llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan.zip
          cd llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan
          chmod +x run.sh
          chmod +x jre/bin/java
          ./run.sh
          ```
          
          **Windows:**
          ```cmd
          REM é€‰æ‹©é€‚åˆä½  GPU çš„ç‰ˆæœ¬
          unzip llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12.zip
          cd llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12
          run.bat
          ```
          
          **æ³¨æ„ï¼š**
          - æœ¬ç‰ˆæœ¬å·²å†…ç½®ç²¾ç®€ç‰ˆ JREï¼Œæ— éœ€é¢å¤–å®‰è£… Java ç¯å¢ƒã€‚
          - è¯·æ ¹æ®ä½ çš„ GPU é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ï¼š
            - NVIDIA GPU: ä½¿ç”¨ cuda12 ç‰ˆæœ¬
            - AMD GPU: ä½¿ç”¨ hip ç‰ˆæœ¬
            - å…¶ä»– GPUï¼ˆå¦‚æ ¸æ˜¾ï¼‰ æˆ–ä¸ç¡®å®š: ä½¿ç”¨ vulkan ç‰ˆæœ¬
          
          ---
          
          ### ğŸ“Œ æœ€æ–°æäº¤
          EOF
          
          echo "$LATEST_COMMIT" >> release_notes.md
          echo "" >> release_notes.md
          
          # æ·»åŠ æäº¤è¯¦æƒ…
          if [ -n "$COMMITS_SINCE_TAG" ]; then
            echo "### ğŸ“‹ è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„å˜æ›´" >> release_notes.md
            echo "" >> release_notes.md
            echo "$COMMITS_SINCE_TAG" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "*æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> release_notes.md
          
          # è¾“å‡ºå†…å®¹ä¾›è°ƒè¯•
          echo "ç”Ÿæˆçš„ Release Notes:"
          cat release_notes.md
          
          # ä¿å­˜ä¸º artifact
          echo "NOTES_CONTENT<<EOF" >> $GITHUB_ENV
          cat release_notes.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: åˆ›å»º Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan.zip
            llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12.zip
            llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan.zip
            llama-server-${{ steps.get_version.outputs.version }}-windows-hip.zip
            # llama-server-${{ steps.get_version.outputs.version }}-macos-arm64.zip
          body: ${{ env.NOTES_CONTENT }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Linux Vulkan)
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan
          path: llama-server-${{ steps.get_version.outputs.version }}-linux-vulkan.zip
          retention-days: 30

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Windows CUDA12)
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12
          path: llama-server-${{ steps.get_version.outputs.version }}-windows-cuda12.zip
          retention-days: 30

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Windows Vulkan)
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan
          path: llama-server-${{ steps.get_version.outputs.version }}-windows-vulkan.zip
          retention-days: 30

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Windows HIP)
        uses: actions/upload-artifact@v4
        with:
          name: llama-server-${{ steps.get_version.outputs.version }}-windows-hip
          path: llama-server-${{ steps.get_version.outputs.version }}-windows-hip.zip
          retention-days: 30

      # - name: ä¸Šä¼ æ„å»ºäº§ç‰© (macOS ARM64)
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: llama-server-${{ steps.get_version.outputs.version }}-macos-arm64
      #     path: llama-server-${{ steps.get_version.outputs.version }}-macos-arm64.zip
      #     retention-days: 30
