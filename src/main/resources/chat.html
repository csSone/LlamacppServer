<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama.cpp 简易聊天</title>
    
    <!-- External Libraries -->
    <script src="js/marked.min.js"></script>
    <link rel="stylesheet" href="css/github.min.css">
    <script src="js/highlight.min.js"></script>
    <link rel="stylesheet" href="css/all.min.css">
    <link href="css/css2.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --bg-color: #f9fafb; /* Gray 50 */
            --sidebar-bg: #ffffff;
            --border-color: #e5e7eb; /* Gray 200 */
            --text-primary: #111827; /* Gray 900 */
            --text-secondary: #6b7280; /* Gray 500 */
            --user-msg-bg: #eff6ff; /* Blue 50 */
            --ai-msg-bg: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.75rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 20;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            height: 64px;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-header h1 i {
            font-size: 1.5rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .setting-group label span {
            color: var(--text-secondary);
            font-size: 0.75rem;
            float: right;
        }

        .form-select, .form-input, .form-textarea {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: #fff;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-range {
            flex: 1;
            accent-color: var(--primary-color);
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-outline {
            background-color: transparent;
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background-color: #f3f4f6;
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-secondary);
        }
        
        .btn-ghost:hover {
            background-color: #f3f4f6;
            color: var(--text-primary);
        }
        
        .btn-danger-ghost {
            color: #ef4444;
        }
        
        .btn-danger-ghost:hover {
            background-color: #fee2e2;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
        }

        /* Main Chat Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #ffffff;
        }

        .chat-header {
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .model-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background-color: #e0e7ff;
            color: var(--primary-color);
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }

        .welcome-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            opacity: 0.2;
        }

        .message-wrapper {
            display: flex;
            gap: 1rem;
            max-width: 48rem;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .avatar-user {
            background-color: #eff6ff;
            color: var(--primary-color);
        }

        .avatar-ai {
            background-color: #10b981;
            color: white;
        }
        
        .avatar-system {
            background-color: #f3f4f6;
            color: var(--text-secondary);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .message-bubble {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .message-bubble p {
            margin-bottom: 0.75rem;
        }
        
        .message-bubble p:last-child {
            margin-bottom: 0;
        }
        
        /* Markdown Styling */
        .message-bubble pre {
            background-color: #1e293b; /* Slate 800 */
            color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.75rem 0;
        }
        
        .message-bubble code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            background-color: #f1f5f9;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            color: #0f172a;
        }
        
        .message-bubble pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
            font-size: 0.9em;
        }
        
        .message-bubble blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 1rem;
            color: var(--text-secondary);
            margin: 0.75rem 0;
        }
        
        .message-bubble img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            cursor: zoom-in;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-wrapper:hover .message-actions {
            opacity: 1;
        }

        .message-stats {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Input Area */
        .input-area {
            padding: 1.5rem;
            background-color: #fff;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-container {
            max-width: 48rem;
            margin: 0 auto;
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            background-color: #fff;
            transition: box-shadow 0.2s;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .input-attachments {
            display: flex;
            padding: 0.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .attachment-preview {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .attachment-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .attachment-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            border: none;
        }

        .input-container:focus-within {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            width: 100%;
            position: relative;
        }

        #message-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem; /* Right padding for button */
            border: none;
            border-radius: 1rem;
            resize: none;
            max-height: 200px;
            min-height: 56px;
            outline: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.5;
            background: transparent;
        }

        .upload-btn {
            padding: 0.75rem;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-btn:hover {
            color: var(--primary-color);
        }

        .send-btn {
            margin: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .send-btn:disabled {
            background-color: var(--border-color);
            cursor: default;
        }

        .send-btn:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }

        .stop-btn {
            position: absolute;
            top: -3rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            z-index: 5;
            display: none;
        }
        
        .stop-btn.active {
            display: flex;
        }

        .input-info {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            max-width: 48rem;
            margin: 0 auto;
            width: 100%;
        }

        /* Mobile Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox-img {
            max-width: 90%;
            max-height: 85vh;
            object-fit: contain;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .lightbox-close:hover {
            color: #bbb;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -300px;
                height: 100%;
                box-shadow: var(--shadow-md);
            }
            
            .sidebar.active {
                transform: translateX(300px);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .message-wrapper {
                padding: 0 1rem;
            }
            
            .input-container {
                border-radius: 0.5rem;
            }
        }
        
        /* Typing Indicator */
        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 6px 0;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
            opacity: 0.6;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.5); opacity: 1; }
        }
        
        /* Edit Mode */
        .edit-textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            border: 1px solid var(--primary-color);
            border-radius: 0.5rem;
            font-family: inherit;
            margin-bottom: 0.5rem;
            resize: vertical;
        }
        
        .edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-robot"></i> Llama Chat</h1>
            <button class="btn-ghost" id="close-sidebar-btn" style="margin-left: auto; display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="setting-group">
                <label for="model-selector">模型选择</label>
                <select id="model-selector" class="form-select">
                    <option value="" disabled selected>加载中...</option>
                </select>
            </div>

            <div class="setting-group">
                <label for="system-prompt">系统提示词 (System Prompt)</label>
                <textarea id="system-prompt" class="form-textarea" rows="4" placeholder="设定AI的角色和行为...">You are a helpful, respectful and honest assistant.</textarea>
            </div>

            <div class="setting-group">
                <label for="temp-input">温度 (Temperature) <span id="temp-val">0.7</span></label>
                <div class="range-container">
                    <input type="range" id="temp-input" class="form-range" min="0" max="2" step="0.1" value="0.7">
                </div>
            </div>

            <div class="setting-group">
                <label for="top-p-input">Top P <span id="top-p-val">0.9</span></label>
                <div class="range-container">
                    <input type="range" id="top-p-input" class="form-range" min="0" max="1" step="0.05" value="0.9">
                </div>
            </div>
            
            <div class="setting-group">
                <label for="max-tokens-input">最大Token数 <span id="max-tokens-val">Default</span></label>
                <input type="number" id="max-tokens-input" class="form-input" placeholder="-1 (无限)" value="-1">
            </div>
            
             <div class="setting-group">
                <label for="n-predict">生成数量 (N) <span id="n-predict-val">1</span></label>
                 <div class="range-container">
                    <input type="range" id="n-predict" class="form-range" min="1" max="5" step="1" value="1">
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-outline" style="width: 100%;" onclick="resetSettings()">
                    <i class="fas fa-undo"></i> 重置默认设置
                </button>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="btn btn-outline" style="width: 100%;" onclick="window.location.href='/'">
                <i class="fas fa-home"></i> 返回管理后台
            </button>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="main-area">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="model-badge" id="current-model-badge">
                    <i class="fas fa-cube" style="margin-right: 6px;"></i>
                    <span id="current-model-name">未选择模型</span>
                </div>
            </div>
            <button class="btn btn-ghost btn-danger-ghost" onclick="clearChat()" title="清空对话">
                <i class="fas fa-trash-alt"></i>
                <span style="display: none; margin-left: 5px;" class="desktop-only">清空</span>
            </button>
        </div>

        <div id="chat-container" class="chat-container">
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h2>欢迎使用 Llama Server Chat</h2>
                <p>请在左侧选择一个模型开始对话</p>
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <button class="stop-btn" id="stop-btn">
                    <i class="fas fa-stop"></i> 停止生成
                </button>
                <div id="input-attachments" class="input-attachments" style="display: none;"></div>
                <div class="input-wrapper">
                    <button class="upload-btn" onclick="document.getElementById('file-input').click()" title="上传图片">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                    <textarea id="message-input" placeholder="发送消息... (Shift+Enter 换行)" rows="1" disabled></textarea>
                    <button class="send-btn" id="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <div class="input-info">
                Llama.cpp Server AI 生成的内容可能不准确，请核实重要信息。
            </div>
        </div>
    </main>
    
    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-img" id="lightbox-img">
    </div>

    <script>
        // State
        const state = {
            currentModel: '',
            messages: [], // Array of {role, content (string or array), id}
            isGenerating: false,
            controller: null,
            attachments: [] // Array of {file, previewUrl, base64}
        };

        // DOM Elements
        const els = {
            modelSelector: document.getElementById('model-selector'),
            chatContainer: document.getElementById('chat-container'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            stopBtn: document.getElementById('stop-btn'),
            welcomeScreen: document.getElementById('welcome-screen'),
            modelBadgeName: document.getElementById('current-model-name'),
            sidebar: document.getElementById('sidebar'),
            menuToggle: document.getElementById('menu-toggle'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            fileInput: document.getElementById('file-input'),
            inputAttachments: document.getElementById('input-attachments'),
            lightbox: document.getElementById('lightbox'),
            lightboxImg: document.getElementById('lightbox-img'),
            // Settings
            systemPrompt: document.getElementById('system-prompt'),
            tempInput: document.getElementById('temp-input'),
            tempVal: document.getElementById('temp-val'),
            topPInput: document.getElementById('top-p-input'),
            topPVal: document.getElementById('top-p-val'),
            maxTokensInput: document.getElementById('max-tokens-input'),
            nPredict: document.getElementById('n-predict'),
            nPredictVal: document.getElementById('n-predict-val')
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadModels();
            setupEventListeners();
            setupAutoResize();
            
            // Initialize marked options
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-'
            });
        });

        // Load Models
        async function loadModels() {
            try {
                const response = await fetch('/v1/models');
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    els.modelSelector.innerHTML = '<option value="" disabled selected>选择一个模型...</option>';
                    data.data.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id; 
                        els.modelSelector.appendChild(option);
                    });
                } else {
                    els.modelSelector.innerHTML = '<option value="" disabled>无可用模型</option>';
                }
            } catch (error) {
                console.error('Error loading models:', error);
                els.modelSelector.innerHTML = '<option value="" disabled>加载失败</option>';
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Model Change
            els.modelSelector.addEventListener('change', (e) => {
                state.currentModel = e.target.value;
                els.modelBadgeName.textContent = state.currentModel;
                els.messageInput.disabled = false;
                els.sendBtn.disabled = false;
                els.welcomeScreen.style.display = 'none';
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    els.sidebar.classList.remove('active');
                }
            });

            // Input Handling
            els.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            els.sendBtn.addEventListener('click', sendMessage);
            
            // Stop Generation
            els.stopBtn.addEventListener('click', stopGeneration);
            
            // File Upload
            els.fileInput.addEventListener('change', handleFileUpload);

            // Sidebar Toggles
            els.menuToggle.addEventListener('click', () => {
                els.sidebar.classList.add('active');
                els.closeSidebarBtn.style.display = 'block';
            });
            
            els.closeSidebarBtn.addEventListener('click', () => {
                els.sidebar.classList.remove('active');
                els.closeSidebarBtn.style.display = 'none';
            });

            // Settings Sliders
            els.tempInput.addEventListener('input', (e) => els.tempVal.textContent = e.target.value);
            els.topPInput.addEventListener('input', (e) => els.topPVal.textContent = e.target.value);
            els.nPredict.addEventListener('input', (e) => els.nPredictVal.textContent = e.target.value);
        }

        // Auto Resize Textarea
        function setupAutoResize() {
            els.messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if (this.value === '') {
                    this.style.height = '56px'; // Default height
                }
            });
        }
        
        // File Handling
        function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const base64 = ev.target.result;
                    state.attachments.push({
                        file,
                        previewUrl: base64,
                        base64: base64
                    });
                    renderAttachments();
                };
                reader.readAsDataURL(file);
            });
            
            // Reset input
            els.fileInput.value = '';
        }
        
        function renderAttachments() {
            if (state.attachments.length === 0) {
                els.inputAttachments.style.display = 'none';
                els.inputAttachments.innerHTML = '';
                return;
            }
            
            els.inputAttachments.style.display = 'flex';
            els.inputAttachments.innerHTML = '';
            
            state.attachments.forEach((att, index) => {
                const div = document.createElement('div');
                div.className = 'attachment-preview';
                div.innerHTML = `
                    <img src="${att.previewUrl}" alt="preview">
                    <button class="attachment-remove" onclick="removeAttachment(${index})">&times;</button>
                `;
                els.inputAttachments.appendChild(div);
            });
        }
        
        window.removeAttachment = function(index) {
            state.attachments.splice(index, 1);
            renderAttachments();
        };

        // Core Functions
        async function sendMessage() {
            const text = els.messageInput.value.trim();
            const hasAttachments = state.attachments.length > 0;
            
            if ((!text && !hasAttachments) || !state.currentModel || state.isGenerating) return;

            // Construct Content
            let content;
            if (!hasAttachments) {
                content = text;
            } else {
                content = [];
                if (text) {
                    content.push({ type: 'text', text: text });
                }
                state.attachments.forEach(att => {
                    content.push({
                        type: 'image_url',
                        image_url: { url: att.base64 }
                    });
                });
            }
            
            const msgId = Date.now().toString();

            // User Message
            appendMessage('user', content, msgId);
            state.messages.push({ role: 'user', content: content, id: msgId });
            
            // Clear Input
            els.messageInput.value = '';
            els.messageInput.style.height = '56px';
            state.attachments = [];
            renderAttachments();
            els.sendBtn.disabled = true;
            
            await generateResponse();
        }

        async function generateResponse() {
            state.isGenerating = true;
            state.controller = new AbortController();
            els.stopBtn.classList.add('active');
            
            const n = parseInt(els.nPredict.value) || 1;
            const currentAssistants = [];
            
            // Prepare placeholder(s)
            for(let i = 0; i < n; i++) {
                const { id, contentEl, bubbleEl } = appendMessage('assistant', '', 'temp-' + Date.now() + i);
                currentAssistants.push({
                    id, 
                    contentEl, 
                    bubbleEl,
                    text: '',
                    typing: true,
                    startTime: null
                });
                // Show typing indicator initially
                contentEl.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
            }

            // Prepare API payload
            const systemMsg = els.systemPrompt.value.trim();
            const apiMessages = [];
            if (systemMsg) {
                apiMessages.push({ role: 'system', content: systemMsg });
            }
            // Filter messages to remove UI-only fields if any
            apiMessages.push(...state.messages.map(m => ({
                role: m.role,
                content: m.content
            })));

            try {
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: state.currentModel,
                        messages: apiMessages,
                        stream: true,
                        n: n,
                        temperature: parseFloat(els.tempInput.value),
                        top_p: parseFloat(els.topPInput.value),
                        max_tokens: parseInt(els.maxTokensInput.value) > 0 ? parseInt(els.maxTokensInput.value) : undefined
                    }),
                    signal: state.controller.signal
                });

                if (!response.ok) throw new Error(`Server Error: ${response.statusText}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6);
                            if (dataStr.trim() === '[DONE]') continue;

                            try {
                                const data = JSON.parse(dataStr);
                                if (data.choices && data.choices.length > 0) {
                                    const choice = data.choices[0];
                                    const index = choice.index || 0;
                                    const delta = choice.delta.content || '';

                                    if (index < currentAssistants.length) {
                                        const asst = currentAssistants[index];
                                        if (asst.typing) {
                                            asst.typing = false;
                                            asst.contentEl.innerHTML = ''; // Remove typing dots
                                        }
                                        if (asst.startTime === null && delta) {
                                            asst.startTime = performance.now();
                                        }
                                        asst.text += delta;
                                        asst.contentEl.innerHTML = marked.parse(asst.text);
                                        // We could syntax highlight here, but better to do it less frequently or at end
                                        scrollToBottom();
                                    }
                                }
                            } catch (e) {
                                console.warn('Parse error', e);
                            }
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // User stopped
                    currentAssistants.forEach(asst => {
                        if (asst.text === '') asst.contentEl.innerHTML = '<em>生成已停止</em>';
                    });
                } else {
                    currentAssistants.forEach(asst => {
                        asst.contentEl.innerHTML += `<br><span style="color:red">Error: ${error.message}</span>`;
                    });
                }
            } finally {
                state.isGenerating = false;
                state.controller = null;
                els.stopBtn.classList.remove('active');
                els.sendBtn.disabled = false;
                els.messageInput.focus();

                // Finalize messages
                currentAssistants.forEach(asst => {
                    if (asst.typing) { // If it never got content
                         asst.contentEl.innerHTML = '';
                    }
                    // Apply highlight
                    asst.contentEl.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    
                    // Add to history and update ID
                    const finalId = Date.now().toString() + Math.random();
                    state.messages.push({ role: 'assistant', content: asst.text, id: finalId });
                    
                    // Update UI ID to match history
                    asst.contentEl.id = 'msg-' + finalId;
                    if (asst.contentEl.parentElement && asst.contentEl.parentElement.parentElement) {
                        asst.contentEl.parentElement.parentElement.dataset.id = finalId;
                    }
                    // Find the wrapper that contains this bubble
                    // Re-render actions with correct ID
                    const actionsHtml = getMessageActionsHtml('assistant', finalId);
                    // Append actions
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'message-actions';
                    actionsDiv.innerHTML = actionsHtml;
                    
                    // wrapper is parent of message-content, which is parent of bubble
                    asst.contentEl.parentElement.appendChild(actionsDiv);

                    const endTime = performance.now();
                    if (asst.startTime) {
                        const tokens = estimateTokens(asst.text);
                        const durationSec = Math.max(0.001, (endTime - asst.startTime) / 1000);
                        const speed = tokens / durationSec;
                        const statsDiv = document.createElement('div');
                        statsDiv.className = 'message-stats';
                        statsDiv.textContent = `速度: ${speed.toFixed(2)} token/s · 总计: ${tokens} · 用时: ${durationSec.toFixed(2)}s`;
                        asst.contentEl.parentElement.appendChild(statsDiv);
                    }
                });
                
                scrollToBottom();
            }
        }

        function stopGeneration() {
            if (state.controller) {
                state.controller.abort();
            }
        }

        function appendMessage(role, content, id = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            wrapper.dataset.id = id; // Temporary ID
            
            let avatarHtml = '';
            let senderName = '';
            let avatarClass = '';
            
            if (role === 'user') {
                senderName = 'You';
                avatarClass = 'avatar-user';
                avatarHtml = '<i class="fas fa-user"></i>';
            } else if (role === 'assistant') {
                senderName = 'AI';
                avatarClass = 'avatar-ai';
                avatarHtml = '<i class="fas fa-robot"></i>';
            } else {
                senderName = 'System';
                avatarClass = 'avatar-system';
                avatarHtml = '<i class="fas fa-cog"></i>';
            }

            // Render Content
            let contentHtml = '';
            if (role === 'assistant') {
                contentHtml = typeof content === 'string' ? marked.parse(content) : '';
            } else {
                // User content rendering
                if (typeof content === 'string') {
                    contentHtml = content.replace(/\\n/g, '<br>');
                } else if (Array.isArray(content)) {
                    content.forEach(part => {
                        if (part.type === 'text') {
                            contentHtml += `<p>${part.text.replace(/\\n/g, '<br>')}</p>`;
                        } else if (part.type === 'image_url') {
                            contentHtml += `<img src="${part.image_url.url}" onclick="openLightbox(this.src)">`;
                        }
                    });
                }
            }

            wrapper.innerHTML = `
                <div class="message-avatar ${avatarClass}">
                    ${avatarHtml}
                </div>
                <div class="message-content">
                    <div class="message-sender">${senderName}</div>
                    <div class="message-bubble" id="msg-${id}">
                        ${contentHtml}
                    </div>
                    ${role !== 'system' && id && !id.startsWith('temp-') ? `
                    <div class="message-actions">
                        ${getMessageActionsHtml(role, id)}
                    </div>` : ''}
                </div>
            `;
            
            els.chatContainer.appendChild(wrapper);
            scrollToBottom();
            
            // Highlight if ready
            if (role === 'assistant' && content) {
                 wrapper.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
            
            return {
                id,
                contentEl: wrapper.querySelector('.message-bubble'),
                bubbleEl: wrapper
            };
        }
        
        function getMessageActionsHtml(role, id) {
            let html = `
                <button class="btn-ghost btn-sm" onclick="copyMessage('${id}')" title="复制">
                    <i class="fas fa-copy"></i>
                </button>
            `;
            
            if (role === 'user') {
                html += `
                    <button class="btn-ghost btn-sm" onclick="editMessage('${id}')" title="编辑">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                try {
                    const idx = state.messages.findIndex(m => m.id === id);
                    const hasAssistantAfter = idx === -1
                        ? state.messages.some(m => m.role === 'assistant')
                        : state.messages.slice(idx + 1).some(m => m.role === 'assistant');
                    if (!hasAssistantAfter) {
                        html += `
                            <button class="btn-ghost btn-sm" onclick="regenerateFromUser('${id}')" title="重新生成">
                                <i class="fas fa-redo"></i>
                            </button>
                        `;
                    }
                } catch (e) {}
                html += `
                    <button class="btn-ghost btn-sm btn-danger-ghost" onclick="deleteMessage('${id}')" title="删除">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else if (role === 'assistant') {
                 html += `
                    <button class="btn-ghost btn-sm" onclick="regenerateMessage('${id}')" title="重新生成">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn-ghost btn-sm" onclick="editMessage('${id}')" title="编辑">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-ghost btn-sm btn-danger-ghost" onclick="deleteMessage('${id}')" title="删除">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }
            
            return html;
        }

        function scrollToBottom() {
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
        }

        function clearChat() {
            if (confirm('确定要清空所有对话吗？')) {
                state.messages = [];
                els.chatContainer.innerHTML = '';
                // Restore welcome screen
                els.chatContainer.appendChild(els.welcomeScreen);
                els.welcomeScreen.style.display = 'flex';
            }
        }
        
        function deleteMessage(id) {
            if (!confirm('确定要删除这条消息吗？')) return;
            
            const index = state.messages.findIndex(m => m.id === id);
            if (index !== -1) {
                // Remove from DOM using ID lookup
                // We didn't set ID on wrapper in appendMessage update, let's fix logic or rely on reload
                // Ideally we re-render chat or remove specific element
                // Let's re-render to keep state sync easy
                state.messages.splice(index, 1);
                rerenderChat();
            }
        }
        
        function editMessage(id) {
            const index = state.messages.findIndex(m => m.id === id);
            if (index === -1) return;
            const msg = state.messages[index];
            const bubble = document.getElementById('msg-' + id);
            if (!bubble || bubble.dataset.editing === 'true') return;
            let textContent = '';
            if (typeof msg.content === 'string') {
                textContent = msg.content;
            } else if (Array.isArray(msg.content)) {
                const textParts = msg.content.filter(p => p.type === 'text');
                textContent = textParts.map(p => p.text).join('\n');
            }
            bubble.dataset.editing = 'true';
            const actions = bubble.parentElement.querySelector('.message-actions');
            if (actions) actions.style.display = 'none';
            bubble.innerHTML = `
                <textarea class="edit-textarea" id="edit-${id}" placeholder="在此编辑文本...">${textContent.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                <div class="edit-actions">
                    <button class="btn-ghost btn-sm" onclick="saveInlineEdit('${id}')"><i class="fas fa-check"></i> 保存</button>
                    <button class="btn-ghost btn-sm" onclick="cancelInlineEdit('${id}')"><i class="fas fa-times"></i> 取消</button>
                </div>
            `;
            const ta = document.getElementById('edit-' + id);
            if (ta) {
                ta.focus();
                ta.selectionStart = ta.value.length;
            }
        }

        function cancelInlineEdit(id) {
            const index = state.messages.findIndex(m => m.id === id);
            if (index === -1) return;
            const msg = state.messages[index];
            const bubble = document.getElementById('msg-' + id);
            if (!bubble) return;
            let html = '';
            if (msg.role === 'assistant') {
                html = typeof msg.content === 'string' ? marked.parse(msg.content) : '';
            } else {
                if (typeof msg.content === 'string') {
                    html = msg.content.replace(/\n/g, '<br>');
                } else if (Array.isArray(msg.content)) {
                    msg.content.forEach(part => {
                        if (part.type === 'text') {
                            html += `<p>${part.text.replace(/\n/g, '<br>')}</p>`;
                        } else if (part.type === 'image_url') {
                            html += `<img src="${part.image_url.url}" onclick="openLightbox(this.src)">`;
                        }
                    });
                }
            }
            bubble.innerHTML = html;
            if (msg.role === 'assistant') {
                bubble.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            }
            bubble.dataset.editing = '';
            const actions = bubble.parentElement.querySelector('.message-actions');
            if (actions) actions.style.display = '';
        }

        function saveInlineEdit(id) {
            const index = state.messages.findIndex(m => m.id === id);
            if (index === -1) return;
            const msg = state.messages[index];
            const bubble = document.getElementById('msg-' + id);
            if (!bubble) return;
            const ta = document.getElementById('edit-' + id);
            const newText = (ta ? ta.value : '').trim();
            if (msg.role === 'assistant') {
                state.messages[index].content = newText;
                bubble.innerHTML = marked.parse(newText);
                bubble.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            } else {
                if (typeof msg.content === 'string') {
                    state.messages[index].content = newText;
                    bubble.innerHTML = newText.replace(/\n/g, '<br>');
                } else if (Array.isArray(msg.content)) {
                    const newContent = [];
                    let replaced = false;
                    msg.content.forEach(part => {
                        if (part.type === 'text' && !replaced) {
                            newContent.push({ type: 'text', text: newText });
                            replaced = true;
                        } else if (part.type === 'image_url') {
                            newContent.push(part);
                        }
                    });
                    if (!replaced) newContent.unshift({ type: 'text', text: newText });
                    state.messages[index].content = newContent;
                    let html = '';
                    newContent.forEach(part => {
                        if (part.type === 'text') {
                            html += `<p>${part.text.replace(/\n/g, '<br>')}</p>`;
                        } else if (part.type === 'image_url') {
                            html += `<img src="${part.image_url.url}" onclick="openLightbox(this.src)">`;
                        }
                    });
                    bubble.innerHTML = html;
                }
            }
            bubble.dataset.editing = '';
            const actions = bubble.parentElement.querySelector('.message-actions');
            if (actions) actions.style.display = '';
        }
        
        async function regenerateMessage(id) {
            const index = state.messages.findIndex(m => m.id === id);
            if (index === -1) return;
            
            if (confirm('确定要重新生成这条回复吗？')) {
                // Keep messages up to the user message before this assistant message
                // Assumes structure User -> Assistant
                // If we delete this assistant message, we want to regenerate response for the previous user message
                
                state.messages = state.messages.slice(0, index);
                rerenderChat();
                await generateResponse();
            }
        }

        async function regenerateFromUser(id) {
            if (state.isGenerating) return;
            const idx = state.messages.findIndex(m => m.id === id);
            if (idx !== -1) {
                const hasAssistantAfter = state.messages.slice(idx + 1).some(m => m.role === 'assistant');
                if (hasAssistantAfter) return;
            } else {
                if (state.messages.some(m => m.role === 'assistant')) return;
            }
            await generateResponse();
        }
        
        function rerenderChat() {
            els.chatContainer.innerHTML = '';
            els.chatContainer.appendChild(els.welcomeScreen);
            if (state.messages.length === 0) {
                els.welcomeScreen.style.display = 'flex';
            } else {
                els.welcomeScreen.style.display = 'none';
                state.messages.forEach(msg => {
                    appendMessage(msg.role, msg.content, msg.id);
                });
            }
        }
        
        window.copyMessage = function(id) {
            const msg = state.messages.find(m => m.id === id);
            if (msg) {
                let text = '';
                 if (typeof msg.content === 'string') {
                    text = msg.content;
                } else if (Array.isArray(msg.content)) {
                    msg.content.forEach(p => {
                        if (p.type === 'text') text += p.text + '\\n';
                    });
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    // Find button icon
                    // This is a bit hacky without unique IDs on buttons, but works for clicked element context
                    const btn = document.activeElement; 
                    if(btn && btn.querySelector('i')) {
                        const i = btn.querySelector('i');
                        const originalClass = i.className;
                        i.className = 'fas fa-check';
                        setTimeout(() => i.className = originalClass, 1000);
                    }
                });
            }
        }
        
        window.openLightbox = function(src) {
            els.lightboxImg.src = src;
            els.lightbox.classList.add('active');
        }
        
        window.closeLightbox = function() {
            els.lightbox.classList.remove('active');
        }

        function resetSettings() {
            els.systemPrompt.value = "You are a helpful, respectful and honest assistant.";
            els.tempInput.value = 0.7; els.tempVal.textContent = 0.7;
            els.topPInput.value = 0.9; els.topPVal.textContent = 0.9;
            els.maxTokensInput.value = -1;
            els.nPredict.value = 1; els.nPredictVal.textContent = 1;
        }

        function estimateTokens(text) {
            if (!text) return 0;
            let ascii = 0, nonAscii = 0;
            for (let i = 0; i < text.length; i++) {
                const code = text.charCodeAt(i);
                if (code <= 127) ascii++; else nonAscii++;
            }
            const asciiTokens = Math.round(ascii / 4);
            return (asciiTokens > 0 ? asciiTokens : 1) + nonAscii;
        }
    </script>
</body>
</html>
