<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Easy Chat Mobile</title>
  <link rel="stylesheet" href="/css/completion-mobile.css" />
</head>

<body>
  <div class="app">
    <div class="header">
      <div class="chat-title">
        <input id="titleInput" class="title-input" type="text" placeholder="角色名称（自动保存）" />
      </div>
      <button id="sessionsToggle" class="btn icon-btn ghost" type="button" aria-label="角色列表">☰</button>
      <button id="toggleSettings" class="btn icon-btn ghost" type="button" aria-label="设置">⚙</button>
    </div>

    <div id="chatList" class="chat-list"></div>

    <div class="composer">
      <div class="model-row">
        <div class="pill">
          <label for="modelSelect">模型</label>
          <select id="modelSelect"></select>
          <button id="refreshModels" class="btn" type="button">刷新</button>
        </div>
        <div>
        	<button id="kvCacheToggle" class="btn icon-btn ghost" type="button" title="KV缓存管理">💾</button>
        	<button id="mcpToolsToggle" class="btn icon-btn ghost" type="button" title="MCP 工具">🔌</button>
        </div>
        
        <div class="toggle">
          <input id="autoScroll" type="checkbox" checked />
          <label for="autoScroll" class="hint">自动滚动</label>
        </div>
        <div class="toggle">
          <input id="streamToggle" type="checkbox" checked />
          <label for="streamToggle" class="hint">流式传输</label>
        </div>
        <div class="toggle">
          <input id="thinkingToggle" type="checkbox" checked />
          <label for="thinkingToggle" class="hint">开启思考</label>
        </div>
        <div class="toggle">
          <input id="webSearchToggle" type="checkbox" />
          <label for="webSearchToggle" class="hint">联网搜索</label>
        </div>
        <button id="clearChat" class="btn" type="button">清空</button>
        
      </div>

      <div id="settingsPanel" class="settings">
        <div class="settings-head">
          <div class="settings-title">模型与设置</div>
          <button id="closeSettings" class="btn icon-btn" type="button" aria-label="关闭">×</button>
        </div>
        <div class="settings-body">
          <div class="section-title" id="modelSection">核心参数</div>
          <div class="setting avatar-setting">
            <label>头像</label>
            <div class="avatar-row">
              <div id="avatarSettingPreview" class="avatar clickable" title="点击查看头像">AI</div>
              <button id="avatarSettingUpload" class="btn" type="button">更换</button>
            </div>
          </div>
          <div class="setting">
            <label for="apiModelSelect">API 端点</label>
            <select id="apiModelSelect">
              <option value="1">/v1/chat/completions</option>
              <option value="0">/v1/completions</option>
            </select>
          </div>
          <div class="setting">
            <label for="userName">用户名字</label>
            <input id="userName" type="text" placeholder="例如：我" />
          </div>
          <div class="setting">
            <label for="maxTokens">max_tokens</label>
            <input id="maxTokens" type="number" value="512" min="1" max="32768" />
          </div>
          <div class="setting">
            <label for="temperature">temperature</label>
            <input id="temperature" type="number" value="0.7" step="0.1" min="0" max="2" />
          </div>
          <div class="setting">
            <label for="topP">top_p</label>
            <input id="topP" type="number" value="1" step="0.05" min="0" max="1" />
          </div>
          <div class="setting">
            <label for="minP">min_p</label>
            <input id="minP" type="number" step="0.01" min="0" max="1" value="0.05" />
          </div>
          <div class="setting">
            <label for="repeatPenalty">repeat_penalty</label>
            <input id="repeatPenalty" type="number" step="0.05" min="0" max="10" value="1.0" />
          </div>
          <div class="setting">
            <label for="stopSequences">stop</label>
            <textarea id="stopSequences" placeholder="一行一个 stop 序列"></textarea>
          </div>

          <div id="sysPromptBox" class="sys-prompt">
            <div class="sys-title">系统描述</div>
            <textarea id="systemPrompt" placeholder="将加入到对话开头"></textarea>
          </div>
          <div id="rolePromptBox" class="sys-prompt">
            <div class="sys-title">角色设定</div>
            <textarea id="rolePrompt" placeholder="将加入到对话开头"></textarea>
          </div>

          <div class="setting long-setting">
            <label for="userPrefix">用户消息前缀</label>
            <textarea id="userPrefix" placeholder="可选"></textarea>
          </div>
          <div class="setting long-setting">
            <label for="userSuffix">用户消息后缀</label>
            <textarea id="userSuffix" placeholder="可选"></textarea>
          </div>
          <div class="setting long-setting">
            <label for="assistantPrefix">助手消息前缀</label>
            <textarea id="assistantPrefix" placeholder="可选"></textarea>
          </div>
          <div class="setting long-setting">
            <label for="assistantSuffix">助手消息后缀</label>
            <textarea id="assistantSuffix" placeholder="可选"></textarea>
          </div>
        </div>
      </div>

      <div class="prompt-row">
        <div class="prompt-actions">
          <button id="attachBtn" class="btn" type="button">附件</button>
          <button id="modelRowToggle" style="width: 100%; height: 100%" class="btn icon-btn ghost" type="button" title="显示模型栏" aria-label="显示模型栏" aria-expanded="false">☰</button>
        </div>
        <textarea id="promptInput" placeholder="输入消息…（Ctrl+Enter 发送）"></textarea>
        <div class="prompt-actions">
          <button id="sendBtn" class="btn primary" type="button">发送</button>
          <button id="stopBtn" class="btn danger" type="button" disabled>停止</button>
        </div>
        <input id="attachInput" type="file" style="display:none" />
      </div>
      <div class="toolbar">
        <div class="hint" id="saveHint"></div>
        <div id="attachInfo" class="attach-info" aria-live="polite">
          <span class="hint">已选附件</span>
          <span id="attachName" class="name"></span>
          <button id="attachClear" class="btn icon-btn clear" type="button" aria-label="清除附件">×</button>
        </div>
        <div class="spacer"></div>
      </div>
    </div>

    <div id="drawerBackdrop" class="backdrop"></div>
    <div id="modelRowBackdrop" class="backdrop"></div>
    <aside id="sessionsDrawer" class="drawer" aria-hidden="true">
      <div class="drawer-header">
        <div class="drawer-title">角色</div>
        <button id="drawerClose" class="btn icon-btn" type="button" aria-label="关闭">×</button>
      </div>
      <div class="drawer-actions">
        <button id="newSessionBtn" class="btn primary" type="button">新建角色</button>
        <button id="reloadSessionsBtn" class="btn" type="button">刷新</button>
        <span class="hint" id="drawerHint"></span>
      </div>
      <ul id="sessionsList" class="sessions"></ul>
    </aside>

    <div id="editModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">编辑气泡</div>
          <button id="editClose" class="btn icon-btn" type="button" aria-label="关闭">×</button>
        </div>
        <div class="modal-body">
          <textarea id="editTextarea" placeholder="输入新的内容…"></textarea>
        </div>
        <div class="modal-actions">
          <button id="editCancel" class="btn" type="button">取消</button>
          <button id="editSave" class="btn primary" type="button">保存</button>
        </div>
      </div>
    </div>

    <div id="kvCacheModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">KV缓存管理</div>
          <button id="kvCacheClose" class="btn icon-btn" type="button" aria-label="关闭">×</button>
        </div>
        <div class="modal-body">
          <p style="color: var(--muted); font-size: 14px; margin: 0 0 16px 0;">管理当前模型的KV缓存，可以保存或加载缓存以加快推理速度。</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="saveKV" class="btn" type="button" style="min-width: 120px;">保存KV缓存</button>
            <button id="loadKV" class="btn" type="button" style="min-width: 120px;">加载KV缓存</button>
          </div>
        </div>
        <div class="modal-actions">
          <button id="kvCacheCancel" class="btn" type="button">关闭</button>
        </div>
      </div>
    </div>

    <div id="mcpToolsModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">MCP 工具</div>
          <button id="mcpToolsClose" class="btn icon-btn" type="button" aria-label="关闭">×</button>
        </div>
        <div class="modal-body">
          <div class="long-setting">
            <div class="mcp-tools-actions">
              <button id="refreshMcpTools" class="btn" type="button">刷新</button>
              <span id="mcpToolsStatus" class="hint"></span>
            </div>
            <div id="mcpToolsList" class="mcp-tools"></div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="mcpToolsDone" class="btn primary" type="button">完成</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/lz-string.js"></script>
  <script src="/js/marked.min.js"></script>
  <script src="/js/highlight.min.js"></script>
  <script src="/js/completion-dom-state.js"></script>
  <script src="/js/completion-markdown.js"></script>
  <script src="/js/completion-net-tools.js"></script>
  <script src="/js/completion-ui-render.js"></script>
  <script src="/js/completion-runtime.js"></script>
  <script src="/js/completion-init.js"></script>
</body>

</html>
