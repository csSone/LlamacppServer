<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Easy Chat</title>
  <link rel="stylesheet" href="/css/completion.css" />
  <style>
    /* Drawer Tabs Styles */
    .drawer-tabs {
      display: flex;
      padding: 8px 14px;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
    }
    .drawer-tab-item {
      flex: 1;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .drawer-tab-item:hover {
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }
    .drawer-tab-item.active {
      background: #ffffff;
      color: var(--primary);
      border-color: var(--border);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .drawer-content {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .drawer-content.active {
      display: flex;
    }
    .drawer-actions {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #topicList {
      flex: 1;
      overflow-y: auto;
    }

    #chatTitleTag.title-tag {
      appearance: none;
      border: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.03), rgba(0, 0, 0, 0.01));
      text-align: left;
      cursor: pointer;
      padding: 6px 10px;
      min-width: 0;
      white-space: nowrap;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }

    #chatTitleTag.title-tag:hover {
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.06), rgba(0, 0, 0, 0.02));
      border-color: rgba(0, 0, 0, 0.14);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    #chatTitleTag.title-tag:active {
      transform: translateY(1px);
    }

    #chatTitleTag.title-tag:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    #chatTitleTag .title-tag-main {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 650;
    }

    #chatTitleTag .title-tag-hint {
      flex: 0 0 auto;
      white-space: nowrap;
      font-size: 12px;
      color: var(--muted);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(0, 0, 0, 0.18);
      background: rgba(0, 0, 0, 0.02);
    }

    #chatTitleTag.title-tag:hover .title-tag-hint {
      border-color: rgba(0, 0, 0, 0.28);
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }

    #titleInput.title-input.is-hidden {
      display: none;
    }

    .settings-footer {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="main">
      <div class="chat-shell">
        <div class="chat-top">
          <div class="chat-title">
            <button id="chatTitleTag" class="title-input title-tag" type="button" aria-label="ç¼–è¾‘è§’è‰²åç§°">
              <span id="chatTitleMain" class="title-tag-main"></span>
              <span id="chatTitleHint" class="title-tag-hint" aria-hidden="true"></span>
            </button>
            <input id="titleInput" class="title-input is-hidden" type="text" placeholder="è§’è‰²åç§°ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰" tabindex="-1" aria-hidden="true" />
          </div>
          <div class="chat-actions">
            <button id="sessionsToggle" class="btn ghost" type="button">è§’è‰²åˆ—è¡¨</button>
          </div>
        </div>
        <div class="model-header-bar">
          <label for="modelSelect">æ¨¡å‹</label>
          <select id="modelSelect"></select>
          <button id="refreshModels" class="btn icon-btn ghost" type="button" title="åˆ·æ–°æ¨¡å‹åˆ—è¡¨">â†»</button>
        </div>
        <div id="chatList" class="chat-list"></div>

        <div class="composer">
          <div class="model-row">
            <div id="easy-setting">
              <div class="toggle">
                <input id="autoScroll" type="checkbox" checked />
                <label for="autoScroll" class="hint">è‡ªåŠ¨æ»šåŠ¨</label>
              </div>
              <div class="toggle">
                <input id="streamToggle" type="checkbox" checked />
                <label for="streamToggle" class="hint">æµå¼ä¼ è¾“</label>
              </div>
              <div class="toggle">
                <input id="thinkingToggle" type="checkbox" checked />
                <label for="thinkingToggle" class="hint">å¼€å¯æ€è€ƒ</label>
              </div>
              <div class="toggle">
                <input id="webSearchToggle" type="checkbox" />
                <label for="webSearchToggle" class="hint">è”ç½‘æœç´¢</label>
              </div>
              <button id="toggleSettings" class="btn" type="button">è®¾ç½®</button>
              <button id="clearChat" class="btn" type="button">æ¸…ç©º</button>
              <button id="kvCacheToggle" class="btn icon-btn ghost" type="button" title="KVç¼“å­˜ç®¡ç†">ğŸ’¾</button>
              <button id="mcpToolsToggle" class="btn icon-btn ghost" type="button" title="MCP å·¥å…·">ğŸ”Œ</button>
            </div>
          </div>

          <div id="settingsPanel" class="settings-modal" aria-hidden="true" inert>
            <div class="settings-container">
              <div class="settings-sidebar">
                <div class="settings-header">
                  <div class="settings-title">è®¾ç½®</div>
                </div>
                <nav class="settings-nav">
                  <button class="nav-item active" data-tab="general">é€šç”¨è®¾ç½®</button>
                  <button class="nav-item" data-tab="model">æ¨¡å‹å‚æ•°</button>
                  <button class="nav-item" data-tab="template">å¯¹è¯æ¨¡æ¿</button>
                </nav>
                <div class="settings-footer">
                  <button id="cancelSettings" class="btn full-width" type="button">å–æ¶ˆ</button>
                  <button id="closeSettings" class="btn primary full-width" type="button">å®Œæˆ</button>
                </div>
              </div>
              
              <div class="settings-main">
                <div id="tab-general" class="settings-tab active">
                  <div class="setting-group">
                    <h3 class="group-title">ç”¨æˆ·è®¾å®š</h3>
                    <div class="setting-row">
                      <label for="userName">ç”¨æˆ·æ˜µç§°</label>
                      <input id="userName" type="text" placeholder="ä¾‹å¦‚ï¼šæˆ‘" class="input-styled" />
                    </div>
                  </div>
                  
                  <div class="setting-group">
                    <h3 class="group-title">è§’è‰²è®¾å®š</h3>
                    <div class="setting-row">
                      <label>å¤´åƒ</label>
                      <div class="avatar-wrapper">
                        <div id="avatarSettingPreview" class="avatar clickable" title="ç‚¹å‡»æŸ¥çœ‹å¤´åƒ">AI</div>
                        <button id="avatarSettingUpload" class="btn small" type="button">æ›´æ¢</button>
                      </div>
                    </div>
                    <div class="setting-row">
                      <label for="completionTitleSetting">è§’è‰²åç§°</label>
                      <input id="completionTitleSetting" type="text" placeholder="ä¾‹å¦‚ï¼šé»˜è®¤è§’è‰²" class="input-styled" />
                    </div>
                    <div id="sysPromptBox" class="setting-block">
                      <label for="systemPrompt">ç³»ç»Ÿæè¿° <span class="sub-label">ï¼ˆå¯¹è¯å¼€å¤´ï¼‰</span></label>
                      <textarea id="systemPrompt" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„å†™ä½œåŠ©æ‰‹ï¼Œè¾“å‡ºä¸­æ–‡ï¼Œç»“æ„æ¸…æ™°â€¦"></textarea>
                    </div>
                    <div id="rolePromptBox" class="setting-block">
                      <label for="rolePrompt">è§’è‰²è¯¦æƒ… <span class="sub-label">ï¼ˆæ€§æ ¼/ç›®æ ‡/è®¾å®šï¼‰</span></label>
                      <textarea id="rolePrompt" placeholder="ä¾‹å¦‚ï¼šä½ å«XXï¼Œä½ çš„æ€§æ ¼/ç›®æ ‡/å£ç™–/ä¸–ç•Œè§‚â€¦"></textarea>
                    </div>
                  </div>
                </div>

                <div id="tab-model" class="settings-tab">
                  <div class="setting-group">
                    <h3 class="group-title">æ¥å£é…ç½®</h3>
                    <div class="setting-row">
                      <label for="apiModelSelect">API ç«¯ç‚¹</label>
                      <select id="apiModelSelect" class="select-styled">
                        <option value="1">/v1/chat/completions</option>
                        <option value="0">/v1/completions</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="setting-group">
                    <h3 class="group-title">ç”Ÿæˆå‚æ•°</h3>
                    <div class="grid-2">
                      <div class="setting-block">
                        <label for="maxTokens">Max Tokens</label>
                        <input id="maxTokens" type="number" value="512" min="1" max="32768" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="temperature">Temperature</label>
                        <input id="temperature" type="number" value="0.7" step="0.1" min="0" max="2" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="topP">Top P</label>
                        <input id="topP" type="number" value="1" step="0.05" min="0" max="1" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="minP">Min P</label>
                        <input id="minP" type="number" step="0.01" min="0" max="1" value="0.05" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="repeatPenalty">Repeat Penalty</label>
                        <input id="repeatPenalty" type="number" step="0.05" min="0" max="10" value="1.0" class="input-styled" />
                      </div>
                    </div>
                    <div class="setting-block">
                      <label for="stopSequences">Stop Sequences <span class="sub-label">ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰</span></label>
                      <textarea id="stopSequences" placeholder="ç•™ç©ºè¡¨ç¤ºä½¿ç”¨å†…ç½®é»˜è®¤ stop" class="code-font"></textarea>
                    </div>
                  </div>
                </div>

                <div id="tab-template" class="settings-tab">
                  <div class="setting-group">
                    <h3 class="group-title">æ¶ˆæ¯æ¨¡æ¿</h3>
                    <div class="setting-block">
                      <label for="userPrefix">ç”¨æˆ·æ¶ˆæ¯å‰ç¼€</label>
                      <textarea id="userPrefix" placeholder="å¯é€‰"></textarea>
                    </div>
                    <div class="setting-block">
                      <label for="userSuffix">ç”¨æˆ·æ¶ˆæ¯åç¼€</label>
                      <textarea id="userSuffix" placeholder="å¯é€‰"></textarea>
                    </div>
                    <div class="setting-block">
                      <label for="assistantPrefix">åŠ©æ‰‹æ¶ˆæ¯å‰ç¼€</label>
                      <textarea id="assistantPrefix" placeholder="å¯é€‰"></textarea>
                    </div>
                    <div class="setting-block">
                      <label for="assistantSuffix">åŠ©æ‰‹æ¶ˆæ¯åç¼€</label>
                      <textarea id="assistantSuffix" placeholder="å¯é€‰"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="prompt-row">
          	<div class="prompt-actions">
          		<button id="modelRowToggle" style="width: 48px; height: 100%" class="btn icon-btn ghost" type="button" title="æ˜¾ç¤ºæ¨¡å‹æ " aria-label="æ˜¾ç¤ºæ¨¡å‹æ " aria-expanded="false">â˜°</button>
          		<button id="attachBtn" class="btn" type="button">é™„ä»¶</button>
          	</div>
            
            <textarea id="promptInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦ï¼ˆCtrl+Enter å‘é€ï¼‰" style="min-height: 48px; max-height: 48px"></textarea>
            <div class="prompt-actions">
              
              <button id="sendBtn" class="btn primary" type="button">å‘é€</button>
              <button id="stopBtn" class="btn danger" type="button" disabled>åœæ­¢</button>
            </div>
            <input id="attachInput" type="file" style="display:none" />
          </div>

          <div class="toolbar">
            <div class="hint" id="saveHint"></div>
            <div id="attachInfo" class="attach-info" aria-live="polite">
              <span class="hint">å·²é€‰é™„ä»¶</span>
              <span id="attachName" class="name"></span>
              <button id="attachClear" class="btn icon-btn clear" type="button" aria-label="æ¸…é™¤é™„ä»¶">Ã—</button>
            </div>
            <div class="spacer"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="drawerBackdrop" class="backdrop"></div>
    <aside id="sessionsDrawer" class="drawer" aria-hidden="true" inert>
      <div class="drawer-header">
        <div class="drawer-title" id="drawerTitle">ç®¡ç†</div>
        <button id="drawerClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
      </div>

      <div class="drawer-tabs">
        <button class="drawer-tab-item active" data-tab="sessions">è§’è‰²</button>
        <button class="drawer-tab-item" data-tab="topics">è¯é¢˜</button>
      </div>

      <div id="sessionsTab" class="drawer-content active">
        <div class="drawer-actions">
          <button id="newSessionBtn" class="btn primary" type="button">æ–°å»ºè§’è‰²</button>
          <button id="reloadSessionsBtn" class="btn" type="button">åˆ·æ–°</button>
          <span class="hint" id="drawerHint"></span>
        </div>
        <ul id="sessionsList" class="sessions"></ul>
      </div>

      <div id="topicsTab" class="drawer-content">
        <div class="drawer-actions">
          <button id="newTopicBtn" class="btn primary" type="button">æ–°å»ºè¯é¢˜</button>
        </div>
        <div id="topicList" class="topic-list" style="padding: 10px;"></div>
      </div>
    </aside>

    <div id="editModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">ç¼–è¾‘æ°”æ³¡</div>
          <button id="editClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <textarea id="editTextarea" placeholder="è¾“å…¥æ–°çš„å†…å®¹â€¦"></textarea>
        </div>
        <div class="modal-actions">
          <button id="editCancel" class="btn" type="button">å–æ¶ˆ</button>
          <button id="editSave" class="btn primary" type="button">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div id="kvCacheModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">KVç¼“å­˜ç®¡ç†</div>
          <button id="kvCacheClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <p style="color: var(--muted); font-size: 14px; margin: 0 0 16px 0;">ç®¡ç†å½“å‰æ¨¡å‹çš„KVç¼“å­˜ï¼Œå¯ä»¥ä¿å­˜æˆ–åŠ è½½ç¼“å­˜ä»¥åŠ å¿«æ¨ç†é€Ÿåº¦ã€‚</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="saveKV" class="btn" type="button" style="min-width: 120px;">ä¿å­˜KVç¼“å­˜</button>
            <button id="loadKV" class="btn" type="button" style="min-width: 120px;">åŠ è½½KVç¼“å­˜</button>
          </div>
        </div>
        <div class="modal-actions">
          <button id="kvCacheCancel" class="btn" type="button">å…³é—­</button>
        </div>
      </div>
    </div>

    <div id="mcpToolsModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">MCP å·¥å…·</div>
          <button id="mcpToolsClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="long-setting">
            <div class="mcp-tools-actions">
              <button id="refreshMcpTools" class="btn" type="button">åˆ·æ–°</button>
              <span id="mcpToolsStatus" class="hint"></span>
            </div>
            <div id="mcpToolsList" class="mcp-tools"></div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="mcpToolsDone" class="btn primary" type="button">å®Œæˆ</button>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/lz-string.js"></script>
  <script src="/js/marked.min.js"></script>
  <script src="/js/highlight.min.js"></script>
  <script src="/js/completion-dom-state.js"></script>
  <script src="/js/completion-markdown.js"></script>
  <script src="/js/completion-net-tools.js"></script>
  <script src="/js/completion-ui-render.js"></script>
  <script src="/js/completion-runtime.js"></script>
  <script src="/js/completion-init.js"></script>
  <script>
    // Drawer Tab Switching Logic
    (function() {
      function initDrawerTabs() {
        const tabBtns = document.querySelectorAll('.drawer-tab-item');
        const tabPanes = document.querySelectorAll('.drawer-content');
        const sessionsToggle = document.getElementById('sessionsToggle');

        function switchTab(tabId) {
          tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
          tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === tabId + 'Tab'));
          if (tabId === 'topics' && typeof renderTopics === 'function') {
            renderTopics();
          }
        }

        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Intercept sessionsToggle to switch to sessions tab
        if (sessionsToggle) {
          sessionsToggle.addEventListener('click', (e) => {
            switchTab('sessions');
          }, true);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDrawerTabs);
      } else {
        initDrawerTabs();
      }
    })();

    (function() {
      function safeCall(fn) {
        try { return fn(); } catch (e) { return undefined; }
      }

      function initChatTitleSettings() {
        const titleTag = document.getElementById('chatTitleTag');
        const hiddenTitleInput = document.getElementById('titleInput');
        const titleSettingInput = document.getElementById('completionTitleSetting');
        const titleMain = document.getElementById('chatTitleMain');
        const titleHint = document.getElementById('chatTitleHint');
        const cancelBtn = document.getElementById('cancelSettings');
        const doneBtn = document.getElementById('closeSettings');

        if (!titleTag || !hiddenTitleInput || !titleSettingInput || !doneBtn || !titleMain || !titleHint) return;

        function computeTitleDisplay(raw) {
          const t = (raw == null ? '' : String(raw)).trim();
          if (!t) return { main: 'é»˜è®¤è§’è‰²', hint: 'ç‚¹æ­¤ä¿®æ”¹åç§°' };
          return { main: t, hint: '' };
        }

        function syncTagFromHidden() {
          const d = computeTitleDisplay(hiddenTitleInput.value);
          titleMain.textContent = d.main;
          titleHint.textContent = d.hint;
          titleTag.setAttribute('aria-label', d.hint ? (d.main + 'ï¼Œ' + d.hint) : (d.main + 'ï¼Œç‚¹æ­¤ä¿®æ”¹åç§°'));
          titleTag.title = d.hint ? (d.main + 'ï¼Œ' + d.hint) : (d.main + 'ï¼ˆç‚¹æ­¤ä¿®æ”¹åç§°ï¼‰');
        }

        function syncSettingFromHidden() {
          titleSettingInput.value = (hiddenTitleInput.value == null ? '' : String(hiddenTitleInput.value));
        }

        function activateGeneralTab() {
          const panel = document.getElementById('settingsPanel');
          if (!panel) return;
          const nav = panel.querySelector('.nav-item[data-tab="general"]');
          if (nav && typeof nav.click === 'function') nav.click();
        }

        function openSettingsAndFocusTitle() {
          syncSettingFromHidden();
          if (typeof window.setSettingsOpen === 'function') window.setSettingsOpen(true);
          setTimeout(() => {
            activateGeneralTab();
            try { titleSettingInput.focus({ preventScroll: true }); } catch (e) {}
            try { titleSettingInput.select(); } catch (e) {}
          }, 0);
        }

        titleTag.addEventListener('click', openSettingsAndFocusTitle);

        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => {
            syncSettingFromHidden();
            if (typeof window.setSettingsOpen === 'function') window.setSettingsOpen(false);
          });
        }

        doneBtn.addEventListener('click', () => {
          const newRaw = (titleSettingInput.value == null ? '' : String(titleSettingInput.value)).trim();
          const currentRaw = (hiddenTitleInput.value == null ? '' : String(hiddenTitleInput.value)).trim();
          if (newRaw !== currentRaw) {
            hiddenTitleInput.value = newRaw;
            safeCall(() => window.refreshCompletionTitleInMessages && window.refreshCompletionTitleInMessages());
          }
          syncTagFromHidden();
        }, true);

        const originalApplyCompletionData = window.applyCompletionData;
        if (typeof originalApplyCompletionData === 'function') {
          window.applyCompletionData = function() {
            const ret = originalApplyCompletionData.apply(this, arguments);
            syncTagFromHidden();
            if (typeof window.setSettingsOpen === 'function') {
              const panel = document.getElementById('settingsPanel');
              if (panel && panel.classList.contains('open')) syncSettingFromHidden();
            }
            return ret;
          };
        }

        const originalSetSettingsOpen = window.setSettingsOpen;
        if (typeof originalSetSettingsOpen === 'function') {
          window.setSettingsOpen = function(open) {
            if (open) syncSettingFromHidden();
            return originalSetSettingsOpen.apply(this, arguments);
          };
        }

        syncTagFromHidden();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatTitleSettings);
      } else {
        initChatTitleSettings();
      }
    })();
  </script>
</body>

</html>
