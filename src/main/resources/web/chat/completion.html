<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Easy Chat</title>
  <link rel="stylesheet" href="/css/completion.css" />
  <style>
    /* Drawer Tabs Styles */
    .drawer-tabs {
      display: flex;
      padding: 8px 14px;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
    }
    .drawer-tab-item {
      flex: 1;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .drawer-tab-item:hover {
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }
    .drawer-tab-item.active {
      background: #ffffff;
      color: var(--primary);
      border-color: var(--border);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .drawer-content {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .drawer-content.active {
      display: flex;
    }
    .drawer-actions {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    #topicList {
      flex: 1;
      overflow-y: auto;
    }

    #chatTitleTag.title-tag {
      appearance: none;
      border: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.03), rgba(0, 0, 0, 0.01));
      text-align: left;
      cursor: pointer;
      padding: 6px 10px;
      min-width: 0;
      white-space: nowrap;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }

    #chatTitleTag.title-tag:hover {
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.06), rgba(0, 0, 0, 0.02));
      border-color: rgba(0, 0, 0, 0.14);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    #chatTitleTag.title-tag:active {
      transform: translateY(1px);
    }

    #chatTitleTag.title-tag:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    #chatTitleTag .title-tag-main {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 650;
    }

    #chatTitleTag .title-tag-hint {
      flex: 0 0 auto;
      white-space: nowrap;
      font-size: 12px;
      color: var(--muted);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(0, 0, 0, 0.18);
      background: rgba(0, 0, 0, 0.02);
    }

    #chatTitleTag.title-tag:hover .title-tag-hint {
      border-color: rgba(0, 0, 0, 0.28);
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }

    #titleInput.title-input.is-hidden {
      display: none;
    }

    .settings-footer {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="main">
      <div class="chat-shell">
        <div class="chat-top">
          <div class="chat-title">
            <button id="chatTitleTag" class="title-input title-tag" type="button" aria-label="page.chat.completion.aria.edit_role_name" data-i18n="page.chat.completion.aria.edit_role_name" data-i18n-attr="aria-label">
              <span id="chatTitleMain" class="title-tag-main"></span>
              <span id="chatTitleHint" class="title-tag-hint" aria-hidden="true"></span>
            </button>
            <input id="titleInput" class="title-input is-hidden" type="text" placeholder="page.chat.completion.placeholder.role_name_autosave" data-i18n="page.chat.completion.placeholder.role_name_autosave" data-i18n-attr="placeholder" tabindex="-1" aria-hidden="true" />
          </div>
          <div class="chat-actions">
            <button id="sessionsToggle" class="btn ghost" type="button" data-i18n="page.chat.completion.action.sessions">page.chat.completion.action.sessions</button>
          </div>
        </div>
        <div class="model-header-bar">
          <label for="modelSelect" data-i18n="page.chat.completion.label.model">page.chat.completion.label.model</label>
          <select id="modelSelect"></select>
          <button id="refreshModels" class="btn icon-btn ghost" type="button" title="page.chat.completion.tooltip.refresh_models" data-i18n="page.chat.completion.tooltip.refresh_models" data-i18n-attr="title">â†»</button>
        </div>
        <div id="chatList" class="chat-list"></div>

        <div class="composer">
          <div class="model-row">
            <div id="easy-setting">
              <div class="toggle">
                <input id="autoScroll" type="checkbox" checked />
                <label for="autoScroll" class="hint" data-i18n="page.chat.completion.label.auto_scroll">page.chat.completion.label.auto_scroll</label>
              </div>
              <div class="toggle">
                <input id="streamToggle" type="checkbox" checked />
                <label for="streamToggle" class="hint" data-i18n="page.chat.completion.label.stream">page.chat.completion.label.stream</label>
              </div>
              <div class="toggle">
                <input id="thinkingToggle" type="checkbox" checked />
                <label for="thinkingToggle" class="hint" data-i18n="page.chat.completion.label.thinking">page.chat.completion.label.thinking</label>
              </div>
              <div class="toggle">
                <input id="webSearchToggle" type="checkbox" />
                <label for="webSearchToggle" class="hint" data-i18n="page.chat.completion.label.web_search">page.chat.completion.label.web_search</label>
              </div>
              <button id="toggleSettings" class="btn" type="button" data-i18n="page.chat.completion.action.settings">page.chat.completion.action.settings</button>
              <button id="clearChat" class="btn" type="button" data-i18n="page.chat.completion.action.clear">page.chat.completion.action.clear</button>
              <button id="kvCacheToggle" class="btn icon-btn ghost" type="button" title="page.chat.completion.tooltip.kv_cache" data-i18n="page.chat.completion.tooltip.kv_cache" data-i18n-attr="title">ðŸ’¾</button>
              <button id="mcpToolsToggle" class="btn icon-btn ghost" type="button" title="page.chat.completion.tooltip.mcp_tools" data-i18n="page.chat.completion.tooltip.mcp_tools" data-i18n-attr="title">ðŸ”Œ</button>
            </div>
          </div>

          <div id="settingsPanel" class="settings-modal" aria-hidden="true" inert>
            <div class="settings-container">
              <div class="settings-sidebar">
                <div class="settings-header">
                  <div class="settings-title" data-i18n="page.chat.completion.settings.title">page.chat.completion.settings.title</div>
                </div>
                <nav class="settings-nav">
                  <button class="nav-item active" data-tab="general" data-i18n="page.chat.completion.settings.tab.general">page.chat.completion.settings.tab.general</button>
                  <button class="nav-item" data-tab="model" data-i18n="page.chat.completion.settings.tab.model">page.chat.completion.settings.tab.model</button>
                  <button class="nav-item" data-tab="template" data-i18n="page.chat.completion.settings.tab.template">page.chat.completion.settings.tab.template</button>
                </nav>
                <div class="settings-footer">
                  <button id="cancelSettings" class="btn full-width" type="button" data-i18n="common.cancel">common.cancel</button>
                  <button id="closeSettings" class="btn primary full-width" type="button" data-i18n="page.chat.completion.action.done">page.chat.completion.action.done</button>
                </div>
              </div>
              
              <div class="settings-main">
                <div id="tab-general" class="settings-tab active">
                  <div class="setting-group">
                    <h3 class="group-title" data-i18n="page.chat.completion.settings.section.user">page.chat.completion.settings.section.user</h3>
                    <div class="setting-row">
                      <label for="userName" data-i18n="page.chat.completion.settings.user.nickname">page.chat.completion.settings.user.nickname</label>
                      <input id="userName" type="text" placeholder="page.chat.completion.settings.user.nickname_placeholder" data-i18n="page.chat.completion.settings.user.nickname_placeholder" data-i18n-attr="placeholder" class="input-styled" />
                    </div>
                  </div>
                  
                  <div class="setting-group">
                    <h3 class="group-title" data-i18n="page.chat.completion.settings.section.role">page.chat.completion.settings.section.role</h3>
                    <div class="setting-row">
                      <label data-i18n="page.chat.completion.settings.role.avatar">page.chat.completion.settings.role.avatar</label>
                      <div class="avatar-wrapper">
                        <div id="avatarSettingPreview" class="avatar clickable" title="page.chat.completion.settings.role.avatar_preview_title" data-i18n="page.chat.completion.settings.role.avatar_preview_title" data-i18n-attr="title">AI</div>
                        <button id="avatarSettingUpload" class="btn small" type="button" data-i18n="page.chat.completion.action.change">page.chat.completion.action.change</button>
                      </div>
                    </div>
                    <div class="setting-row">
                      <label for="completionTitleSetting" data-i18n="page.chat.completion.settings.role.name">page.chat.completion.settings.role.name</label>
                      <input id="completionTitleSetting" type="text" placeholder="page.chat.completion.settings.role.name_placeholder" data-i18n="page.chat.completion.settings.role.name_placeholder" data-i18n-attr="placeholder" class="input-styled" />
                    </div>
                    <div id="sysPromptBox" class="setting-block">
                      <label for="systemPrompt"><span data-i18n="page.chat.completion.settings.role.system_prompt">page.chat.completion.settings.role.system_prompt</span> <span class="sub-label" data-i18n="page.chat.completion.settings.role.system_prompt_sublabel">page.chat.completion.settings.role.system_prompt_sublabel</span></label>
                      <textarea id="systemPrompt" placeholder="page.chat.completion.settings.role.system_prompt_placeholder" data-i18n="page.chat.completion.settings.role.system_prompt_placeholder" data-i18n-attr="placeholder"></textarea>
                    </div>
                    <div id="rolePromptBox" class="setting-block">
                      <label for="rolePrompt"><span data-i18n="page.chat.completion.settings.role.role_prompt">page.chat.completion.settings.role.role_prompt</span> <span class="sub-label" data-i18n="page.chat.completion.settings.role.role_prompt_sublabel">page.chat.completion.settings.role.role_prompt_sublabel</span></label>
                      <textarea id="rolePrompt" placeholder="page.chat.completion.settings.role.role_prompt_placeholder" data-i18n="page.chat.completion.settings.role.role_prompt_placeholder" data-i18n-attr="placeholder"></textarea>
                    </div>
                  </div>
                </div>

                <div id="tab-model" class="settings-tab">
                  <div class="setting-group">
                    <h3 class="group-title" data-i18n="page.chat.completion.settings.section.api">page.chat.completion.settings.section.api</h3>
                    <div class="setting-row">
                      <label for="apiModelSelect" data-i18n="page.chat.completion.settings.api.endpoint">page.chat.completion.settings.api.endpoint</label>
                      <select id="apiModelSelect" class="select-styled">
                        <option value="1">/v1/chat/completions</option>
                        <option value="0">/v1/completions</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="setting-group">
                    <h3 class="group-title" data-i18n="page.chat.completion.settings.section.generation">page.chat.completion.settings.section.generation</h3>
                    <div class="grid-2">
                      <div class="setting-block">
                        <label for="maxTokens">Max Tokens</label>
                        <input id="maxTokens" type="number" value="512" min="1" max="32768" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="temperature">Temperature</label>
                        <input id="temperature" type="number" value="0.7" step="0.1" min="0" max="2" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="topP">Top P</label>
                        <input id="topP" type="number" value="1" step="0.05" min="0" max="1" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="minP">Min P</label>
                        <input id="minP" type="number" step="0.01" min="0" max="1" value="0.05" class="input-styled" />
                      </div>
                      <div class="setting-block">
                        <label for="repeatPenalty">Repeat Penalty</label>
                        <input id="repeatPenalty" type="number" step="0.05" min="0" max="10" value="1.0" class="input-styled" />
                      </div>
                    </div>
                    <div class="setting-block">
                      <label for="stopSequences">Stop Sequences <span class="sub-label" data-i18n="page.chat.completion.settings.stop_sequences.sublabel">page.chat.completion.settings.stop_sequences.sublabel</span></label>
                      <textarea id="stopSequences" placeholder="page.chat.completion.settings.stop_sequences.placeholder" data-i18n="page.chat.completion.settings.stop_sequences.placeholder" data-i18n-attr="placeholder" class="code-font"></textarea>
                    </div>
                  </div>
                </div>

                <div id="tab-template" class="settings-tab">
                  <div class="setting-group">
                    <h3 class="group-title" data-i18n="page.chat.completion.settings.section.template">page.chat.completion.settings.section.template</h3>
                    <div class="setting-block">
                      <label for="userPrefix" data-i18n="page.chat.completion.settings.template.user_prefix">page.chat.completion.settings.template.user_prefix</label>
                      <textarea id="userPrefix" placeholder="page.chat.completion.settings.template.optional_placeholder" data-i18n="page.chat.completion.settings.template.optional_placeholder" data-i18n-attr="placeholder"></textarea>
                    </div>
                    <div class="setting-block">
                      <label for="userSuffix" data-i18n="page.chat.completion.settings.template.user_suffix">page.chat.completion.settings.template.user_suffix</label>
                      <textarea id="userSuffix" placeholder="page.chat.completion.settings.template.optional_placeholder" data-i18n="page.chat.completion.settings.template.optional_placeholder" data-i18n-attr="placeholder"></textarea>
                    </div>
                    <div class="setting-block">
                      <label for="assistantPrefix" data-i18n="page.chat.completion.settings.template.assistant_prefix">page.chat.completion.settings.template.assistant_prefix</label>
                      <textarea id="assistantPrefix" placeholder="page.chat.completion.settings.template.optional_placeholder" data-i18n="page.chat.completion.settings.template.optional_placeholder" data-i18n-attr="placeholder"></textarea>
                    </div>
                    <div class="setting-block">
                      <label for="assistantSuffix" data-i18n="page.chat.completion.settings.template.assistant_suffix">page.chat.completion.settings.template.assistant_suffix</label>
                      <textarea id="assistantSuffix" placeholder="page.chat.completion.settings.template.optional_placeholder" data-i18n="page.chat.completion.settings.template.optional_placeholder" data-i18n-attr="placeholder"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="prompt-row">
          	<div class="prompt-actions">
          		<button id="modelRowToggle" style="width: 48px; height: 100%" class="btn icon-btn ghost" type="button" aria-label="page.chat.completion.tooltip.toggle_model_row" data-i18n="page.chat.completion.tooltip.toggle_model_row" data-i18n-attr="aria-label" aria-expanded="false">â˜°</button>
          		<button id="attachBtn" class="btn" type="button" data-i18n="page.chat.completion.action.attach">page.chat.completion.action.attach</button>
          	</div>
            
            <textarea id="promptInput" placeholder="page.chat.completion.placeholder.prompt" data-i18n="page.chat.completion.placeholder.prompt" data-i18n-attr="placeholder" style="min-height: 48px; max-height: 48px"></textarea>
            <div class="prompt-actions">
              
              <button id="sendBtn" class="btn primary" type="button" data-i18n="page.chat.completion.action.send">page.chat.completion.action.send</button>
              <button id="stopBtn" class="btn danger" type="button" disabled data-i18n="page.chat.completion.action.stop">page.chat.completion.action.stop</button>
            </div>
            <input id="attachInput" type="file" style="display:none" />
          </div>

          <div class="toolbar">
            <div class="hint" id="saveHint"></div>
            <div id="attachInfo" class="attach-info" aria-live="polite">
              <span class="hint" data-i18n="page.chat.completion.attachment.selected">page.chat.completion.attachment.selected</span>
              <span id="attachName" class="name"></span>
              <button id="attachClear" class="btn icon-btn clear" type="button" aria-label="page.chat.completion.aria.clear_attachment" data-i18n="page.chat.completion.aria.clear_attachment" data-i18n-attr="aria-label">Ã—</button>
            </div>
            <div class="spacer"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="drawerBackdrop" class="backdrop"></div>
    <aside id="sessionsDrawer" class="drawer" aria-hidden="true" inert>
      <div class="drawer-header">
        <div class="drawer-title" id="drawerTitle" data-i18n="page.chat.completion.drawer.title">page.chat.completion.drawer.title</div>
        <button id="drawerClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
      </div>

      <div class="drawer-tabs">
        <button class="drawer-tab-item active" data-tab="sessions" data-i18n="page.chat.completion.drawer.tab.sessions">page.chat.completion.drawer.tab.sessions</button>
        <button class="drawer-tab-item" data-tab="topics" data-i18n="page.chat.completion.drawer.tab.topics">page.chat.completion.drawer.tab.topics</button>
      </div>

      <div id="sessionsTab" class="drawer-content active">
        <div class="drawer-actions">
          <button id="newSessionBtn" class="btn primary" type="button" data-i18n="page.chat.completion.action.new_session">page.chat.completion.action.new_session</button>
          <button id="reloadSessionsBtn" class="btn" type="button" data-i18n="common.refresh">common.refresh</button>
          <span class="hint" id="drawerHint"></span>
        </div>
        <ul id="sessionsList" class="sessions"></ul>
      </div>

      <div id="topicsTab" class="drawer-content">
        <div class="drawer-actions">
          <button id="newTopicBtn" class="btn primary" type="button" data-i18n="page.chat.completion.action.new_topic">page.chat.completion.action.new_topic</button>
        </div>
        <div id="topicList" class="topic-list" style="padding: 10px;"></div>
      </div>
    </aside>

    <div id="editModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title" data-i18n="page.chat.completion.modal.edit.title">page.chat.completion.modal.edit.title</div>
          <button id="editClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <textarea id="editTextarea" placeholder="page.chat.completion.modal.edit.placeholder" data-i18n="page.chat.completion.modal.edit.placeholder" data-i18n-attr="placeholder"></textarea>
        </div>
        <div class="modal-actions">
          <button id="editCancel" class="btn" type="button" data-i18n="common.cancel">common.cancel</button>
          <button id="editSave" class="btn primary" type="button" data-i18n="common.save">common.save</button>
        </div>
      </div>
    </div>

    <div id="kvCacheModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title" data-i18n="page.chat.completion.modal.kv_cache.title">page.chat.completion.modal.kv_cache.title</div>
          <button id="kvCacheClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <p style="color: var(--muted); font-size: 14px; margin: 0 0 16px 0;" data-i18n="page.chat.completion.modal.kv_cache.desc">page.chat.completion.modal.kv_cache.desc</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="saveKV" class="btn" type="button" style="min-width: 120px;" data-i18n="page.chat.completion.modal.kv_cache.action.save">page.chat.completion.modal.kv_cache.action.save</button>
            <button id="loadKV" class="btn" type="button" style="min-width: 120px;" data-i18n="page.chat.completion.modal.kv_cache.action.load">page.chat.completion.modal.kv_cache.action.load</button>
          </div>
        </div>
        <div class="modal-actions">
          <button id="kvCacheCancel" class="btn" type="button" data-i18n="common.close">common.close</button>
        </div>
      </div>
    </div>

    <div id="mcpToolsModal" class="modal-wrap" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title" data-i18n="page.chat.completion.modal.mcp_tools.title">page.chat.completion.modal.mcp_tools.title</div>
          <button id="mcpToolsClose" class="btn icon-btn" type="button" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="long-setting">
            <div class="mcp-tools-actions">
              <button id="refreshMcpTools" class="btn" type="button" data-i18n="common.refresh">common.refresh</button>
              <span id="mcpToolsStatus" class="hint"></span>
            </div>
            <div id="mcpToolsList" class="mcp-tools"></div>
          </div>
        </div>
        <div class="modal-actions">
          <button id="mcpToolsDone" class="btn primary" type="button" data-i18n="page.chat.completion.action.done">page.chat.completion.action.done</button>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/i18n.js"></script>
  <script src="/js/lz-string.js"></script>
  <script src="/js/marked.min.js"></script>
  <script src="/js/highlight.min.js"></script>
  <script src="/js/completion-dom-state.js"></script>
  <script src="/js/completion-markdown.js"></script>
  <script src="/js/completion-net-tools.js"></script>
  <script src="/js/completion-ui-render.js"></script>
  <script src="/js/completion-runtime.js"></script>
  <script src="/js/completion-init.js"></script>
  <script>
    // Drawer Tab Switching Logic
    (function() {
      function initDrawerTabs() {
        const tabBtns = document.querySelectorAll('.drawer-tab-item');
        const tabPanes = document.querySelectorAll('.drawer-content');
        const sessionsToggle = document.getElementById('sessionsToggle');

        function switchTab(tabId) {
          tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
          tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === tabId + 'Tab'));
          if (tabId === 'topics' && typeof renderTopics === 'function') {
            renderTopics();
          }
        }

        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Intercept sessionsToggle to switch to sessions tab
        if (sessionsToggle) {
          sessionsToggle.addEventListener('click', (e) => {
            switchTab('sessions');
          }, true);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDrawerTabs);
      } else {
        initDrawerTabs();
      }
    })();

    (function() {
      function safeCall(fn) {
        try { return fn(); } catch (e) { return undefined; }
      }

      function initChatTitleSettings() {
        const titleTag = document.getElementById('chatTitleTag');
        const hiddenTitleInput = document.getElementById('titleInput');
        const titleSettingInput = document.getElementById('completionTitleSetting');
        const titleMain = document.getElementById('chatTitleMain');
        const titleHint = document.getElementById('chatTitleHint');
        const cancelBtn = document.getElementById('cancelSettings');
        const doneBtn = document.getElementById('closeSettings');

        if (!titleTag || !hiddenTitleInput || !titleSettingInput || !doneBtn || !titleMain || !titleHint) return;

        function t(key, fallback) {
          if (window.I18N && typeof window.I18N.t === 'function') return window.I18N.t(key, fallback);
          return fallback == null ? key : fallback;
        }

        function tf(key, vars, fallback) {
          const template = t(key, fallback);
          if (!vars || template == null) return template;
          let out = String(template);
          for (const k of Object.keys(vars)) {
            out = out.split(`{${k}}`).join(String(vars[k]));
          }
          return out;
        }

        function computeTitleDisplay(raw) {
          const rawText = (raw == null ? '' : String(raw)).trim();
          if (!rawText) {
            return {
              main: t('page.chat.completion.role.default', 'Default Role'),
              hint: t('page.chat.completion.role.hint', 'Click to edit name')
            };
          }
          return { main: rawText, hint: '' };
        }

        function syncTagFromHidden() {
          const d = computeTitleDisplay(hiddenTitleInput.value);
          titleMain.textContent = d.main;
          titleHint.textContent = d.hint;
          titleTag.setAttribute('aria-label', tf('page.chat.completion.role.aria_label', { name: d.main }, '{name}, click to edit name'));
          titleTag.title = tf('page.chat.completion.role.title_attr', { name: d.main }, '{name} (click to edit name)');
        }

        function syncSettingFromHidden() {
          titleSettingInput.value = (hiddenTitleInput.value == null ? '' : String(hiddenTitleInput.value));
        }

        function activateGeneralTab() {
          const panel = document.getElementById('settingsPanel');
          if (!panel) return;
          const nav = panel.querySelector('.nav-item[data-tab="general"]');
          if (nav && typeof nav.click === 'function') nav.click();
        }

        function openSettingsAndFocusTitle() {
          syncSettingFromHidden();
          if (typeof window.setSettingsOpen === 'function') window.setSettingsOpen(true);
          setTimeout(() => {
            activateGeneralTab();
            try { titleSettingInput.focus({ preventScroll: true }); } catch (e) {}
            try { titleSettingInput.select(); } catch (e) {}
          }, 0);
        }

        titleTag.addEventListener('click', openSettingsAndFocusTitle);
        window.addEventListener('i18n:ready', syncTagFromHidden);

        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => {
            syncSettingFromHidden();
            if (typeof window.setSettingsOpen === 'function') window.setSettingsOpen(false);
          });
        }

        doneBtn.addEventListener('click', () => {
          const newRaw = (titleSettingInput.value == null ? '' : String(titleSettingInput.value)).trim();
          const currentRaw = (hiddenTitleInput.value == null ? '' : String(hiddenTitleInput.value)).trim();
          if (newRaw !== currentRaw) {
            hiddenTitleInput.value = newRaw;
            safeCall(() => window.refreshCompletionTitleInMessages && window.refreshCompletionTitleInMessages());
          }
          syncTagFromHidden();
        }, true);

        const originalApplyCompletionData = window.applyCompletionData;
        if (typeof originalApplyCompletionData === 'function') {
          window.applyCompletionData = function() {
            const ret = originalApplyCompletionData.apply(this, arguments);
            syncTagFromHidden();
            if (typeof window.setSettingsOpen === 'function') {
              const panel = document.getElementById('settingsPanel');
              if (panel && panel.classList.contains('open')) syncSettingFromHidden();
            }
            return ret;
          };
        }

        const originalSetSettingsOpen = window.setSettingsOpen;
        if (typeof originalSetSettingsOpen === 'function') {
          window.setSettingsOpen = function(open) {
            if (open) syncSettingFromHidden();
            return originalSetSettingsOpen.apply(this, arguments);
          };
        }

        syncTagFromHidden();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChatTitleSettings);
      } else {
        initChatTitleSettings();
      }
    })();
  </script>
</body>

</html>
