<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Benchmark V2</title>
  <link rel="stylesheet" href="../css/all.min.css" />
  <link href="../css/css2.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/index.css" />
  <style>
    html, body {
      height: 100%;
      min-height: 100%;
      margin: 0;
      background: var(--bg-color);
      color: var(--text-primary);
      font-family: "Microsoft YaHei", sans-serif;
    }
    .page {
      height: 100%;
      min-height: 100vh;
      width: 100%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1 1 auto;
    }
    .top {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
      background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0)) , var(--sidebar-bg);
      flex: 0 0 auto;
    }
    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.2px;
      margin: 0;
    }
    .content {
      padding: 16px 18px 24px 18px;
      overflow: auto;
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-columns: 360px minmax(0, 1fr);
      gap: 16px;
      align-items: stretch;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
      min-height: 0;
    }
    .row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items: center;
    }
    .row label {
      color: var(--text-secondary);
    }
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .form-card .row {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
    }
    .form-card .row label {
      font-size: 12px;
    }
    .left-col {
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 0;
    }
    .left-col .form-card {
      flex: 0 0 auto;
    }
    .left-col .all-models-card {
      flex: 1 1 auto;
      min-height: 0;
    }
    .all-models-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .model-menu {
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: auto;
      min-height: 0;
      padding: 2px 0;
    }
    .model-menu-item {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr;
      gap: 2px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 10px;
      background: rgba(255, 255, 255, 0.02);
      color: var(--text-primary);
      cursor: pointer;
      text-align: left;
    }
    .model-menu-item:hover {
      border-color: rgba(99, 102, 241, 0.45);
      background: rgba(99, 102, 241, 0.08);
    }
    .model-menu-item.active {
      border-color: rgba(99, 102, 241, 0.75);
      background: rgba(99, 102, 241, 0.14);
    }
    .model-menu-item.loaded:not(.active) {
      border-color: rgba(16, 185, 129, 0.55);
      background: rgba(16, 185, 129, 0.10);
    }
    .model-menu-item.loaded:not(.active):hover {
      border-color: rgba(16, 185, 129, 0.75);
      background: rgba(16, 185, 129, 0.16);
    }
    .model-menu-item .name {
      font-weight: 700;
      font-size: 13px;
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .model-menu-item .meta {
      font-size: 12px;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .selected-model-text {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.02);
      color: var(--text-primary);
      font-size: 12px;
      width: fit-content;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .table-wrap {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      overflow: auto;
      min-height: 320px;
      max-height: none;
    }
    .form-control {
      width: 100%;
      padding: 0.425rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 0.675rem;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .record-card .row {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      flex: 1 1 auto;
      min-height: 0;
    }
    .record-card .table-wrap {
      flex: 1 1 auto;
      min-height: 0;
    }
    .hint {
      color: var(--text-secondary);
      font-size: 12px;
    }
    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .result-table th,
    .result-table td {
      border: 1px solid var(--border-color);
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    .result-table th {
      background: var(--sidebar-bg);
      color: var(--text-secondary);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .result-table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }
    .result-table tbody tr:hover {
      background: rgba(99, 102, 241, 0.08);
    }
    .result-table .empty {
      text-align: center;
      color: var(--text-secondary);
    }
    @media (max-width: 960px) {
      .content {
        grid-template-columns: 1fr;
      }
    }
    @media (min-width: 961px) {
      .content {
        grid-template-rows: minmax(0, 1fr);
      }
      .record-card {
        height: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <h1 class="title"><i class="fas fa-gauge-high"></i> <span data-i18n="page.benchmark_v2.title">Benchmark V2</span></h1>
    </div>
    <div class="content">
      <div class="left-col">
        <div class="card form-card">
          <div class="row">
            <label for="modelSelect" data-i18n="page.benchmark_v2.label.loaded_models">已加载模型</label>
            <select id="modelSelect" class="form-control"></select>
          </div>
          <div class="row">
            <label for="promptTokensInput" data-i18n="page.benchmark_v2.label.prompt_tokens">提示词长度</label>
            <input id="promptTokensInput" type="number" class="form-control" value="8192" min="1" />
          </div>
          <div class="row">
            <label for="maxTokensInput" data-i18n="page.benchmark_v2.label.max_tokens">输出最大token</label>
            <input id="maxTokensInput" type="number" class="form-control" value="256" min="1" />
          </div>
          <div class="actions">
            <button id="runBtn" class="btn btn-primary" data-i18n="page.benchmark_v2.action.run">开始测试</button>
            <button id="refreshBtn" class="btn" data-i18n="page.benchmark_v2.action.refresh_models">刷新模型</button>
          </div>
        </div>
        <div class="card all-models-card">
          <div class="all-models-header">
            <strong data-i18n="page.benchmark_v2.section.all_models">全部模型</strong>
            <span id="allModelsMeta" class="hint"></span>
          </div>
          <div id="allModelsList" class="model-menu"></div>
        </div>
      </div>
      <div class="card record-card">
        <div class="row" style="grid-template-columns: 1fr;">
          <strong data-i18n="page.benchmark_v2.section.records">测试记录</strong>
          <div id="selectedModelText" class="selected-model-text" style="display:none;"></div>
          <span id="statusText" class="hint"></span>
          <div class="table-wrap">
            <table class="result-table">
              <thead>
                <tr>
                  <th data-i18n="page.benchmark_v2.table.time">时间</th>
                  <th data-i18n="page.benchmark_v2.table.model">模型</th>
                  <th data-i18n="page.benchmark_v2.table.llamacpp">llama.cpp</th>
                  <th data-i18n="page.benchmark_v2.table.prompt_tokens">提示词长度</th>
                  <th data-i18n="page.benchmark_v2.table.prefill_speed">预填充速度（token/s）</th>
                  <th data-i18n="page.benchmark_v2.table.output_tokens">输出长度</th>
                  <th data-i18n="page.benchmark_v2.table.decode_speed">输出速度（token/s）</th>
                </tr>
              </thead>
              <tbody id="resultBody">
                <tr id="emptyRow">
                  <td class="empty" colspan="7" data-i18n="page.benchmark_v2.empty.no_records">暂无记录</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="/js/i18n.js"></script>
  <script>
    const els = {
      modelSelect: document.getElementById('modelSelect'),
      promptTokens: document.getElementById('promptTokensInput'),
      maxTokens: document.getElementById('maxTokensInput'),
      runBtn: document.getElementById('runBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      allModelsList: document.getElementById('allModelsList'),
      allModelsMeta: document.getElementById('allModelsMeta'),
      resultBody: document.getElementById('resultBody'),
      selectedModelText: document.getElementById('selectedModelText'),
      status: document.getElementById('statusText')
    };
    
    let allModels = [];
    let loadedModels = [];
    let loadedModelIds = new Set();
    let selectedModelId = null;
    let currentRecordKeys = new Set();
    let benchmarkAbortController = null;
    let isBenchmarkRunning = false;

    function t(key, fallback) {
      if (window.I18N && typeof window.I18N.t === 'function') {
        return window.I18N.t(key, fallback);
      }
      return fallback == null ? key : fallback;
    }

    function tf(key, params, fallback) {
      const template = t(key, fallback);
      if (!params || template == null) return template;
      let out = String(template);
      for (const k of Object.keys(params)) {
        out = out.split(`{${k}}`).join(String(params[k]));
      }
      return out;
    }

    function setStatus(text) {
      if (els.status) els.status.textContent = text || '';
    }
    
    function safeText(value) {
      return value == null ? '' : String(value);
    }

    function readRuntimeCtx() {
      const opt = els.modelSelect.selectedOptions && els.modelSelect.selectedOptions[0];
      if (!opt) return null;
      const raw = opt.dataset ? opt.dataset.runtimeCtx : null;
      const n = raw == null ? NaN : Number(raw);
      return Number.isFinite(n) && n > 0 ? n : null;
    }

    function validateTokenLimit() {
      const promptTokens = parseInt(els.promptTokens.value, 10);
      const maxTokens = parseInt(els.maxTokens.value, 10);
      const runtimeCtx = readRuntimeCtx();
      if (!runtimeCtx) return true;
      if (!Number.isFinite(promptTokens) || promptTokens <= 0) return false;
      if (!Number.isFinite(maxTokens) || maxTokens <= 0) return false;
      if (promptTokens + maxTokens > runtimeCtx) {
        setStatus(tf('page.benchmark_v2.status.token_sum_limit', { ctx: runtimeCtx }, `提示词长度 + 输出最大token 不能超过模型上下文长度 (${runtimeCtx})`));
        return false;
      }
      return true;
    }

    function getModelDisplayName(model) {
      const alias = model && typeof model.alias === 'string' ? model.alias.trim() : '';
      const name = model && typeof model.name === 'string' ? model.name.trim() : '';
      return alias || name || safeText(model && model.id);
    }

    function updateAllModelsMeta() {
      if (!els.allModelsMeta) return;
      const total = Array.isArray(allModels) ? allModels.length : 0;
      const loaded = loadedModelIds ? loadedModelIds.size : 0;
      els.allModelsMeta.textContent = tf('page.benchmark_v2.hint.models_total_loaded', { total, loaded }, `总计 ${total}，已加载 ${loaded}`);
    }

    function updateActiveAllModelItem() {
      if (!els.allModelsList) return;
      const btns = els.allModelsList.querySelectorAll('button[data-model-id]');
      btns.forEach((btn) => {
        const id = btn.dataset ? btn.dataset.modelId : '';
        btn.classList.toggle('active', !!selectedModelId && id === selectedModelId);
      });
    }

    function updateSelectedModelText() {
      if (!els.selectedModelText) return;
      const id = (selectedModelId || '').trim();
      if (!id) {
        els.selectedModelText.textContent = '';
        els.selectedModelText.style.display = 'none';
        return;
      }
      els.selectedModelText.textContent = tf('page.benchmark_v2.hint.selected_model', { model: id }, `模型：${id}`);
      els.selectedModelText.style.display = '';
    }

    function renderAllModelsList() {
      if (!els.allModelsList) return;
      els.allModelsList.innerHTML = '';

      const list = Array.isArray(allModels) ? allModels.slice() : [];
      list.sort((a, b) => {
        const na = getModelDisplayName(a).toLowerCase();
        const nb = getModelDisplayName(b).toLowerCase();
        return na.localeCompare(nb);
      });

      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = t('page.benchmark_v2.empty.no_models', '暂无模型');
        els.allModelsList.appendChild(empty);
        updateAllModelsMeta();
        return;
      }

      for (const m of list) {
        const id = safeText(m && m.id).trim();
        if (!id) continue;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'model-menu-item';
        btn.dataset.modelId = id;
        if (loadedModelIds && loadedModelIds.has(id)) {
          btn.classList.add('loaded');
        }

        const nameEl = document.createElement('div');
        nameEl.className = 'name';
        nameEl.textContent = getModelDisplayName(m);

        const metaEl = document.createElement('div');
        metaEl.className = 'meta';
        metaEl.textContent = loadedModelIds && loadedModelIds.has(id) ? `${id} · ${t('page.benchmark_v2.model.loaded', '已加载')}` : id;

        btn.appendChild(nameEl);
        btn.appendChild(metaEl);
        els.allModelsList.appendChild(btn);
      }
      updateAllModelsMeta();
      updateActiveAllModelItem();
    }

    function selectModelForRecords(modelId, options) {
      const id = (modelId || '').trim();
      if (!id) return;

      const prev = selectedModelId;
      selectedModelId = id;
      if (prev !== id) {
        currentRecordKeys = new Set();
      }
      updateActiveAllModelItem();
      updateSelectedModelText();

      const mode = options && options.mode ? options.mode : (prev === id ? 'append' : 'replace');
      loadBenchmarkRecords(id, { mode });
    }

    function formatNumber(value) {
      const n = Number(value);
      if (!Number.isFinite(n)) return '-';
      return n.toFixed(3).replace(/\.?0+$/, '');
    }

    function formatTimestamp(value) {
      if (value == null) return '-';
      const raw = String(value).trim();
      if (/^\d{8}_\d{6}$/.test(raw)) {
        return `${raw.slice(0, 4)}-${raw.slice(4, 6)}-${raw.slice(6, 8)} ${raw.slice(9, 11)}:${raw.slice(11, 13)}:${raw.slice(13, 15)}`;
      }
      const parsed = Date.parse(raw);
      if (!Number.isNaN(parsed)) {
        return new Date(parsed).toLocaleString();
      }
      return raw;
    }

    function clearResultRows(message) {
      if (!els.resultBody) return;
      els.resultBody.innerHTML = '';
      const tr = document.createElement('tr');
      tr.id = 'emptyRow';
      const td = document.createElement('td');
      td.className = 'empty';
      td.colSpan = 7;
      td.textContent = message || t('page.benchmark_v2.empty.no_records', '暂无记录');
      tr.appendChild(td);
      els.resultBody.appendChild(tr);
    }

    function appendRow(rowValues) {
      if (!els.resultBody) return;
      const emptyRow = document.getElementById('emptyRow');
      if (emptyRow) emptyRow.remove();
      const tr = document.createElement('tr');
      for (const v of rowValues) {
        const td = document.createElement('td');
        td.textContent = v == null || v === '' ? '-' : String(v);
        tr.appendChild(td);
      }
      els.resultBody.appendChild(tr);
    }

    function prependRow(rowValues) {
      if (!els.resultBody) return;
      const emptyRow = document.getElementById('emptyRow');
      if (emptyRow) emptyRow.remove();
      const tr = document.createElement('tr');
      for (const v of rowValues) {
        const td = document.createElement('td');
        td.textContent = v == null || v === '' ? '-' : String(v);
        tr.appendChild(td);
      }
      const first = els.resultBody.firstChild;
      if (first) els.resultBody.insertBefore(tr, first);
      else els.resultBody.appendChild(tr);
    }

    function normalizeRecordRow(record, fallbackModelId) {
      const timings = record && record.timings ? record.timings : null;
      const promptTokens = record && record.promptTokens != null ? record.promptTokens : (timings ? timings.prompt_n : null);
      const outputTokens = timings && timings.predicted_n != null ? timings.predicted_n : (record ? record.maxTokens : null);
      return [
        formatTimestamp(record && record.timestamp ? record.timestamp : null),
        (record && record.modelId) ? record.modelId : (fallbackModelId || '-'),
        record && record.llamaBinPath ? record.llamaBinPath : '-',
        promptTokens != null ? promptTokens : '-',
        formatNumber(timings && timings.prompt_per_second != null ? timings.prompt_per_second : null),
        outputTokens != null ? outputTokens : '-',
        formatNumber(timings && timings.predicted_per_second != null ? timings.predicted_per_second : null)
      ];
    }

    function recordKey(record, fallbackModelId) {
      const modelId = safeText(record && record.modelId ? record.modelId : fallbackModelId).trim();
      const ts = safeText(record && record.timestamp).trim();
      const pt = record && record.promptTokens != null ? String(record.promptTokens) : '';
      const mt = record && record.maxTokens != null ? String(record.maxTokens) : '';
      return `${modelId}|${ts}|${pt}|${mt}`;
    }
    
    async function fetchJson(url, options) {
      const resp = await fetch(url, options || {});
      const text = await resp.text();
      let json = null;
      try {
        json = JSON.parse(text);
      } catch (e) {
        json = { success: false, error: text || '请求失败' };
      }
      if (!resp.ok) {
        throw new Error((json && json.error) ? json.error : '请求失败');
      }
      return json;
    }
    
    async function loadLoadedModels() {
      setStatus(t('page.benchmark_v2.status.loading_models', '加载模型列表中…'));
      try {
        const prevValue = safeText(els.modelSelect.value).trim();
        const data = await fetchJson('/v1/models', { method: 'GET' });
        const models = Array.isArray(data && data.data) ? data.data : [];
        loadedModels = models;
        loadedModelIds = new Set(models.map(m => safeText(m && m.id).trim()).filter(Boolean));
        els.modelSelect.innerHTML = '';
        if (!models.length) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = t('page.benchmark_v2.option.no_loaded_models', '暂无已加载模型');
          els.modelSelect.appendChild(opt);
          els.modelSelect.disabled = true;
          setStatus(t('page.benchmark_v2.status.no_loaded_models', '没有已加载模型'));
          renderAllModelsList();
          return;
        }
        for (const m of models) {
          const opt = document.createElement('option');
          const id = m.id || '';
          opt.value = id;
          opt.textContent = id || t('common.unknown', '未知');
          if (m.runtimeCtx != null) {
            opt.dataset.runtimeCtx = m.runtimeCtx;
          }
          els.modelSelect.appendChild(opt);
        }
        if (prevValue && loadedModelIds.has(prevValue)) {
          els.modelSelect.value = prevValue;
        }
        els.modelSelect.disabled = false;
        setStatus(t('page.benchmark_v2.status.models_loaded', '模型列表已加载'));
        validateTokenLimit();
        renderAllModelsList();
      } catch (e) {
        setStatus(e.message || t('page.benchmark_v2.status.models_load_failed', '模型列表加载失败'));
      }
    }

    async function loadAllModels() {
      try {
        const data = await fetchJson('/api/models/list', { method: 'GET' });
        if (!data || data.success !== true) {
          throw new Error((data && data.error) ? data.error : t('page.benchmark_v2.status.models_load_failed', '模型列表加载失败'));
        }
        allModels = Array.isArray(data.models) ? data.models : [];
        renderAllModelsList();
      } catch (e) {
        allModels = [];
        renderAllModelsList();
        throw e;
      }
    }

    async function loadPageModels() {
      setStatus(t('page.benchmark_v2.status.loading_models', '加载模型列表中…'));
      const results = await Promise.allSettled([loadLoadedModels(), loadAllModels()]);
      const failed = results.find(r => r && r.status === 'rejected');
      if (failed && failed.reason) {
        setStatus(failed.reason.message || t('page.benchmark_v2.status.models_load_failed', '模型列表加载失败'));
      }

      const preferred = selectedModelId
        || (loadedModels && loadedModels[0] && loadedModels[0].id ? loadedModels[0].id : '')
        || (allModels && allModels[0] && allModels[0].id ? allModels[0].id : '');

      if (preferred) {
        selectModelForRecords(preferred, { mode: 'replace' });
      } else {
        clearResultRows();
        updateAllModelsMeta();
      }
    }

    async function loadBenchmarkRecords(modelId, options) {
      const id = (modelId || '').trim();
      if (!id) {
        clearResultRows();
        return;
      }
      const mode = options && options.mode ? options.mode : 'replace';
      setStatus(tf('page.benchmark_v2.status.loading_records', { model: id }, `加载记录中…`));
      try {
        const data = await fetchJson(`/api/v2/models/benchmark/get?modelId=${encodeURIComponent(id)}`, { method: 'GET' });
        if (!data || data.success !== true) {
          if (mode === 'replace') {
            clearResultRows();
            currentRecordKeys = new Set();
          }
          setStatus((data && data.error) ? data.error : t('page.benchmark_v2.status.no_records', '暂无记录'));
          return;
        }
        const records = data && data.data && Array.isArray(data.data.records) ? data.data.records : [];
        if (!records.length) {
          if (mode === 'replace') {
            clearResultRows();
            currentRecordKeys = new Set();
          }
          setStatus(t('page.benchmark_v2.status.no_records', '暂无记录'));
          return;
        }
        const sorted = records.slice().sort((a, b) => {
          const ta = (a && a.timestamp) ? String(a.timestamp) : '';
          const tb = (b && b.timestamp) ? String(b.timestamp) : '';
          return tb.localeCompare(ta);
        });

        if (mode === 'replace') {
          clearResultRows('');
          currentRecordKeys = new Set();
          for (const r of sorted) {
            appendRow(normalizeRecordRow(r, id));
            currentRecordKeys.add(recordKey(r, id));
          }
          setStatus(tf('page.benchmark_v2.status.records_loaded', { count: sorted.length }, `已加载 ${sorted.length} 条记录`));
          return;
        }

        const toAdd = [];
        for (const r of sorted) {
          const key = recordKey(r, id);
          if (!currentRecordKeys.has(key)) {
            toAdd.push(r);
          }
        }
        if (!toAdd.length) {
          setStatus(tf('page.benchmark_v2.status.records_loaded', { count: sorted.length }, `已加载 ${sorted.length} 条记录`));
          return;
        }
        const asc = toAdd.slice().sort((a, b) => {
          const ta = (a && a.timestamp) ? String(a.timestamp) : '';
          const tb = (b && b.timestamp) ? String(b.timestamp) : '';
          return ta.localeCompare(tb);
        });
        for (const r of asc) {
          prependRow(normalizeRecordRow(r, id));
          currentRecordKeys.add(recordKey(r, id));
        }
        setStatus(tf('page.benchmark_v2.status.records_appended', { count: asc.length }, `已追加 ${asc.length} 条记录`));
      } catch (e) {
        if (mode === 'replace') {
          clearResultRows();
          currentRecordKeys = new Set();
        }
        setStatus(e.message || t('page.benchmark_v2.status.records_load_failed', '记录加载失败'));
      }
    }
    
    async function runBenchmark() {
      if (isBenchmarkRunning) return;
      const modelId = (els.modelSelect.value || '').trim();
      const promptTokens = parseInt(els.promptTokens.value, 10);
      const maxTokens = parseInt(els.maxTokens.value, 10);
      if (!modelId) {
        setStatus(t('page.benchmark_v2.status.select_model', '请选择模型'));
        return;
      }
      if (!Number.isFinite(promptTokens) || promptTokens <= 0) {
        setStatus(t('page.benchmark_v2.status.prompt_tokens_gt0', '提示词长度必须大于0'));
        return;
      }
      if (!Number.isFinite(maxTokens) || maxTokens <= 0) {
        setStatus(t('page.benchmark_v2.status.max_tokens_gt0', '输出最大token必须大于0'));
        return;
      }
      if (!validateTokenLimit()) {
        return;
      }
      isBenchmarkRunning = true;
      benchmarkAbortController = new AbortController();
      if (els.runBtn) els.runBtn.textContent = t('page.benchmark_v2.action.cancel', '取消测试');
      setStatus(t('page.benchmark_v2.status.running', '执行中…'));
      try {
        const payload = {
          modelId,
          promptTokens,
          maxTokens
        };
        const data = await fetchJson('/api/v2/models/benchmark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: benchmarkAbortController.signal
        });
        setStatus(data.success ? t('page.benchmark_v2.status.done', '完成') : (data.error || t('page.benchmark_v2.status.failed', '失败')));
        if (data && data.success) {
          const mode = selectedModelId === modelId ? 'append' : 'replace';
          selectModelForRecords(modelId, { mode });
        }
      } catch (e) {
        if (e && e.name === 'AbortError') {
          setStatus(t('page.benchmark_v2.status.cancelled', '已取消'));
          return;
        }
        setStatus((e && e.message) ? e.message : t('page.benchmark_v2.status.request_failed', '请求失败'));
      } finally {
        isBenchmarkRunning = false;
        benchmarkAbortController = null;
        if (els.runBtn) els.runBtn.textContent = t('page.benchmark_v2.action.run', '开始测试');
      }
    }

    function cancelBenchmark() {
      if (!isBenchmarkRunning) return;
      if (benchmarkAbortController) {
        benchmarkAbortController.abort();
      }
      setStatus(t('page.benchmark_v2.status.cancelling', '取消中…'));
    }

    function handleRunButtonClick() {
      if (isBenchmarkRunning) {
        cancelBenchmark();
        return;
      }
      runBenchmark();
    }
    
    els.runBtn.addEventListener('click', handleRunButtonClick);
    els.refreshBtn.addEventListener('click', loadPageModels);
    els.modelSelect.addEventListener('change', () => {
      validateTokenLimit();
      selectModelForRecords(els.modelSelect.value, { mode: 'replace' });
    });
    els.promptTokens.addEventListener('input', validateTokenLimit);
    els.maxTokens.addEventListener('input', validateTokenLimit);
    if (els.allModelsList) {
      els.allModelsList.addEventListener('click', (e) => {
        const target = e && e.target ? e.target.closest('button[data-model-id]') : null;
        if (!target) return;
        const id = target.dataset ? target.dataset.modelId : '';
        selectModelForRecords(id, { mode: 'replace' });
      });
    }

    function initPage() {
      document.title = t('page.benchmark_v2.page_title', 'Benchmark V2');
      loadPageModels();
    }

    function initOnce() {
      window.removeEventListener('i18n:ready', initOnce);
      initPage();
    }

    window.addEventListener('i18n:ready', initOnce);
    if (window.I18N) initOnce();
  </script>
</body>
</html>
