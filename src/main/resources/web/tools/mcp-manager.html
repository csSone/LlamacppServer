<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="page.tools.mcp_manager.page_title">page.tools.mcp_manager.page_title</title>
  <link rel="stylesheet" href="../css/all.min.css" />
  <link href="../css/css2.css" rel="stylesheet" />
  <link rel="stylesheet" href="../css/index.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-color);
      color: var(--text-primary);
      font-family: "Microsoft YaHei", sans-serif;
    }

    .page {
      height: 100%;
      width: 100%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1 1 auto;
    }

    .top {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-color);
      background: var(--sidebar-bg);
      flex: 0 0 auto;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.2px;
      margin: 0;
    }

    .top-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btnx {
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 13px;
    }

    .btnx:active {
      transform: translateY(1px);
    }

    .btnx.primary {
      background: rgba(79, 70, 229, 0.12);
      border-color: rgba(79, 70, 229, 0.35);
    }

    .layout {
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-columns: 340px minmax(0, 1fr);
      gap: 12px;
      padding: 12px;
      overflow: hidden;
      width: 100%;
      min-width: 0;
    }

    .panel {
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      border-radius: 14px;
      overflow: hidden;
      min-height: 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 12px 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
      width: 100%;
      box-sizing: border-box;
      justify-content: space-between;
    }

    .panel-title {
      font-weight: 900;
      font-size: 13px;
      color: var(--text-primary);
      margin: 0;
    }

    .panel-actions {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      flex: 0 0 auto;
    }

    .btnx.danger {
      background: rgba(220, 38, 38, 0.12);
      border-color: rgba(220, 38, 38, 0.35);
    }

    .tools-head {
      flex: 1 1 auto;
      min-width: 0;
    }

    .panel-body {
      padding: 12px;
      overflow: auto;
      min-height: 0;
    }

    .muted {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .server-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .server-card {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: var(--card-bg);
      padding: 10px 10px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .server-card.selected {
      border-color: rgba(79, 70, 229, 0.65);
      background: rgba(79, 70, 229, 0.10);
    }

    .server-row1 {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .server-name {
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1 1 auto;
      min-width: 0;
    }

    .badge {
      flex: 0 0 auto;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      color: var(--text-secondary);
    }

    .url {
      font-size: 12px;
      color: var(--text-secondary);
      word-break: break-all;
      line-height: 1.35;
    }

    .tools-head {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tools-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .tools-title h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1 1 auto;
      min-width: 0;
    }

    .tools-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tool-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tool-card {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: var(--card-bg);
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tool-name {
      font-weight: 900;
      font-size: 13px;
      word-break: break-word;
    }

    .tool-desc {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.45;
    }

    .tool-schema {
      margin: 0;
      font-size: 12px;
      color: var(--text-primary);
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      overflow: auto;
      max-height: 240px;
    }

    dialog {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 0;
      width: min(920px, calc(100vw - 24px));
      inset: 0;
      margin: auto;
      max-height: min(720px, calc(100vh - 24px));
    }

    dialog::backdrop {
      background: rgba(17, 24, 39, 0.35);
    }

    .dlg {
      display: flex;
      flex-direction: column;
      min-height: 0;
      max-height: min(720px, calc(100vh - 24px));
    }

    .dlg-head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dlg-title {
      font-weight: 900;
      font-size: 13px;
      margin: 0;
    }

    .dlg-body {
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .dlg-body textarea {
      width: 100%;
      min-height: 320px;
      resize: vertical;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-color);
      color: var(--text-primary);
      padding: 10px 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      flex: 1 1 auto;
    }

    .dlg-body input {
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-color);
      color: var(--text-primary);
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
    }

    .dlg-foot {
      padding: 12px 14px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
    }

    .status {
      padding: 10px 12px;
      border-top: 1px solid var(--border-color);
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-color);
      flex: 0 0 auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <h1 class="title"><i class="fas fa-toolbox"></i> <span data-i18n="page.tools.mcp_manager.title">page.tools.mcp_manager.title</span></h1>
      <div class="top-actions">
        <button class="btnx" id="btnRefresh" type="button"><i class="fas fa-sync-alt"></i><span data-i18n="common.refresh">common.refresh</span></button>
        <button class="btnx primary" id="btnAddJson" type="button"><i class="fas fa-plus"></i><span data-i18n="page.tools.mcp_manager.action.add_json">page.tools.mcp_manager.action.add_json</span></button>
      </div>
    </div>

    <div class="layout">
      <section class="panel">
        <div class="panel-header">
          <h2 class="panel-title" data-i18n="page.tools.mcp_manager.section.servers">page.tools.mcp_manager.section.servers</h2>
          <span class="muted" id="serversCount"></span>
        </div>
        <div class="panel-body">
          <div class="server-list" id="serversList"></div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div class="tools-head">
            <div class="tools-title">
              <span class="badge" id="toolsCount" style="display:none;"></span>
              <h2 id="toolsTitle" data-i18n="page.tools.mcp_manager.section.tools">page.tools.mcp_manager.section.tools</h2>
              
            </div>
            <div class="tools-meta muted" id="serverMeta"></div>
          </div>
          <div class="panel-actions">
            <button class="btnx" id="btnRename" type="button" disabled><i class="fas fa-edit"></i><span data-i18n="page.tools.mcp_manager.action.rename">page.tools.mcp_manager.action.rename</span></button>
            <button class="btnx danger" id="btnDelete" type="button" disabled><i class="fas fa-trash"></i><span data-i18n="common.delete">common.delete</span></button>
          </div>
        </div>
        <div class="panel-body">
          <div class="tool-list" id="toolsList"></div>
        </div>
        <div class="status" id="statusBar"></div>
      </section>
    </div>
  </div>

  <dialog id="dlgAdd">
    <div class="dlg">
      <div class="dlg-head">
        <h3 class="dlg-title" data-i18n="page.tools.mcp_manager.dialog.add.title">page.tools.mcp_manager.dialog.add.title</h3>
        <div class="muted" style="margin-left:auto;">POST /api/mcp/add</div>
      </div>
      <div class="dlg-body">
        <div class="muted" data-i18n="page.tools.mcp_manager.dialog.add.tip">page.tools.mcp_manager.dialog.add.tip</div>
        <textarea id="jsonInput" spellcheck="false"></textarea>
      </div>
      <div class="dlg-foot">
        <button class="btnx" id="btnCancel" type="button" data-i18n="common.cancel">common.cancel</button>
        <button class="btnx primary" id="btnSubmit" type="button"><i class="fas fa-cloud-upload-alt"></i><span data-i18n="page.tools.mcp_manager.action.submit">page.tools.mcp_manager.action.submit</span></button>
      </div>
    </div>
  </dialog>

  <dialog id="dlgRename">
    <div class="dlg">
      <div class="dlg-head">
        <h3 class="dlg-title" data-i18n="page.tools.mcp_manager.dialog.rename.title">page.tools.mcp_manager.dialog.rename.title</h3>
        <div class="muted" style="margin-left:auto;">POST /api/mcp/rename</div>
      </div>
      <div class="dlg-body">
        <div class="muted" id="renameMeta"></div>
        <input id="renameInput" type="text" autocomplete="off" />
      </div>
      <div class="dlg-foot">
        <button class="btnx" id="btnRenameCancel" type="button" data-i18n="common.cancel">common.cancel</button>
        <button class="btnx primary" id="btnRenameSubmit" type="button"><i class="fas fa-save"></i><span data-i18n="common.save">common.save</span></button>
      </div>
    </div>
  </dialog>

  <script src="../js/i18n.js"></script>
  <script>
    const els = {
      serversList: document.getElementById('serversList'),
      toolsList: document.getElementById('toolsList'),
      toolsTitle: document.getElementById('toolsTitle'),
      toolsCount: document.getElementById('toolsCount'),
      serversCount: document.getElementById('serversCount'),
      serverMeta: document.getElementById('serverMeta'),
      statusBar: document.getElementById('statusBar'),
      btnRefresh: document.getElementById('btnRefresh'),
      btnAddJson: document.getElementById('btnAddJson'),
      dlgAdd: document.getElementById('dlgAdd'),
      jsonInput: document.getElementById('jsonInput'),
      btnCancel: document.getElementById('btnCancel'),
      btnSubmit: document.getElementById('btnSubmit'),
      btnDelete: document.getElementById('btnDelete'),
      btnRename: document.getElementById('btnRename'),
      dlgRename: document.getElementById('dlgRename'),
      renameMeta: document.getElementById('renameMeta'),
      renameInput: document.getElementById('renameInput'),
      btnRenameCancel: document.getElementById('btnRenameCancel'),
      btnRenameSubmit: document.getElementById('btnRenameSubmit')
    };

    const state = {
      servers: {},
      selectedUrl: null
    };

    function t(key, fallback) {
      if (window.I18N && typeof window.I18N.t === 'function') {
        return window.I18N.t(key, fallback);
      }
      return fallback == null ? key : fallback;
    }

    function tf(key, fallback, vars) {
      let out = t(key, fallback);
      if (!vars) return out;
      for (const k of Object.keys(vars)) {
        const v = vars[k];
        out = out.split('{' + k + '}').join(v == null ? '' : String(v));
      }
      return out;
    }

    function setStatus(text) {
      els.statusBar.textContent = (typeof text === 'string' && text.trim()) ? text.trim() : '';
    }

    function safeStr(v) {
      return (typeof v === 'string') ? v : '';
    }

    function isObj(v) {
      return v && typeof v === 'object' && !Array.isArray(v);
    }

    function fmtServerTitle(url, server) {
      const name = safeStr(server?.name).trim();
      return name ? name : url;
    }

    function getServerTools(server) {
      const tools = server?.tools;
      return Array.isArray(tools) ? tools : [];
    }

    function renderServers() {
      els.serversList.textContent = '';
      const entries = Object.entries(isObj(state.servers) ? state.servers : {});
      els.serversCount.textContent = entries.length ? `${entries.length}` : '0';

      if (!entries.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = t('page.tools.mcp_manager.empty.no_servers');
        els.serversList.appendChild(empty);
        renderTools(null, null);
        return;
      }

      const normalized = entries.map(([url, server]) => {
        const s = isObj(server) ? server : {};
        const displayName = fmtServerTitle(url, s);
        const toolsCount = getServerTools(s).length;
        return { url, server: s, displayName, toolsCount };
      }).sort((a, b) => a.displayName.localeCompare(b.displayName, 'zh-Hans-CN', { sensitivity: 'base' }));

      if (!state.selectedUrl || !state.servers[state.selectedUrl]) {
        state.selectedUrl = normalized[0].url;
      }

      for (const item of normalized) {
        const card = document.createElement('div');
        card.className = 'server-card' + (item.url === state.selectedUrl ? ' selected' : '');
        card.tabIndex = 0;
        card.role = 'button';
        card.addEventListener('click', () => {
          state.selectedUrl = item.url;
          renderServers();
          renderTools(item.url, item.server);
        });
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            state.selectedUrl = item.url;
            renderServers();
            renderTools(item.url, item.server);
          }
        });

        const row1 = document.createElement('div');
        row1.className = 'server-row1';

        const name = document.createElement('div');
        name.className = 'server-name';
        name.textContent = item.displayName;

        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = tf('page.tools.mcp_manager.server.tools_count', null, { n: item.toolsCount });

        row1.appendChild(name);
        row1.appendChild(badge);

        const url = document.createElement('div');
        url.className = 'url';
        url.textContent = item.url;

        card.appendChild(row1);
        card.appendChild(url);

        els.serversList.appendChild(card);
      }

      const selServer = state.selectedUrl ? state.servers[state.selectedUrl] : null;
      renderTools(state.selectedUrl, selServer);
    }

    function setServerActionEnabled(enabled) {
      els.btnDelete.disabled = !enabled;
      els.btnRename.disabled = !enabled;
    }

    function renderTools(url, server) {
      els.toolsList.textContent = '';
      els.serverMeta.textContent = '';
      els.toolsCount.style.display = 'none';

      if (!url || !isObj(server)) {
        els.toolsTitle.textContent = t('page.tools.mcp_manager.section.tools');
        setServerActionEnabled(false);
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = t('page.tools.mcp_manager.empty.select_server');
        els.toolsList.appendChild(empty);
        return;
      }

      setServerActionEnabled(true);
      const serverName = safeStr(server?.name).trim();
      const title = serverName ? serverName : url;
      els.toolsTitle.textContent = title;

      const type = safeStr(server?.type).trim();
      const desc = safeStr(server?.description).trim();

      const metaParts = [];
      metaParts.push(tf('page.tools.mcp_manager.meta.url', null, { url }));
      if (type) metaParts.push(tf('page.tools.mcp_manager.meta.type', null, { type }));
      if (desc) metaParts.push(desc);
      els.serverMeta.textContent = metaParts.join(' Â· ');

      const tools = getServerTools(server);
      els.toolsCount.textContent = tf('page.tools.mcp_manager.server.tools_count', null, { n: tools.length });
      els.toolsCount.style.display = 'inline-flex';

      if (!tools.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = t('page.tools.mcp_manager.empty.no_tools');
        els.toolsList.appendChild(empty);
        return;
      }

      const normalized = tools.map(t => (isObj(t) ? t : {}))
        .filter(t => safeStr(t?.name).trim())
        .sort((a, b) => safeStr(a.name).localeCompare(safeStr(b.name), 'zh-Hans-CN', { sensitivity: 'base' }));

      for (const tool of normalized) {
        const card = document.createElement('div');
        card.className = 'tool-card';

        const name = document.createElement('div');
        name.className = 'tool-name';
        name.textContent = safeStr(tool.name).trim();

        const desc = safeStr(tool.description).trim();
        if (desc) {
          const d = document.createElement('div');
          d.className = 'tool-desc';
          d.textContent = desc;
          card.appendChild(name);
          card.appendChild(d);
        } else {
          card.appendChild(name);
        }

        const schema = tool.inputSchema ?? tool.parameters ?? null;
        if (schema) {
          const pre = document.createElement('pre');
          pre.className = 'tool-schema';
          try {
            pre.textContent = JSON.stringify(schema, null, 2);
          } catch {
            pre.textContent = String(schema);
          }
          card.appendChild(pre);
        }

        els.toolsList.appendChild(card);
      }
    }

    async function apiGetMcpTools() {
      const resp = await fetch('/api/mcp/tools', { method: 'GET' });
      const data = await resp.json().catch(() => null);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      if (!data || data.success !== true) {
        throw new Error(safeStr(data?.error) || t('common.request_failed'));
      }
      return isObj(data.data) ? data.data : {};
    }

    async function apiAddMcpJson(rawJson) {
      const resp = await fetch('/api/mcp/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: rawJson
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      if (!data || data.success !== true) {
        throw new Error(safeStr(data?.error) || t('common.request_failed'));
      }
      return data;
    }

    async function apiRemoveMcpServer(url) {
      const resp = await fetch('/api/mcp/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      if (!data || data.success !== true) {
        throw new Error(safeStr(data?.error) || t('common.request_failed'));
      }
      return data;
    }

    async function apiRenameMcpServer(url, name) {
      const resp = await fetch('/api/mcp/rename', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, name })
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status}`);
      }
      if (!data || data.success !== true) {
        throw new Error(safeStr(data?.error) || t('common.request_failed'));
      }
      return data;
    }

    async function refreshAll() {
      setStatus(t('page.tools.mcp_manager.status.loading'));
      try {
        const payload = await apiGetMcpTools();
        state.servers = isObj(payload.servers) ? payload.servers : {};
        renderServers();
        setStatus(tf('page.tools.mcp_manager.status.loaded', null, { n: Object.keys(state.servers).length }));
      } catch (e) {
        state.servers = {};
        state.selectedUrl = null;
        renderServers();
        setStatus(tf('page.tools.mcp_manager.status.load_failed', null, { message: e?.message || String(e) }));
      }
    }

    function openRenameDialog() {
      const url = state.selectedUrl;
      const server = url ? state.servers?.[url] : null;
      if (!url || !isObj(server)) {
        setStatus(t('page.tools.mcp_manager.empty.select_server'));
        return;
      }
      const currentName = safeStr(server?.name).trim();
      els.renameMeta.textContent = `url: ${url}`;
      els.renameInput.value = currentName || fmtServerTitle(url, server);
      if (typeof els.dlgRename.showModal === 'function') {
        els.dlgRename.showModal();
      } else {
        els.dlgRename.setAttribute('open', 'open');
      }
      setTimeout(() => {
        try {
          els.renameInput.focus();
          els.renameInput.select();
        } catch {}
      }, 0);
    }

    function closeRenameDialog() {
      if (typeof els.dlgRename.close === 'function') {
        els.dlgRename.close();
      } else {
        els.dlgRename.removeAttribute('open');
      }
    }

    async function submitRename() {
      const url = state.selectedUrl;
      const server = url ? state.servers?.[url] : null;
      if (!url || !isObj(server)) {
        setStatus(t('page.tools.mcp_manager.empty.select_server'));
        return;
      }
      const nextName = safeStr(els.renameInput.value).trim();
      if (!nextName) {
        setStatus(t('page.tools.mcp_manager.error.name_required'));
        return;
      }

      setStatus(t('page.tools.mcp_manager.status.saving_name'));
      els.btnRenameSubmit.disabled = true;
      try {
        await apiRenameMcpServer(url, nextName);
        closeRenameDialog();
        await refreshAll();
        setStatus(t('page.tools.mcp_manager.status.name_updated'));
      } catch (e) {
        setStatus(tf('page.tools.mcp_manager.status.save_failed', null, { message: e?.message || String(e) }));
      } finally {
        els.btnRenameSubmit.disabled = false;
      }
    }

    async function deleteSelectedServer() {
      const url = state.selectedUrl;
      const server = url ? state.servers?.[url] : null;
      if (!url || !isObj(server)) {
        setStatus(t('page.tools.mcp_manager.empty.select_server'));
        return;
      }
      const title = fmtServerTitle(url, server);
      const ok = window.confirm(tf('page.tools.mcp_manager.confirm.delete_server', null, { title, url }));
      if (!ok) return;

      setStatus(t('page.tools.mcp_manager.status.deleting'));
      els.btnDelete.disabled = true;
      els.btnRename.disabled = true;
      try {
        await apiRemoveMcpServer(url);
        state.selectedUrl = null;
        await refreshAll();
        setStatus(t('page.tools.mcp_manager.status.deleted'));
      } catch (e) {
        setStatus(tf('page.tools.mcp_manager.status.delete_failed', null, { message: e?.message || String(e) }));
      } finally {
        renderTools(state.selectedUrl, state.selectedUrl ? state.servers?.[state.selectedUrl] : null);
      }
    }

    function openDialog() {
      const example = {
        mcpServers: {
          ExampleServer: {
            type: "sse",
            isActive: true,
            name: t('page.tools.mcp_manager.example.server_name'),
            baseUrl: "https://example.com/sse",
            headers: {
              Authorization: "Bearer <your-token>"
            }
          }
        }
      };
      if (!safeStr(els.jsonInput.value).trim()) {
        els.jsonInput.value = JSON.stringify(example, null, 2);
      }
      if (typeof els.dlgAdd.showModal === 'function') {
        els.dlgAdd.showModal();
      } else {
        els.dlgAdd.setAttribute('open', 'open');
      }
    }

    function closeDialog() {
      if (typeof els.dlgAdd.close === 'function') {
        els.dlgAdd.close();
      } else {
        els.dlgAdd.removeAttribute('open');
      }
    }

    async function submitJson() {
      const raw = safeStr(els.jsonInput.value);
      if (!raw.trim()) {
        setStatus(t('page.tools.mcp_manager.error.json_empty'));
        return;
      }
      try {
        JSON.parse(raw);
      } catch (e) {
        setStatus(tf('page.tools.mcp_manager.error.json_parse_failed', null, { message: e?.message || String(e) }));
        return;
      }

      setStatus(t('page.tools.mcp_manager.status.submitting'));
      els.btnSubmit.disabled = true;
      try {
        await apiAddMcpJson(raw);
        closeDialog();
        await refreshAll();
        setStatus(t('page.tools.mcp_manager.status.added'));
      } catch (e) {
        setStatus(tf('page.tools.mcp_manager.status.add_failed', null, { message: e?.message || String(e) }));
      } finally {
        els.btnSubmit.disabled = false;
      }
    }

    els.btnRefresh.addEventListener('click', refreshAll);
    els.btnAddJson.addEventListener('click', openDialog);
    els.btnCancel.addEventListener('click', closeDialog);
    els.btnSubmit.addEventListener('click', submitJson);
    els.btnDelete.addEventListener('click', deleteSelectedServer);
    els.btnRename.addEventListener('click', openRenameDialog);
    els.btnRenameCancel.addEventListener('click', closeRenameDialog);
    els.btnRenameSubmit.addEventListener('click', submitRename);
    els.renameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitRename();
      }
    });

    function initOnce() {
      window.removeEventListener('i18n:ready', initOnce);
      refreshAll();
    }
    window.addEventListener('i18n:ready', initOnce);
    if (window.I18N) initOnce();
  </script>
</body>
</html>
