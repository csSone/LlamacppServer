<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama.cpp 模型管理系统</title>
    <link rel="stylesheet" href="css/all.min.css">
    <link href="css/css2.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="app-logo">
                <i class="fas fa-brain"></i>
                <span>Llama Manager</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="refreshModels(); return false;">
                <i class="fas fa-cubes"></i>
                <span>模型列表</span>
            </a>
            <a href="chat/completion.html" class="nav-item" target="_blank">
                <i class="fas fa-comments"></i>
                <span>对话界面</span>
            </a>
            <a href="chat/concurrency.html" class="nav-item" target="_blank">
                <i class="fas fa-bolt"></i>
                <span>压力测试</span>
            </a>
            <a href="download.html" class="nav-item">
                <i class="fas fa-download"></i>
                <span>下载管理</span>
            </a>
            <a href="#" class="nav-item" onclick="openConsoleModal(); return false;">
                <i class="fas fa-terminal"></i>
                <span>控制台日志</span>
            </a>
            <a href="#" class="nav-item" onclick="openSettingsModal(); return false;">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
            </a>
            <div style="flex: 1"></div>
             <a href="#" class="nav-item danger" onclick="shutdownService(); return false;">
                <i class="fas fa-power-off"></i>
                <span>停止服务</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                Llama.cpp Server<br>v1.0.0
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-area">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 class="page-title">模型管理</h1>
            <div class="top-actions">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="modelSearchInput" class="search-input" placeholder="搜索模型...">
                </div>
                <button class="btn btn-secondary" onclick="refreshModels()" title="刷新列表">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="content-scrollable">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="loadedModelsCount">0</h3>
                        <p>已加载模型</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalModelsCount">0</h3>
                        <p>模型总数</p>
                    </div>
                </div>
            </div>

            <!-- Model List -->
            <div class="model-list-container">
                <div class="model-list-header">
                    <h2>所有模型</h2>
                    <div style="margin-left: auto;">
                        <select id="modelSortSelect" class="form-control" style="padding: 4px 8px; width: auto; font-size: 0.875rem;" onchange="sortAndRenderModels()">
                            <option value="name_asc">名称 (A-Z)</option>
                            <option value="name_desc">名称 (Z-A)</option>
                            <option value="size_asc">文件大小 (小到大)</option>
                            <option value="size_desc">文件大小 (大到小)</option>
                            <option value="params_asc">参数量 (小到大)</option>
                            <option value="params_desc">参数量 (大到小)</option>
                        </select>
                    </div>
                </div>
                <div id="modelsList">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Model Modal -->
    <div class="modal" id="loadModelModal">
        <div class="modal-content load-model-modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-upload" id="modelActionModalIcon"></i> <span id="modelActionModalTitleText">加载模型</span></h3>
                <button class="modal-close" onclick="closeModal('loadModelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loadModelForm">
                    <!-- 左右两侧布局 -->
                    <div class="load-model-layout">
                        <!-- 左侧：模型ID、Llama.cpp 版本、设备选择 -->
                        <div id="basicParamsContainer">
                            <div class="form-group">
                                <label class="form-label" for="modelId">模型ID</label>
                                <input type="text" class="form-control" id="modelId" name="modelId" readonly style="background-color: #f3f4f6; display: none;">
                                <input type="text" class="form-control" id="modelName" name="modelName" readonly style="background-color: #f3f4f6;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="llamaBinPathSelect">Llama.cpp 版本</label>
                                <select class="form-control" id="llamaBinPathSelect" name="llamaBinPathSelect"></select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="mainGpuSelect">主GPU (main-gpu)</label>
                                <select class="form-control" id="mainGpuSelect" name="mg">
                                    <option value="-1">默认</option>
                                </select>
                                <small class="form-text">选择 llama.cpp 运行所使用的主要 GPU（INDEX，从 0 开始）</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">可用计算设备</label>
                                <small class="form-text">默认已勾选全部设备；取消勾选可排除设备</small>
                                <div id="deviceChecklist" style="border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0.75rem; max-height: 260px; overflow: auto;">
                                    <div class="settings-empty">请先选择 Llama.cpp 版本</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：全部的参数配置 -->
                        <div id="dynamicParamsContainer">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loadModelModal')">取消</button>
                <button class="btn btn-secondary" onclick="estimateVramAction()"><i class="fas fa-memory"></i> 估算显存</button>
                <button class="btn btn-primary" id="modelActionSubmitBtn" onclick="submitModelAction()">加载模型</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cog"></i> 系统设置</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section-header">
                    <div class="settings-section-title">
                        <i class="fas fa-sliders-h"></i>
                        <span>全局路径设置</span>
                    </div>
                    <div class="settings-section-subtitle">
                        配置模型根目录和已编译的 llama.cpp 路径，供模型加载与运行使用。
                    </div>
                </div>
                <div class="settings-grid">
                    <div class="settings-panel">
                        <div class="panel-header">
                            <i class="fas fa-folder-open"></i>
                            <span>模型目录</span>
                        </div>
                        <div class="panel-body">
                            <form id="settingsFormLeft">
                                <div class="form-group">
                                    <div class="settings-actions-row">
                                        <button type="button" class="btn btn-primary" onclick="openAddModelPathModal()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="modelPathListContainer" class="settings-list"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="settings-panel">
                        <div class="panel-header">
                            <i class="fas fa-microchip"></i>
                            <span>Llama.cpp 路径</span>
                        </div>
                        <div class="panel-body">
                            <form id="settingsFormRight">
                                <div class="form-group">
                                    <div class="settings-actions-row">
                                        <button type="button" class="btn btn-primary" onclick="openAddLlamaCppPathModal()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="llamaCppListContainer" class="settings-list"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存更改</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addModelPathModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">添加模型目录</h3>
                <button class="modal-close" onclick="closeModal('addModelPathModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">目录路径</label>
                    <input class="form-control" id="addModelPathInput" placeholder="/path/to/models">
                    <small class="form-text">支持多个模型根目录，将合并检索其中所有 GGUF 模型。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModelPathModal')">取消</button>
                <button class="btn btn-primary" onclick="addModelPath()">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addLlamaCppPathModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">添加 Llama.cpp 路径</h3>
                <button class="modal-close" onclick="closeModal('addLlamaCppPathModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">目录路径</label>
                    <input class="form-control" id="addLlamaCppPathInput" placeholder="/path/to/llama.cpp">
                    <small class="form-text">输入已编译的 llama.cpp 根目录路径。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addLlamaCppPathModal')">取消</button>
                <button class="btn btn-primary" onclick="addLlamaCppPath()">保存</button>
            </div>
        </div>
    </div>

    <!-- Console Modal -->
    <div class="modal" id="consoleModal">
        <div class="modal-content" style="max-width: 1000px; height: 85vh;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-terminal"></i> 控制台输出</h3>
                <button class="modal-close" onclick="closeModal('consoleModal')">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
                <div style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--border-color); background: #f8f9fa;">
                    <button class="btn btn-secondary btn-sm" id="refreshConsoleBtn"><i class="fas fa-sync-alt"></i> 刷新</button>
                    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
                        <input type="checkbox" id="autoRefreshConsole"> 自动刷新
                    </label>
                    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
                        间隔(ms)
                        <input class="form-control" type="number" id="intervalConsoleInput" value="2000" min="500" style="width:80px; padding: 4px 8px;">
                    </label>
                    <div id="consoleStatusText" style="font-size:12px; color:var(--text-secondary); margin-left:auto;"></div>
                </div>
                <div id="logContainer" style="flex: 1; overflow:auto; padding:16px; font-family:'Menlo', 'Monaco', 'Courier New', monospace; background:#0f172a; color:#e5e7eb; font-size: 0.875rem;">
                    <pre id="consoleContent" style="margin:0; white-space:pre-wrap; word-break:break-word;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('consoleModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="js/websocket.js"></script>
    <script src="js/console-modal.js"></script>
    <script>
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            initWebSocket();
            initModelSearch();
            loadParamConfig();
        });
        
        // --- 动态参数配置 ---
        let paramConfig = [];
        
        // 加载参数配置
        function loadParamConfig() {
            fetch('/api/models/param/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.params) {
                        paramConfig = data.params;
                        renderDynamicParams();
                    } else {
                        console.error('加载参数配置失败:', data.error || '未知错误');
                        document.getElementById('dynamicParamsContainer').innerHTML =
                            '<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">加载失败</div><div class="empty-state-text">无法加载参数配置</div></div>';
                    }
                })
                .catch(error => {
                    console.error('加载参数配置出错:', error);
                    document.getElementById('dynamicParamsContainer').innerHTML =
                        '<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">网络错误</div><div class="empty-state-text">无法连接到服务器</div></div>';
                });
        }
        
        // 渲染动态参数
        function renderDynamicParams() {
            const container = document.getElementById('dynamicParamsContainer');
            if (!container) return;
            
            // 按 sort 排序
            const sortedParams = [...paramConfig].sort((a, b) => (a.sort || 0) - (b.sort || 0));
            
            let html = '';
            
            // 渲染所有参数
            if (sortedParams.length > 0) {
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
                sortedParams.forEach(param => {
                    html += renderParamField(param, false);
                });
                html += '</div>';
            }
            
            // 添加额外参数输入框
            html += '<div class="form-group" style="margin-top: 1rem;">';
            html += '<label class="form-label" for="extraParams">额外参数</label>';
            html += '<textarea class="form-control" id="extraParams" name="extraParams" rows="2" placeholder="例如: --grp-attn-n 8 --grp-attn-w 512"></textarea>';
            html += '<small class="form-text">输入额外的命令行参数，用空格分隔</small>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // 渲染单个参数字段
        function renderParamField(param, isBasic) {
            const fieldName = param.fullName.replace(/^--/, '').replace(/^-/, '');
            const fieldId = 'param_' + fieldName;
            const displayName = param.name;
            const description = param.description || '';
            const defaultValue = param.defaultValue || '';
            const type = param.type || 'STRING';
            const values = param.values || [];
            
            let html = '';
            
            // 生成带 tooltip 的 label
            const labelHtml = description
                ? `<label class="form-label" for="${fieldId}">${displayName} <i class="fas fa-question-circle" style="color: #F1F1F1; cursor: help; margin-left: 4px;" title="${description}"></i></label>`
                : `<label class="form-label" for="${fieldId}">${displayName}</label>`;
            
            // 如果有 values，使用下拉选单
            if (values && values.length > 0) {
                html += '<div class="form-group">';
                html += labelHtml;
                html += `<select class="form-control" id="${fieldId}" name="${fieldName}">`;
                values.forEach(v => {
                    const selected = v === defaultValue ? 'selected' : '';
                    html += `<option value="${v}" ${selected}>${v}</option>`;
                });
                html += '</select>';
                html += '</div>';
            } else {
                // 根据 type 渲染不同的输入控件
                switch (type) {
                    case 'INTEGER':
                        html += '<div class="form-group">';
                        html += labelHtml;
                        html += `<input type="number" class="form-control" id="${fieldId}" name="${fieldName}" value="${defaultValue}">`;
                        html += '</div>';
                        break;
                        
                    case 'FLOAT':
                        html += '<div class="form-group">';
                        html += labelHtml;
                        html += `<input type="number" step="0.01" class="form-control" id="${fieldId}" name="${fieldName}" value="${defaultValue}">`;
                        html += '</div>';
                        break;
                        
                    case 'BOOLEAN':
                        html += '<div class="form-group">';
                        html += labelHtml;
                        html += `<select class="form-control" id="${fieldId}" name="${fieldName}">`;
                        html += `<option value="0" ${defaultValue === '0' || defaultValue === 'false' ? 'selected' : ''}>false</option>`;
                        html += `<option value="1" ${defaultValue === '1' || defaultValue === 'true' || defaultValue === 'on' ? 'selected' : ''}>true</option>`;
                        html += '</select>';
                        html += '</div>';
                        break;
                        
                    case 'LOGIC':
                        html += '<div class="form-group">';
                        html += labelHtml;
                        html += `<select class="form-control" id="${fieldId}" name="${fieldName}">`;
                        html += `<option value="0" ${defaultValue === '0' || defaultValue === 'false' ? 'selected' : ''}>false</option>`;
                        html += `<option value="1" ${defaultValue === '1' || defaultValue === 'true' ? 'selected' : ''}>true</option>`;
                        html += '</select>';
                        html += '</div>';
                        break;
                        
                    case 'STRING':
                    default:
                        html += '<div class="form-group">';
                        html += labelHtml;
                        html += `<input type="text" class="form-control" id="${fieldId}" name="${fieldName}" value="${defaultValue}">`;
                        html += '</div>';
                        break;
                }
            }
            
            return html;
        }

        function formatFileSize(size) {
            if (size < 1024) return size + ' B';
            if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
            if (size < 1024 * 1024 * 1024) return (size / (1024 * 1024)).toFixed(1) + ' MB';
            return (size / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function openSlotsModal(modelId, displayName) {
            const modalId = 'slotsModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content slots-modal">
                        <div class="modal-header">
                            <h3 class="modal-title">缓存管理 - ${displayName}</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">&times;</button>
                        </div>
                        <div class="modal-body" id="${modalId}Content">
                            <div style="padding: 12px;">加载中...</div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button>
                            <button class="btn btn-primary" onclick="saveSelectedSlot('${modelId}')">保存</button>
                            <button class="btn btn-primary" onclick="loadSelectedSlot('${modelId}')">读取</button>
                            <button class="btn btn-primary" onclick="fetchSlotsForModel('${modelId}')">刷新</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            modal.classList.add('show');
            fetchSlotsForModel(modelId);
        }

        function fetchSlotsForModel(modelId) {
            const container = document.getElementById('slotsModalContent');
            fetch(`/api/models/slots/get?modelId=${encodeURIComponent(modelId)}`)
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        const el = document.getElementById('slotsModalContent') || document.getElementById('slotsModal').querySelector('.modal-body');
                        if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">加载失败</div><div class="empty-state-text">${d.error || '未知错误'}</div></div>`;
                        return;
                    }
                    const slots = (d.data && d.data.slots) ? d.data.slots : [];
                    renderSlotsContent(slots);
                })
                .catch(e => {
                    const el = document.getElementById('slotsModalContent') || document.getElementById('slotsModal').querySelector('.modal-body');
                    if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">网络错误</div><div class="empty-state-text">${e.message || ''}</div></div>`;
                });
        }

        function saveSelectedSlot(modelId) {
            const selectEl = document.getElementById('slotSelect');
            const slots = window.__slotsData || [];
            if (!selectEl || !slots.length) {
                showToast('错误', '未找到可保存的Slot', 'error');
                return;
            }
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot && idx < 0) {
                showToast('错误', '未选择有效的Slot', 'error');
                return;
            }
            let slotId = slot && slot.id !== undefined ? slot.id : idx;
            slotId = parseInt(slotId, 10);
            if (Number.isNaN(slotId)) slotId = idx;
            fetch('/api/models/slots/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, slotId })
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    showToast('成功', '保存成功', 'success');
                } else {
                    showToast('错误', (res && res.error) ? res.error : '保存失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }
        
        function loadSelectedSlot(modelId) {
            const selectEl = document.getElementById('slotSelect');
            const slots = window.__slotsData || [];
            if (!selectEl || !slots.length) {
                showToast('错误', '未找到可读取的Slot', 'error');
                return;
            }
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot && idx < 0) {
                showToast('错误', '未选择有效的Slot', 'error');
                return;
            }
            let slotId = slot && slot.id !== undefined ? slot.id : idx;
            slotId = parseInt(slotId, 10);
            if (Number.isNaN(slotId)) slotId = idx;
            fetch('/api/models/slots/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, slotId })
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    showToast('成功', '读取成功', 'success');
                } else {
                    showToast('错误', (res && res.error) ? res.error : '读取失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }

        function renderSlotsContent(slots) {
            const modal = document.getElementById('slotsModal');
            const body = document.getElementById('slotsModalContent') || (modal ? modal.querySelector('.modal-body') : null);
            if (!body) return;
            if (!slots || !slots.length) {
                body.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-database"></i></div><div class="empty-state-title">无可用Slot</div><div class="empty-state-text">当前模型没有可用的处理槽位</div></div>`;
                return;
            }
            window.__slotsData = slots;
            const prevIndex = (() => {
                const sel = document.getElementById('slotSelect');
                if (sel && sel.value !== '') {
                    const v = parseInt(sel.value, 10);
                    if (!Number.isNaN(v)) return v;
                }
                return 0;
            })();
            let html = '';
            html += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">`;
            html += `<label class="form-label" for="slotSelect" style="margin:0;">选择 Slot</label>`;
            html += `<select class="form-control" id="slotSelect" style="max-width:320px;">`;
            slots.forEach((s, idx) => {
                const id = s.id !== undefined ? s.id : idx;
                const running = s.is_processing ? '处理中' : '空闲';
                const nctx = s.n_ctx !== undefined ? s.n_ctx : '';
                html += `<option value="${idx}">ID ${id} · ${running} · ctx ${nctx}</option>`;
            });
            html += `</select>`;
            html += `</div>`;
            html += `<pre id="slotJsonViewer" style="flex:1; min-height:0; overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>`;
            body.id = 'slotsModalContent';
            body.innerHTML = html;
            const selectEl = document.getElementById('slotSelect');
            if (selectEl) {
                const idx = Math.min(Math.max(prevIndex, 0), slots.length - 1);
                selectEl.selectedIndex = idx;
                selectEl.onchange = updateSlotJsonViewer;
            }
            updateSlotJsonViewer();
        }

        function updateSlotJsonViewer() {
            const slots = window.__slotsData || [];
            const selectEl = document.getElementById('slotSelect');
            const viewer = document.getElementById('slotJsonViewer');
            if (!selectEl || !viewer || !slots.length) return;
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot) {
                viewer.textContent = '';
                return;
            }
            try {
                viewer.textContent = JSON.stringify(slot, null, 2);
            } catch (e) {
                viewer.textContent = '';
            }
        }

        function showModelLoadingState(modelId) {
             let loadingToast = document.getElementById('loading-toast-' + modelId);
            if (!loadingToast) {
                const toastContainer = document.getElementById('toastContainer');
                const toastHtml = `
                    <div class="toast info" id="loading-toast-${modelId}">
                        <div class="toast-icon"><i class="fas fa-spinner fa-spin"></i></div>
                        <div class="toast-content"><div class="toast-title">加载中</div><div class="toast-message">正在加载...</div></div>
                    </div>`;
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            }
        }
        function removeModelLoadingState(modelId) {
            const el = document.getElementById('loading-toast-' + modelId);
            if (el) el.remove();
        }

        function stopModel(modelId) {
             fetch('/api/models/stop', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId })
            }).then(r => r.json()).then(d => {
                if (!d.success) showToast('错误', d.error, 'error');
            });
        }

        function viewModelDetails(modelId) {
            fetch(`/api/models/details?modelId=${modelId}`).then(r => r.json()).then(data => {
                if (data.success) {
                    const model = data.model;
                    window.__modelDetailModelId = modelId;
                    showModelDetailModal(model);
                } else { showToast('错误', data.error, 'error'); }
            });
        }
        
        function showModelDetailModal(model) {
            const modalId = 'modelDetailModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content model-detail"><div class="modal-header"><h3 class="modal-title">模型详情</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body" id="${modalId}Content"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button></div></div>`;
                document.body.appendChild(modal);
            }
            const content = document.getElementById(modalId + 'Content');
            let tabs = `<div style="display:flex; gap:8px; margin-bottom:12px;">` +
                        `<button class="btn btn-secondary" id="${modalId}TabInfo">概览</button>` +
                        `<button class="btn btn-secondary" id="${modalId}TabMetrics">metrics</button>` +
                        `<button class="btn btn-secondary" id="${modalId}TabProps">props</button>` +
                        `</div>`;
            let wrapperStart = `<div style="display:flex; flex-direction:column; height:60vh; min-height:60vh;">`;
            let bodyStart = `<div style="flex:1; min-height:0;">`;
            let infoPanel = `<div id="${modalId}InfoPanel" style="height:100%;">` +
                            `<div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px; height:100%; overflow:auto;">` +
                            `<div><strong>名称:</strong></div><div>${model.name}</div>` +
                            `<div><strong>路径:</strong></div><div style="word-break:break-all;">${model.path}</div>` +
                            `<div><strong>大小:</strong></div><div>${formatFileSize(model.size)}</div>` +
                            `${model.isLoaded ? `<div><strong>状态:</strong></div><div>已启动${model.port ? `（端口 ${model.port}）` : ''}</div>` : `<div><strong>状态:</strong></div><div>未启动</div>`}` +
                            `${model.startCmd ? `<div><strong>启动命令:</strong></div><div style="word-break:break-all; font-family: monospace;">${model.startCmd}</div>` : ``}` +
                            `${(() => { let s=''; if (model.metadata) { for (const [k,v] of Object.entries(model.metadata)) { s += `<div><strong>${k}:</strong></div><div style="word-break:break-all;">${v}</div>`; } } return s; })()}` +
                            `</div>` +
                            `</div>`;
            let metricsPanel = `<div id="${modalId}MetricsPanel" style="display:none; height:100%;">` +
                               `<div style="display:flex; gap:8px; margin-bottom:8px;">` +
                               `<button class="btn btn-primary" id="${modalId}MetricsFetchBtn">请求 metrics</button>` +
                               `</div>` +
                               `<pre id="${modalId}MetricsViewer" style="height:calc(100% - 48px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>` +
                               `</div>`;
            let propsPanel = `<div id="${modalId}PropsPanel" style="display:none; height:100%;">` +
                               `<div style="display:flex; gap:8px; margin-bottom:8px;">` +
                               `<button class="btn btn-primary" id="${modalId}PropsFetchBtn">请求 props</button>` +
                               `</div>` +
                               `<pre id="${modalId}PropsViewer" style="height:calc(100% - 48px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>` +
                               `</div>`;
            let bodyEnd = `</div>`;
            let wrapperEnd = `</div>`;
            content.innerHTML = wrapperStart + tabs + bodyStart + infoPanel + metricsPanel + propsPanel + bodyEnd + wrapperEnd;
            modal.classList.add('show');
            const tabInfo = document.getElementById(modalId + 'TabInfo');
            const tabMetrics = document.getElementById(modalId + 'TabMetrics');
            const tabProps = document.getElementById(modalId + 'TabProps');
            const fetchBtn = document.getElementById(modalId + 'MetricsFetchBtn');
            const fetchPropsBtn = document.getElementById(modalId + 'PropsFetchBtn');
            if (tabInfo) tabInfo.onclick = () => openModelDetailTab('info');
            if (tabMetrics) tabMetrics.onclick = () => { openModelDetailTab('metrics'); loadModelMetrics(); };
            if (tabProps) tabProps.onclick = () => { openModelDetailTab('props'); loadModelProps(); };
            if (fetchBtn) fetchBtn.onclick = () => loadModelMetrics();
            if (fetchPropsBtn) fetchPropsBtn.onclick = () => loadModelProps();
            openModelDetailTab('info');
        }
        
        function openModelDetailTab(tab) {
            const modalId = 'modelDetailModal';
            const info = document.getElementById(modalId + 'InfoPanel');
            const metrics = document.getElementById(modalId + 'MetricsPanel');
            const props = document.getElementById(modalId + 'PropsPanel');
            const btnInfo = document.getElementById(modalId + 'TabInfo');
            const btnMetrics = document.getElementById(modalId + 'TabMetrics');
            const btnProps = document.getElementById(modalId + 'TabProps');
            if (info) info.style.display = tab === 'info' ? '' : 'none';
            if (metrics) metrics.style.display = tab === 'metrics' ? '' : 'none';
            if (props) props.style.display = tab === 'props' ? '' : 'none';
            if (btnInfo) { btnInfo.classList.remove('btn-primary'); btnInfo.classList.add(tab === 'info' ? 'btn-primary' : 'btn-secondary'); }
            if (btnMetrics) { btnMetrics.classList.remove('btn-primary'); btnMetrics.classList.add(tab === 'metrics' ? 'btn-primary' : 'btn-secondary'); }
            if (btnProps) { btnProps.classList.remove('btn-primary'); btnProps.classList.add(tab === 'props' ? 'btn-primary' : 'btn-secondary'); }
        }
        
        function loadModelMetrics() {
            const modelId = window.__modelDetailModelId;
            const viewer = document.getElementById('modelDetailModalMetricsViewer');
            if (!modelId || !viewer) return;
            viewer.textContent = '加载中...';
            fetch('/api/models/metrics?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(res => {
                    const d = res && res.success ? res.data : null;
                    const metrics = d && d.metrics ? d.metrics : null;
                    viewer.textContent = metrics ? JSON.stringify(metrics, null, 2) : JSON.stringify(res, null, 2);
                })
                .catch(() => {
                    viewer.textContent = '请求失败';
                });
        }
        
        function loadModelProps() {
            const modelId = window.__modelDetailModelId;
            const viewer = document.getElementById('modelDetailModalPropsViewer');
            if (!modelId || !viewer) return;
            viewer.textContent = '加载中...';
            fetch('/api/models/props?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(res => {
                    const d = res && res.success ? res.data : null;
                    const props = d && d.props ? d.props : null;
                    viewer.textContent = props ? JSON.stringify(props, null, 2) : JSON.stringify(res, null, 2);
                })
                .catch(() => {
                    viewer.textContent = '请求失败';
                });
        }
        // 关闭对话框
        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('show');
            if (id === 'consoleModal') stopConsoleAuto();
            if (id === 'loadModelModal') {
                document.getElementById('loadModelForm').reset();
                const btn = document.getElementById('modelActionSubmitBtn');
                if (btn) btn.disabled = false;
                setModelActionMode('load');
            }
        }
        
        // Window clicks
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'loadModelModal') {
                    if (window.__modelActionMode === 'config') closeModal('loadModelModal');
                } else {
                    closeModal(e.target.id);
                }
            }
        };

        function showToast(title, msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            const html = `
                <div class="toast ${type}" id="${id}">
                    <div class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i></div>
                    <div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${msg}</div></div>
                    <button class="toast-close" onclick="document.getElementById('${id}').remove()">&times;</button>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, 5000);
        }
        
        // Alias Logic
         function openAliasModal(modelId, originalName, currentAlias) {
            const modalId = 'aliasModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content" style="max-width:500px;"><div class="modal-header"><h3 class="modal-title">设置别名</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">原名</label><input class="form-control" id="aliasOriginalName" readonly></div><div class="form-group"><label class="form-label">别名</label><input class="form-control" id="aliasInput"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">取消</button><button class="btn btn-primary" onclick="submitAlias()">保存</button></div></div>`;
                document.body.appendChild(modal);
            }
            window.__aliasEditingModelId = modelId;
            document.getElementById('aliasOriginalName').value = originalName;
            document.getElementById('aliasInput').value = currentAlias;
            modal.classList.add('show');
        }
        function submitAlias() {
            const modelId = window.__aliasEditingModelId;
            const alias = document.getElementById('aliasInput').value;
             fetch('/api/model/alias/set', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, alias })
            }).then(r => r.json()).then(d => {
                if (d.success) { showToast('成功', '别名已保存', 'success'); closeModal('aliasModal'); refreshModels(); }
                else { showToast('错误', d.error, 'error'); }
            });
        }
        
        // Settings Logic (simplified)
        function openSettingsModal() {
            loadSettings();
            loadLlamaCppList();
            document.getElementById('settingsModal').classList.add('show');
        }
        function openAddModelPathModal() {
            document.getElementById('addModelPathModal').classList.add('show');
        }
        function openAddLlamaCppPathModal() {
            document.getElementById('addLlamaCppPathModal').classList.add('show');
        }
        function loadSettings() {
             fetch('/api/setting').then(r => r.json()).then(d => {
                if (d.success) {
                    const paths = (d.data && d.data.modelPaths) ? d.data.modelPaths : [];
                    window.__modelPaths = paths;
                    renderModelPathList();
                }
            });
        }
        function renderModelPathList() {
            const c = document.getElementById('modelPathListContainer');
            const paths = window.__modelPaths || [];
            if (!paths.length) {
                c.innerHTML = `<div class="settings-empty">尚未配置任何目录</div>`;
                return;
            }
            c.innerHTML = paths.map(p => `
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-item-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <span class="settings-item-text" title="${p}">${p}</span>
                    </div>
                    <button type="button" class="btn-icon danger" onclick="removeModelPathItem('${p.replace(/\\/g, '\\\\')}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        function addModelPath() {
            const v = document.getElementById('addModelPathInput').value.trim();
            if (v) {
                if (!window.__modelPaths) window.__modelPaths = [];
                window.__modelPaths.push(v);
                renderModelPathList();
                document.getElementById('addModelPathInput').value = '';
                closeModal('addModelPathModal');
            }
        }
        function removeModelPathItem(p) {
             window.__modelPaths = window.__modelPaths.filter(x => x !== p);
             renderModelPathList();
        }
        function saveSettings() {
            fetch('/api/setting', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ modelPaths: window.__modelPaths })
            }).then(r => r.json()).then(d => {
                if(d.success) { showToast('成功', '设置已保存', 'success'); closeModal('settingsModal'); refreshModels(); }
                else showToast('错误', d.error, 'error');
            });
        }
        // LlamaCpp Path logic similar to above... (Skipped for brevity in this manual rewrite, but should be included)
        function loadLlamaCppList() {
             fetch('/api/llamacpp/list').then(r => r.json()).then(d => {
                 if (d.success) {
                     window.__llamaPaths = d.data.paths || [];
                     renderLlamaPathList();
                 }
             });
        }
        function renderLlamaPathList() {
            const c = document.getElementById('llamaCppListContainer');
            const paths = window.__llamaPaths || [];
            if (!paths.length) {
                c.innerHTML = `<div class="settings-empty">尚未配置任何路径</div>`;
                return;
            }
            c.innerHTML = paths.map(p => `
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-item-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <span class="settings-item-text" title="${p}">${p}</span>
                    </div>
                    <button type="button" class="btn-icon danger" onclick="removeLlamaCppPathItem('${p.replace(/\\/g, '\\\\')}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        function addLlamaCppPath() {
             const v = document.getElementById('addLlamaCppPathInput').value.trim();
             if(v) {
                 fetch('/api/llamacpp/add', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:v}) })
                 .then(r=>r.json()).then(d=>{ if(d.success) { loadLlamaCppList(); document.getElementById('addLlamaCppPathInput').value=''; closeModal('addLlamaCppPathModal'); } else showToast('错误', d.error, 'error'); });
             }
        }
        function removeLlamaCppPathItem(p) {
             fetch('/api/llamacpp/remove', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:p}) })
                 .then(r=>r.json()).then(d=>{ if(d.success) loadLlamaCppList(); else showToast('错误', d.error, 'error'); });
        }
        
        function shutdownService() {
            if (confirm('确定要停止服务吗？')) {
                fetch('/api/shutdown', { method: 'POST' }).then(r=>r.json()).then(d => {
                    if (d.success) {
                        document.body.innerHTML = '<div style="width: 100%;display:flex;justify-content:center;align-items:center;height:100vh;"><h1>服务已停止</h1></div>';
                    }
                });
            }
        }
        
        function filterModels(k) {
            k = k.toLowerCase();
            document.querySelectorAll('.model-item').forEach(el => {
                const name = el.querySelector('.model-name').textContent.toLowerCase();
                el.style.display = name.includes(k) ? '' : 'none';
            });
        }
        function initModelSearch() {
            document.getElementById('modelSearchInput').addEventListener('input', (e) => filterModels(e.target.value));
        }
    </script>
    <script src="js/model-list.js"></script>
    <script src="js/model-action-modal.js"></script>
    <script src="js/model-benchmark.js"></script>
</body>
</html>
