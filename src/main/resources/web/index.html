<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama.cpp 模型管理系统</title>
    <link rel="stylesheet" href="css/all.min.css">
    <link href="css/css2.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca;
            --bg-color: #f3f4f6; /* Gray 100 */
            --sidebar-bg: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --card-bg: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.5rem;
            --transition-speed: 0.2s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 20;
            flex-shrink: 0;
            box-shadow: 2px 0 8px rgba(0,0,0,0.02);
        }

        .sidebar-header {
            height: 64px;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .app-logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        
        .app-logo i { font-size: 1.5rem; }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition-speed);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .nav-item i { width: 1.25rem; text-align: center; }

        .nav-item:hover {
            background-color: #f9fafb;
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background-color: #eff6ff; /* Blue 50 */
            color: var(--primary-color);
        }
        
        .nav-item.danger { color: var(--danger-color); }
        .nav-item.danger:hover { background-color: #fef2f2; }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: #f9fafb;
        }

        /* Main Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        .top-bar {
            height: 64px;
            padding: 0 2rem;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 10;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            width: 320px;
        }

        .search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            font-size: 0.875rem;
            outline: none;
            transition: all 0.2s;
            background-color: white;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Content */
        .content-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 0 2rem 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            transition: transform 0.2s;
        }
        
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: #eff6ff;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .stat-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Model List */
        .model-list-container {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
        }

        .model-list-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .model-list-header h2 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }

        .model-item {
            display: flex;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .model-item:last-child { border-bottom: none; }
        .model-item:hover { background-color: #f9fafb; }

        .model-fav-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-right: 0.75rem;
            font-size: 1rem;
        }
        .model-fav-btn:hover {
            border-color: var(--border-color);
            background: #ffffff;
            color: var(--warning-color);
        }
        .model-fav-btn.active {
            color: var(--warning-color);
        }

        .model-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.25rem;
            font-size: 1.5rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }
        .model-icon-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .model-details {
            flex: 1;
            min-width: 0;
            margin-right: 1rem;
        }

        .model-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .model-name:hover { color: var(--primary-color); }
        
        .vision-badge {
            color: var(--info-color);
            background-color: #eff6ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .model-meta {
            display: flex;
            gap: 1.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .model-meta span { display: flex; align-items: center; gap: 0.375rem; }
        .model-meta i { font-size: 0.875rem; opacity: 0.7; }

        .model-status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 100px;
            justify-content: center;
        }
        .status-running { background-color: #dcfce7; color: #166534; }
        .status-stopped { background-color: #f3f4f6; color: #4b5563; }
        .status-loading { background-color: #fef3c7; color: #92400e; }
        .status-loaded { background-color: #e0e7ff; color: #3730a3; }

        .model-actions {
            display: flex;
            gap: 0.75rem;
            margin-left: 1.5rem;
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .btn-icon:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-1px); }
        .btn-icon.danger:hover { border-color: var(--danger-color); color: var(--danger-color); background-color: #fef2f2; }
        .btn-icon.primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-icon.primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); color: white; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.2s ease-out;
            border: 1px solid var(--border-color);
        }
        .modal-content.model-detail { width: 95%; max-width: 1000px; }
        .modal-content.slots-modal { width: 95%; max-width: 1200px; max-height: 85vh; }
        .modal-content.load-model-modal { width: 95%; max-width: 1200px; }
        #slotsModal .modal-body { overflow: hidden; display: flex; flex-direction: column; }

        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        #settingsModal .modal-body {
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0 0 1rem 1rem;
        }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-control {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-text { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.375rem; }
        
        .form-check { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .form-check-input { margin-right: 0.5rem; width: 1rem; height: 1rem; }
        .form-check-label { font-size: 0.875rem; color: var(--text-primary); }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            gap: 0.5rem;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-secondary { background-color: white; border-color: var(--border-color); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #f9fafb; border-color: #d1d5db; }
        
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #dc2626; }

        /* Toasts */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            box-shadow: var(--shadow-md);
            padding: 1rem;
            border-radius: var(--radius);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            min-width: 320px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid transparent;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }

        .toast-icon { font-size: 1.25rem; margin-top: 2px; }
        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }

        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-primary); }
        .toast-message { font-size: 0.875rem; color: var(--text-secondary); }

        .toast-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; }
        .toast-close:hover { color: var(--text-primary); }

        /* Loading Spinner */
        .loading-spinner { display: flex; justify-content: center; align-items: center; padding: 2rem; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
        .empty-state-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
        .empty-state-text { font-size: 0.875rem; }
        
        /* Specific Styles */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; height: 100%; }
        .settings-panel { border: 1px solid var(--border-color); border-radius: 0.75rem; display: flex; flex-direction: column; overflow: hidden; background-color: #ffffff; box-shadow: 0 10px 15px -10px rgba(15, 23, 42, 0.15); }
        .panel-header { padding: 0.9rem 1rem; background: #f9fafb; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
        .panel-body { padding: 1rem; flex: 1; overflow-y: auto; }

        .settings-section-header { margin-bottom: 1rem; }
        .settings-section-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        .settings-section-subtitle { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }

        .settings-actions-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }

        .settings-list {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            min-height: 150px;
            max-height: 45vh;
            overflow-y: auto;
            background-color: #f9fafb;
        }

        #settingsModal .settings-grid {
            flex: 1;
            min-height: 0;
        }

        #settingsModal .panel-body {
            flex: 1;
            overflow: hidden;
        }

        #settingsModal #settingsFormLeft,
        #settingsModal #settingsFormRight {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #settingsModal #settingsFormLeft .form-group:last-child,
        #settingsModal #settingsFormRight .form-group:last-child {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #settingsModal .settings-list {
            flex: 1;
            max-height: none;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0.25rem;
            gap: 0.75rem;
        }

        .settings-item-main {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }

        .settings-item-icon {
            flex: 0 0 24px;
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            color: var(--primary-color);
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 0.75rem;
        }

        .settings-item-text {
            flex: 1 1 auto;
            font-size: 0.8125rem;
            color: var(--text-primary);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .settings-empty {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            padding: 0.5rem 0.25rem;
        }

        .settings-item .btn-icon {
            flex: 0 0 38px;
        }
        
        @media (max-width: 768px) {
            .settings-grid { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Mobile sidebar not implemented yet for brevity */
        }
        
        /* Console Log Styles */
        #logContainer::-webkit-scrollbar { width: 8px; height: 8px; }
        #logContainer::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #logContainer::-webkit-scrollbar-track { background: #1e293b; }
        /* Force Font Awesome spinner animation even when user prefers reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .fa-spin { animation: fa-spin 2s linear infinite !important; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="app-logo">
                <i class="fas fa-brain"></i>
                <span>Llama Manager</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="refreshModels(); return false;">
                <i class="fas fa-cubes"></i>
                <span>模型列表</span>
            </a>
            <a href="chat/completion.html" class="nav-item" target="_blank">
                <i class="fas fa-comments"></i>
                <span>对话界面</span>
            </a>
            <a href="download.html" class="nav-item">
                <i class="fas fa-download"></i>
                <span>下载管理</span>
            </a>
            <a href="#" class="nav-item" onclick="openConsoleModal(); return false;">
                <i class="fas fa-terminal"></i>
                <span>控制台日志</span>
            </a>
            <a href="#" class="nav-item" onclick="openSettingsModal(); return false;">
                <i class="fas fa-cog"></i>
                <span>系统设置</span>
            </a>
            <div style="flex: 1"></div>
             <a href="#" class="nav-item danger" onclick="shutdownService(); return false;">
                <i class="fas fa-power-off"></i>
                <span>停止服务</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                Llama.cpp Server<br>v1.0.0
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-area">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 class="page-title">模型管理</h1>
            <div class="top-actions">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="modelSearchInput" class="search-input" placeholder="搜索模型...">
                </div>
                <button class="btn btn-secondary" onclick="refreshModels()" title="刷新列表">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="content-scrollable">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="loadedModelsCount">0</h3>
                        <p>已加载模型</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalModelsCount">0</h3>
                        <p>模型总数</p>
                    </div>
                </div>
            </div>

            <!-- Model List -->
            <div class="model-list-container">
                <div class="model-list-header">
                    <h2>所有模型</h2>
                    <div style="margin-left: auto;">
                        <select id="modelSortSelect" class="form-control" style="padding: 4px 8px; width: auto; font-size: 0.875rem;" onchange="sortAndRenderModels()">
                            <option value="name_asc">名称 (A-Z)</option>
                            <option value="name_desc">名称 (Z-A)</option>
                            <option value="size_asc">文件大小 (小到大)</option>
                            <option value="size_desc">文件大小 (大到小)</option>
                            <option value="params_asc">参数量 (小到大)</option>
                            <option value="params_desc">参数量 (大到小)</option>
                        </select>
                    </div>
                </div>
                <div id="modelsList">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load Model Modal -->
    <div class="modal" id="loadModelModal">
        <div class="modal-content load-model-modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-upload"></i> 加载模型</h3>
                <button class="modal-close" onclick="closeModal('loadModelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loadModelForm">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; align-items: start;">
                        <div>
                            <div class="form-group">
                                <label class="form-label" for="modelId">模型ID</label>
                                <input type="text" class="form-control" id="modelId" name="modelId" readonly style="background-color: #f3f4f6; display: none;">
                                <input type="text" class="form-control" id="modelName" name="modelName" readonly style="background-color: #f3f4f6;">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="ctxSize">上下文大小 (ctx-size)</label>
                                <input type="number" class="form-control" id="ctxSize" name="ctxSize" min="1" placeholder="例如: 2048" value="32768">
                                <small class="form-text">模型的最大上下文长度</small>
                                <small class="form-text" id="ctxSizeVramHint" style="color: var(--success-color);"></small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="llamaBinPathSelect">Llama.cpp 版本</label>
                                <select class="form-control" id="llamaBinPathSelect" name="llamaBinPathSelect"></select>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="noMmap" name="noMmap" checked>
                                    <label class="form-check-label" for="noMmap">禁用内存映射 (no-mmap)</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="mlock" name="mlock">
                                    <label class="form-check-label" for="mlock">锁定内存 (mlock)</label>
                                </div>
                                <div class="form-check" id="enableVisionGroup" style="display: none;">
                                    <input type="checkbox" class="form-check-input" id="enableVision" name="enableVision" checked>
                                    <label class="form-check-label" for="enableVision">开启视觉</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="embedding" name="embedding">
                                    <label class="form-check-label" for="embedding">Embedding模式</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="reranking" name="reranking">
                                    <label class="form-check-label" for="reranking">Reranking模式</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="flashAttention" name="flashAttention" checked>
                                    <label class="form-check-label" for="flashAttention">Flash Attention</label>
                                </div>
                            </div>
                            <details style="margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem;">
                                <summary style="cursor: pointer; font-size: 0.875rem; color: var(--primary-color); font-weight: 500;">高级参数 (Temperature, Top-P, etc.)</summary>
                                <div style="padding-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label" for="temperature">Temperature</label>
                                        <input type="number" step="0.01" class="form-control" id="temperature" name="temperature" value="0.7">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="topP">Top P</label>
                                        <input type="number" step="0.01" class="form-control" id="topP" name="topP" value="0.95">
                                    </div>
                                     <div class="form-group">
                                        <label class="form-label" for="topK">Top K</label>
                                        <input type="number" class="form-control" id="topK" name="topK" value="40">
                                    </div>
                                     <div class="form-group">
                                        <label class="form-label" for="minP">Min P</label>
                                        <input type="number" step="0.01" class="form-control" id="minP" name="minP" value="0.05">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="presencePenalty">Presence Penalty</label>
                                        <input type="number" step="0.01" class="form-control" id="presencePenalty" name="presencePenalty" value="0.0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="repeatPenalty">Repeat Penalty</label>
                                        <input type="number" step="0.01" class="form-control" id="repeatPenalty" name="repeatPenalty" value="1.10">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="batchSize">批处理大小 (batch-size)</label>
                                        <input type="number" class="form-control" id="batchSize" name="batchSize" min="1" placeholder="例如: 512" value="1024">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="ubatchSize">微批处理 (ubatch-size)</label>
                                        <input type="number" class="form-control" id="ubatchSize" name="ubatchSize" min="1" placeholder="例如: 512" value="2048">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label" for="extraParams">额外参数</label>
                                    <textarea class="form-control" id="extraParams" name="extraParams" rows="2" placeholder="例如: --grp-attn-n 8 --grp-attn-w 512"></textarea>
                                    <small class="form-text">输入额外的命令行参数，用空格分隔</small>
                                </div>
                            </details>
                        </div>
                        <div>
                            <div class="form-group">
                                <label class="form-label" for="mainGpuSelect">主GPU (main-gpu)</label>
                                <select class="form-control" id="mainGpuSelect" name="mg">
                                    <option value="-1">默认</option>
                                </select>
                                <small class="form-text">选择 llama.cpp 运行所使用的主要 GPU（INDEX，从 0 开始）</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">可用计算设备</label>
                                <small class="form-text">默认已勾选全部设备；取消勾选可排除设备</small>
                                <div id="deviceChecklist" style="border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0.75rem; max-height: 260px; overflow: auto;">
                                    <div class="settings-empty">请先选择 Llama.cpp 版本</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loadModelModal')">取消</button>
                <button class="btn btn-secondary" onclick="estimateVram()"><i class="fas fa-memory"></i> 估算显存</button>
                <button class="btn btn-primary" onclick="submitLoadModel()">加载模型</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cog"></i> 系统设置</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section-header">
                    <div class="settings-section-title">
                        <i class="fas fa-sliders-h"></i>
                        <span>全局路径设置</span>
                    </div>
                    <div class="settings-section-subtitle">
                        配置模型根目录和已编译的 llama.cpp 路径，供模型加载与运行使用。
                    </div>
                </div>
                <div class="settings-grid">
                    <div class="settings-panel">
                        <div class="panel-header">
                            <i class="fas fa-folder-open"></i>
                            <span>模型目录</span>
                        </div>
                        <div class="panel-body">
                            <form id="settingsFormLeft">
                                <div class="form-group">
                                    <div class="settings-actions-row">
                                        <button type="button" class="btn btn-primary" onclick="openAddModelPathModal()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="modelPathListContainer" class="settings-list"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="settings-panel">
                        <div class="panel-header">
                            <i class="fas fa-microchip"></i>
                            <span>Llama.cpp 路径</span>
                        </div>
                        <div class="panel-body">
                            <form id="settingsFormRight">
                                <div class="form-group">
                                    <div class="settings-actions-row">
                                        <button type="button" class="btn btn-primary" onclick="openAddLlamaCppPathModal()"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="llamaCppListContainer" class="settings-list"></div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">取消</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存更改</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addModelPathModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">添加模型目录</h3>
                <button class="modal-close" onclick="closeModal('addModelPathModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">目录路径</label>
                    <input class="form-control" id="addModelPathInput" placeholder="/path/to/models">
                    <small class="form-text">支持多个模型根目录，将合并检索其中所有 GGUF 模型。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModelPathModal')">取消</button>
                <button class="btn btn-primary" onclick="addModelPath()">保存</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addLlamaCppPathModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">添加 Llama.cpp 路径</h3>
                <button class="modal-close" onclick="closeModal('addLlamaCppPathModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">目录路径</label>
                    <input class="form-control" id="addLlamaCppPathInput" placeholder="/path/to/llama.cpp">
                    <small class="form-text">输入已编译的 llama.cpp 根目录路径。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addLlamaCppPathModal')">取消</button>
                <button class="btn btn-primary" onclick="addLlamaCppPath()">保存</button>
            </div>
        </div>
    </div>

    <!-- Console Modal -->
    <div class="modal" id="consoleModal">
        <div class="modal-content" style="max-width: 1000px; height: 85vh;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-terminal"></i> 控制台输出</h3>
                <button class="modal-close" onclick="closeModal('consoleModal')">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
                <div style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--border-color); background: #f8f9fa;">
                    <button class="btn btn-secondary btn-sm" id="refreshConsoleBtn"><i class="fas fa-sync-alt"></i> 刷新</button>
                    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
                        <input type="checkbox" id="autoRefreshConsole"> 自动刷新
                    </label>
                    <label style="display:inline-flex; align-items:center; gap:6px; font-size: 14px;">
                        间隔(ms)
                        <input class="form-control" type="number" id="intervalConsoleInput" value="2000" min="500" style="width:80px; padding: 4px 8px;">
                    </label>
                    <div id="consoleStatusText" style="font-size:12px; color:var(--text-secondary); margin-left:auto;"></div>
                </div>
                <div id="logContainer" style="flex: 1; overflow:auto; padding:16px; font-family:'Menlo', 'Monaco', 'Courier New', monospace; background:#0f172a; color:#e5e7eb; font-size: 0.875rem;">
                    <pre id="consoleContent" style="margin:0; white-space:pre-wrap; word-break:break-word;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('consoleModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // --- WebSocket & Core Logic ---
        let websocket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectInterval = 5000;
        
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            try {
                websocket = new WebSocket(wsUrl);
                websocket.onopen = function(event) {
                    console.log('WebSocket Connected');
                    reconnectAttempts = 0;
                    websocket.send(JSON.stringify({ type: 'connect', message: 'Connected', timestamp: new Date().toISOString() }));
                };
                websocket.onmessage = function(event) {
                    handleWebSocketMessage(event.data);
                };
                websocket.onclose = function(event) {
                    console.log('WebSocket Closed');
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(initWebSocket, reconnectInterval);
                    }
                };
                websocket.onerror = function(error) { console.error('WebSocket Error:', error); };
            } catch (error) { console.error('WebSocket Init Failed:', error); }
        }
        
        function handleWebSocketMessage(message) {
            try {
                const data = JSON.parse(message);
                if (data.type) {
                    switch (data.type) {
                        case 'modelLoad': handleModelLoadEvent(data); break;
                        case 'modelStop': handleModelStopEvent(data); break;
                        case 'notification': showToast(data.title || '通知', data.message || '', data.level || 'info'); break;
                        case 'model_status': handleModelStatusUpdate(data); break;
                        case 'console':
                            if (document.getElementById('consoleModal').classList.contains('show')) {
                                let text = '';
                                if (typeof data.line64 === 'string') {
                                    const bin = atob(data.line64);
                                    const bytes = new Uint8Array(bin.length);
                                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                                    text = decoder.decode(bytes);
                                } else if (typeof data.line === 'string') {
                                    text = data.line;
                                }
                                if (text) appendLogLine(text);
                            }
                            break;
                    }
                }
            } catch (error) {}
        }
        
        function handleModelStatusUpdate(data) {
            if (data.modelId && data.status) {
                loadModels();
            }
        }
        
        function handleModelLoadEvent(data) {
            removeModelLoadingState(data.modelId);
            const action = data.success ? '成功' : '失败';
            showToast('模型加载', `模型 ${data.modelId} 加载${action}`, data.success ? 'success' : 'error');
            
            if (window.pendingModelLoad && window.pendingModelLoad.modelId === data.modelId) {
                closeModal('loadModelModal');
                const submitBtn = document.querySelector('#loadModelModal .btn-primary');
                if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = '加载模型'; }
                window.pendingModelLoad = null;
            }
            loadModels();
        }
        
        function handleModelStopEvent(data) {
            showToast('模型停止', `模型 ${data.modelId} 停止${data.success ? '成功' : '失败'}`, data.success ? 'success' : 'error');
            loadModels();
        }

        // --- Console Logic ---
        const logEl = document.getElementById('consoleContent');
        const logContainer = document.getElementById('logContainer');
        const consoleStatusText = document.getElementById('consoleStatusText');
        const refreshConsoleBtn = document.getElementById('refreshConsoleBtn');
        const autoRefreshConsole = document.getElementById('autoRefreshConsole');
        const intervalConsoleInput = document.getElementById('intervalConsoleInput');
        let consoleTimer = null;
        const decoder = new TextDecoder('utf-8');
        let pendingLogs = [];
        let flushScheduled = false;

        function openConsoleModal() {
            const modal = document.getElementById('consoleModal');
            modal.classList.add('show');
            fetchConsole();
            setTimeout(() => { logContainer.scrollTop = logContainer.scrollHeight; }, 100);
        }

        function nearBottom() { return Math.abs(logContainer.scrollHeight - logContainer.scrollTop - logContainer.clientHeight) < 50; }
        function scrollBottom() { logContainer.scrollTop = logContainer.scrollHeight; }

        async function fetchConsole() {
            const t0 = Date.now();
            if (consoleStatusText) consoleStatusText.textContent = '加载中...';
            try {
                const res = await fetch('/api/sys/console');
                const text = await res.text();
                const atBottom = nearBottom();
                if (logEl) logEl.textContent = text;
                if (atBottom && logContainer) logContainer.scrollTop = logContainer.scrollHeight;
                if (consoleStatusText) consoleStatusText.textContent = `已更新 · ${new Date().toLocaleTimeString()} · Size: ${text.length}`;
            } catch (e) {
                if (consoleStatusText) consoleStatusText.textContent = '加载失败';
            }
        }

        function appendLogLine(line) {
            if (!logEl) return;
            const clean = (line || '').replace(/\r/g, '');
            const withNl = clean.endsWith('\n') ? clean : clean + '\n';
            pendingLogs.push(withNl);
            if (!flushScheduled) {
                flushScheduled = true;
                requestAnimationFrame(() => {
                    flushScheduled = false;
                    const atBottom = nearBottom();
                    const chunk = pendingLogs.join('');
                    pendingLogs = [];
                    logEl.textContent += chunk;
                    if (atBottom) scrollBottom();
                });
            }
        }

        function startConsoleAuto() {
            stopConsoleAuto();
            const interval = Math.max(500, parseInt(intervalConsoleInput.value || '2000', 10));
            consoleTimer = setInterval(fetchConsole, interval);
        }
        function stopConsoleAuto() { if (consoleTimer) { clearInterval(consoleTimer); consoleTimer = null; } }

        if (refreshConsoleBtn) refreshConsoleBtn.addEventListener('click', fetchConsole);
        if (autoRefreshConsole) autoRefreshConsole.addEventListener('change', () => { if (autoRefreshConsole.checked) startConsoleAuto(); else stopConsoleAuto(); });
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadModels();
            initWebSocket();
            initModelSearch();
        });

        // --- Model Management ---
        function loadModels() {
            const modelsList = document.getElementById('modelsList');
            // modelsList.innerHTML = `<div class="loading-spinner"><div class="spinner"></div></div>`; // Don't wipe if refreshing quietly? No, user expects feedback.
            
            fetch('/api/models/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const allModels = data.models || [];
                        if (data.success) {
                                const totalCount = (allModels || []).length;
                                const el = document.getElementById('totalModelsCount');
                                if (el) el.textContent = totalCount;
                        }
                        return fetch('/api/models/loaded')
                            .then(response => response.json())
                            .then(loadedData => {
                        const loadedModels = loadedData.success ? (loadedData.models || []) : [];
                                const loadedModelIds = loadedModels.map(m => m.id);
                                const modelsWithStatus = allModels.map(model => {
                                    const isLoaded = loadedModelIds.includes(model.id);
                                    const loadedModel = loadedModels.find(m => m.id === model.id);
                                    return {
                                        ...model,
                                        isLoading: !!model.isLoading,
                                        isLoaded: isLoaded,
                                        status: isLoaded ? (loadedModel ? loadedModel.status : 'loaded') : 'stopped',
                                        port: isLoaded && loadedModel ? loadedModel.port : null
                                    };
                                });
                                currentModelsData = modelsWithStatus;
                                sortAndRenderModels();
                                if (loadedData.success) {
                                    const loadedCount = (loadedData.models || []).length;
                                    const el = document.getElementById('loadedModelsCount');
                                    if (el) el.textContent = loadedCount;
                                }
                            });
                    } else { throw new Error(data.error); }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modelsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="empty-state-title">加载失败</div>
                            <div class="empty-state-text">${error.message || '网络错误'}</div>
                            <button class="btn btn-primary" onclick="loadModels()">重试</button>
                        </div>
                    `;
                });
        }

        function getModelIcon(architecture) {
            const archName = (architecture || '').toLowerCase().replace(/[^a-z]/g, '');
            const iconMap = {
                'qwen': 'icon/qwen.png', 
                'glm': 'icon/glm.png', 
                'hunyuan': 'icon/hunyuan.png',
                'mistral': 'icon/mistral3.png', 
                'gpt': 'icon/openai.png', 
                'seed': 'icon/seed_oss.png',
                'llama': 'icon/llama.png', 
                'kimi': 'icon/kimi.png',
                'minimax': 'icon/minimax.png',
                'gemma3': 'icon/gemma3.png',
            };
            for (const [key, icon] of Object.entries(iconMap)) {
                if (archName.includes(key)) return icon;
            }
            return null;
        }

        let currentModelsData = [];

        function getParamsCount(name) {
            if (!name) return 0;
            name = name.toUpperCase();
            // Handle "8x7B" (MoE)
            const moeMatch = name.match(/(\d+)X(\d+(?:\.\d+)?)B/);
            if (moeMatch) {
                return parseFloat(moeMatch[1]) * parseFloat(moeMatch[2]);
            }
            // Handle "7B"
            const match = name.match(/(\d+(?:\.\d+)?)B/);
            if (match) {
                return parseFloat(match[1]);
            }
             // Handle "7M"
            const matchM = name.match(/(\d+(?:\.\d+)?)M/);
            if (matchM) {
                return parseFloat(matchM[1]) / 1000;
            }
            return 0;
        }

        function sortAndRenderModels() {
            const sortType = document.getElementById('modelSortSelect').value;
            if (!currentModelsData) return;
            
            const comparator = getModelSortComparator(sortType);
            const all = [...currentModelsData];

            const favourites = [];
            const nonFavourites = [];
            all.forEach(m => {
                if (m && m.favourite) favourites.push(m);
                else nonFavourites.push(m);
            });

            favourites.sort(comparator);
            nonFavourites.sort(comparator);

            renderModelsList([...favourites, ...nonFavourites]);
        }

        function getModelSortComparator(sortType) {
            return (a, b) => {
                const nameA = (a.alias || a.name || '').toLowerCase();
                const nameB = (b.alias || b.name || '').toLowerCase();
                const sizeA = a.size || 0;
                const sizeB = b.size || 0;
                const paramsA = getParamsCount(a.name);
                const paramsB = getParamsCount(b.name);

                switch (sortType) {
                    case 'name_asc': return nameA.localeCompare(nameB);
                    case 'name_desc': return nameB.localeCompare(nameA);
                    case 'size_asc': return sizeA - sizeB;
                    case 'size_desc': return sizeB - sizeA;
                    case 'params_asc': return paramsA - paramsB;
                    case 'params_desc': return paramsB - paramsA;
                    default: return 0;
                }
            };
        }

        function renderModelsList(models) {
            const modelsList = document.getElementById('modelsList');
            if (!models || models.length === 0) {
                modelsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-box-open"></i></div>
                        <div class="empty-state-title">没有模型</div>
                        <div class="empty-state-text">请在设置中添加模型目录</div>
                        <button class="btn btn-primary" onclick="openSettingsModal()">去设置</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            models.forEach(model => {
                const metadata = model.metadata || {};
                const architecture = metadata.architecture || '未知';
                const isLoading = !!model.isLoading;
                
                let status = model.status;
                let statusText = '已停止';
                let statusIcon = 'fa-stop-circle';
                let statusClass = 'status-stopped';
                
                if (isLoading) {
                    statusText = '加载中'; statusIcon = 'fa-spinner fa-spin'; statusClass = 'status-loading';
                } else if (model.isLoaded) {
                    statusText = status === 'running' ? '运行中' : '已加载';
                    statusIcon = status === 'running' ? 'fa-play-circle' : 'fa-check-circle';
                    statusClass = status === 'running' ? 'status-running' : 'status-loaded';
                }
                
                const modelIcon = getModelIcon(architecture);
                const displayName = (model.alias && model.alias.trim()) ? model.alias : model.name;
                const isFavourite = !!model.favourite;
                
                let actionButtons = '';
                if (isLoading) {
                    actionButtons = `<button class="btn-icon" disabled><i class="fas fa-spinner fa-spin"></i></button>`;
                } else if (model.isLoaded) {
                    if (status === 'running') {
                        actionButtons = `
                            <button class="btn-icon danger" onclick="stopModel('${model.id}')" title="停止"><i class="fas fa-stop"></i></button>
                            <button class="btn-icon" onclick="viewModelDetails('${model.id}')" title="详情"><i class="fas fa-info-circle"></i></button>
                            <button class="btn-icon" onclick="openModelBenchmarkList(decodeURIComponent('${encodeURIComponent(model.id)}'), decodeURIComponent('${encodeURIComponent(displayName)}'))" title="查看测试结果"><i class="fas fa-list"></i></button>
                            <button class="btn-icon" onclick="viewModelConfig('${model.id}')" title="查看配置"><i class="fas fa-cog"></i></button>
                            <button class="btn-icon" onclick="openSlotsModal(decodeURIComponent('${encodeURIComponent(model.id)}'), decodeURIComponent('${encodeURIComponent(displayName)}'))" title="缓存管理"><i class="fas fa-database"></i></button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn-icon" onclick="openModelBenchmarkList(decodeURIComponent('${encodeURIComponent(model.id)}'), decodeURIComponent('${encodeURIComponent(displayName)}'))" title="查看测试结果"><i class="fas fa-list"></i></button>
                        `;
                    }
                } else {
                    actionButtons = `
                        <button class="btn-icon primary" onclick="loadModel('${model.id}', '${model.name}')" title="加载"><i class="fas fa-play"></i></button>
                        <button class="btn-icon" onclick="viewModelDetails('${model.id}')" title="详情"><i class="fas fa-info-circle"></i></button>
                        <button class="btn-icon" onclick="openModelBenchmarkDialog(decodeURIComponent('${encodeURIComponent(model.id)}'), decodeURIComponent('${encodeURIComponent(displayName)}'))" title="性能测试"><i class="fas fa-rocket"></i></button>
                        <button class="btn-icon" onclick="openModelBenchmarkList(decodeURIComponent('${encodeURIComponent(model.id)}'), decodeURIComponent('${encodeURIComponent(displayName)}'))" title="查看测试结果"><i class="fas fa-list"></i></button>
                        <button class="btn-icon" onclick="viewModelConfig('${model.id}')" title="查看配置"><i class="fas fa-cog"></i></button>
                    `;
                }
                
                html += `
                    <div class="model-item">
                        <button class="model-fav-btn ${isFavourite ? 'active' : ''}" onclick="toggleFavouriteModel(event, decodeURIComponent('${encodeURIComponent(model.id)}'))" title="${isFavourite ? '取消喜好' : '标记喜好'}">
                            <i class="${isFavourite ? 'fas' : 'far'} fa-star"></i>
                        </button>
                        <div class="model-icon-wrapper">
                            ${modelIcon ? `<img src="${modelIcon}" alt="${architecture}">` : `<i class="fas fa-brain"></i>`}
                        </div>
                        <div class="model-details">
                            <div class="model-name" title="${model.name}" onclick="openAliasModal(decodeURIComponent('${encodeURIComponent(model.id)}'), decodeURIComponent('${encodeURIComponent(model.name)}'), decodeURIComponent('${encodeURIComponent(model.alias || '')}'))">
                                ${displayName}
                                ${model.isMultimodal ? '<span class="vision-badge"><i class="fas fa-image"></i></span>' : ''}
                            </div>
                            <div class="model-meta">
                                <span><i class="fas fa-layer-group"></i> ${architecture}</span>
                                <span><i class="fas fa-hdd"></i> ${formatFileSize(model.size)}</span>
                                ${model.port ? `<span><i class="fas fa-network-wired"></i> ${model.port}</span>` : ''}
                            </div>
                        </div>
                        <div class="model-status-badge ${statusClass}">
                            <i class="fas ${statusIcon}"></i> <span>${statusText}</span>
                        </div>
                        <div class="model-actions">${actionButtons}</div>
                    </div>
                `;
            });
            modelsList.innerHTML = html;
            const input = document.getElementById('modelSearchInput');
            if (input) filterModels(input.value);
        }

        function toggleFavouriteModel(event, modelId) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const idx = (currentModelsData || []).findIndex(m => m && m.id === modelId);
            if (idx < 0) return;

            const prev = !!currentModelsData[idx].favourite;
            currentModelsData[idx].favourite = !prev;
            sortAndRenderModels();

            fetch('/api/models/favourite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId })
            })
                .then(r => r.json())
                .then(res => {
                    if (!res || !res.success) {
                        throw new Error((res && res.error) ? res.error : '设置喜好失败');
                    }
                    const favourite = !!(res.data && res.data.favourite);
                    const i = (currentModelsData || []).findIndex(m => m && m.id === modelId);
                    if (i >= 0) {
                        currentModelsData[i].favourite = favourite;
                        sortAndRenderModels();
                    }
                })
                .catch(err => {
                    const i = (currentModelsData || []).findIndex(m => m && m.id === modelId);
                    if (i >= 0) {
                        currentModelsData[i].favourite = prev;
                        sortAndRenderModels();
                    }
                    showToast('错误', err && err.message ? err.message : '网络错误', 'error');
                });
        }

        function refreshModels() {
            showToast('提示', '正在刷新模型列表', 'info');
            fetch('/api/models/refresh')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadModels();
                    } else {
                        throw new Error(data.error || '刷新模型列表失败');
                    }
                })
                .catch(error => {
                    showToast('错误', error.message || '网络错误，请稍后重试', 'error');
                    loadModels();
                });
        }

        function formatFileSize(size) {
            if (size < 1024) return size + ' B';
            if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
            if (size < 1024 * 1024 * 1024) return (size / (1024 * 1024)).toFixed(1) + ' MB';
            return (size / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        function loadModel(modelId, modelName) {
            document.getElementById('modelId').value = modelId;
            document.getElementById('modelName').value = modelName;
            const hint = document.getElementById('ctxSizeVramHint');
            if (hint) hint.textContent = '';
            window.__loadModelSelectedDevices = ['All'];

            const currentModel = (currentModelsData || []).find(m => m && m.id === modelId);
            const isVisionModel = !!(currentModel && (currentModel.isMultimodal || currentModel.mmproj));
            const enableVisionGroup = document.getElementById('enableVisionGroup');
            if (enableVisionGroup) enableVisionGroup.style.display = isVisionModel ? '' : 'none';
            
            fetch(`/api/models/config/get?modelId=${encodeURIComponent(modelId)}`)
                .then(r => r.json()).then(data => {
                    const config = (data.success && data.data) ? data.data.config : {};
                    if (config) {
                        if (config.ctxSize) document.getElementById('ctxSize').value = config.ctxSize;
                        if (config.batchSize) document.getElementById('batchSize').value = config.batchSize;
                        if (config.ubatchSize) document.getElementById('ubatchSize').value = config.ubatchSize;
                        if (config.temperature) document.getElementById('temperature').value = config.temperature;
                        if (config.topP) document.getElementById('topP').value = config.topP;
                        if (config.topK) document.getElementById('topK').value = config.topK;
                        if (config.minP) document.getElementById('minP').value = config.minP;
                        if (config.presencePenalty || config.presencePenalty === 0) document.getElementById('presencePenalty').value = config.presencePenalty;
                        if (config.repeatPenalty || config.repeatPenalty === 0) document.getElementById('repeatPenalty').value = config.repeatPenalty;
                        document.getElementById('noMmap').checked = !!config.noMmap;
                        document.getElementById('mlock').checked = !!config.mlock;
                        document.getElementById('embedding').checked = !!config.embedding;
                        document.getElementById('reranking').checked = !!config.reranking;
                        document.getElementById('flashAttention').checked = config.flashAttention !== undefined ? config.flashAttention : true;
                        document.getElementById('extraParams').value = config.extraParams || '';
                        const enableVisionEl = document.getElementById('enableVision');
                        if (enableVisionEl) enableVisionEl.checked = config.enableVision !== undefined ? !!config.enableVision : true;
                        window.__loadModelSelectedDevices = normalizeDeviceSelection(config.device);
                        window.__loadModelMainGpu = normalizeMainGpu(config.mg);
                    }
                    
                    fetch('/api/llamacpp/list').then(r => r.json()).then(listData => {
                        const select = document.getElementById('llamaBinPathSelect');
                        const paths = (listData && listData.success && listData.data) ? (listData.data.paths || []) : [];
                        select.innerHTML = paths.map(p => `<option value="${p}">${p}</option>`).join('');
                        
                         // Prefer existing config
                        if (config.llamaBinPath) {
                             select.value = config.llamaBinPath;
                        } else {
                            // Or fetch default setting
                            fetch('/api/setting').then(rs => rs.json()).then(s => {
                                const currentBin = (s && s.success && s.data) ? s.data.llamaBin : null;
                                if (currentBin && select) select.value = currentBin;
                            }).catch(()=>{});
                        }
                        
                        select.onchange = function() { loadDeviceList(); };
                        
                        // Load device list initially
                        loadDeviceList();
                    }).finally(() => {
                         const modal = document.getElementById('loadModelModal');
                         modal.classList.add('show');
                    });
                });
        }

        function submitLoadModel() {
            const form = document.getElementById('loadModelForm');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (['ctxSize', 'batchSize', 'ubatchSize', 'topK'].includes(key)) data[key] = parseInt(value);
                else if (['temperature', 'topP', 'minP', 'presencePenalty'].includes(key)) data[key] = parseFloat(value);
                else if (['repeatPenalty'].includes(key)) data[key] = parseFloat(value);
                else if (['noMmap', 'mlock', 'embedding', 'reranking'].includes(key)) data[key] = value === 'on';
                else data[key] = value;
            });
            // Checkbox fix
            data.noMmap = document.getElementById('noMmap').checked;
            data.mlock = document.getElementById('mlock').checked;
            data.embedding = document.getElementById('embedding').checked;
            data.reranking = document.getElementById('reranking').checked;
            data.flashAttention = document.getElementById('flashAttention').checked;
            data.llamaBinPath = document.getElementById('llamaBinPathSelect').value;
            data.extraParams = document.getElementById('extraParams').value;
            const enableVisionEl = document.getElementById('enableVision');
            if (enableVisionEl) data.enableVision = enableVisionEl.checked;

            const selectedDevices = getSelectedDevicesFromChecklist();
            const availableCount = window.__availableDeviceCount;
            const isAllSelected = Number.isFinite(availableCount) && availableCount > 0 && selectedDevices.length === availableCount;
            if (isAllSelected) data.device = ['All'];
            else data.device = selectedDevices;
            data.mg = getSelectedMainGpu();

            const submitBtn = document.querySelector('#loadModelModal .btn-primary');
            submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';

            fetch('/api/models/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if (res.success) {
                    if (res.data && res.data.async) {
                        showToast('模型加载中', '正在后台加载...', 'info');
                        showModelLoadingState(data.modelId);
                        window.pendingModelLoad = { modelId: data.modelId };
                        loadModels();
                    } else {
                        showToast('成功', '模型加载成功', 'success');
                        closeModal('loadModelModal');
                        loadModels();
                    }
                } else {
                    showToast('错误', res.error || '加载失败', 'error');
                    submitBtn.disabled = false; submitBtn.innerHTML = '加载模型';
                }
            }).catch(e => {
                showToast('错误', '网络请求失败', 'error');
                submitBtn.disabled = false; submitBtn.innerHTML = '加载模型';
            });
        }

        function estimateVram() {
            const modelId = document.getElementById('modelId').value;
            if (!modelId) {
                showToast('错误', '请先选择模型', 'error');
                return;
            }
            const ctxSize = parseInt(document.getElementById('ctxSize').value || '2048', 10);
            const batchSize = parseInt(document.getElementById('batchSize').value || '512', 10);
            const ubatch = parseInt(document.getElementById('ubatchSize').value || '0', 10);
            const flashAttention = document.getElementById('flashAttention').checked;
            const enableVisionEl = document.getElementById('enableVision');
            const payload = {
                modelId,
                ctxSize,
                batchSize: isNaN(batchSize) || batchSize <= 0 ? null : batchSize,
                ubatchSize: isNaN(ubatch) || ubatch <= 0 ? null : ubatch,
                flashAttention,
                enableVision: enableVisionEl ? enableVisionEl.checked : true
            };
            fetch('/api/models/vram/estimate', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    const bytes = res.data && res.data.bytes ? res.data.bytes : null;
                    if (bytes) {
                         const toMiB = (val) => (val / (1024 * 1024)).toFixed(1);
                         const total = toMiB(bytes.totalVramRequired || 0);
                         const weights = toMiB(bytes.modelWeights || 0);
                         const kv = toMiB(bytes.kvCache || 0);
                         const overhead = toMiB(bytes.runtimeOverhead || 0);
                         
                        const text = `预计显存：总计 ${total} MiB（权重 ${weights}，KV ${kv}，其他 ${overhead}）`;
                        const hint = document.getElementById('ctxSizeVramHint');
                        if (hint) hint.textContent = text;
                        /*
                        // 显示结果区域
                        const resultDiv = document.getElementById('vramEstimateResult');
                        const groupDiv = document.getElementById('vramEstimateGroup');
                        if (resultDiv && groupDiv) {
                            resultDiv.textContent = text;
                            groupDiv.style.display = 'block';
                        } else {
                             // Fallback
                             const hint = document.getElementById('ctxSizeVramHint');
                             if (hint) hint.textContent = text;
                        }
                        */
                    } else {
                        showToast('错误', '返回数据格式不正确', 'error');
                    }
                } else {
                    showToast('错误', (res && res.error) ? res.error : '估算失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }

        function openSlotsModal(modelId, displayName) {
            const modalId = 'slotsModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content slots-modal">
                        <div class="modal-header">
                            <h3 class="modal-title">缓存管理 - ${displayName}</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">&times;</button>
                        </div>
                        <div class="modal-body" id="${modalId}Content">
                            <div style="padding: 12px;">加载中...</div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button>
                            <button class="btn btn-primary" onclick="saveSelectedSlot('${modelId}')">保存</button>
                            <button class="btn btn-primary" onclick="loadSelectedSlot('${modelId}')">读取</button>
                            <button class="btn btn-primary" onclick="fetchSlotsForModel('${modelId}')">刷新</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            modal.classList.add('show');
            fetchSlotsForModel(modelId);
        }

        function fetchSlotsForModel(modelId) {
            const container = document.getElementById('slotsModalContent');
            fetch(`/api/models/slots/get?modelId=${encodeURIComponent(modelId)}`)
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        const el = document.getElementById('slotsModalContent') || document.getElementById('slotsModal').querySelector('.modal-body');
                        if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">加载失败</div><div class="empty-state-text">${d.error || '未知错误'}</div></div>`;
                        return;
                    }
                    const slots = (d.data && d.data.slots) ? d.data.slots : [];
                    renderSlotsContent(slots);
                })
                .catch(e => {
                    const el = document.getElementById('slotsModalContent') || document.getElementById('slotsModal').querySelector('.modal-body');
                    if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="empty-state-title">网络错误</div><div class="empty-state-text">${e.message || ''}</div></div>`;
                });
        }

        function saveSelectedSlot(modelId) {
            const selectEl = document.getElementById('slotSelect');
            const slots = window.__slotsData || [];
            if (!selectEl || !slots.length) {
                showToast('错误', '未找到可保存的Slot', 'error');
                return;
            }
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot && idx < 0) {
                showToast('错误', '未选择有效的Slot', 'error');
                return;
            }
            let slotId = slot && slot.id !== undefined ? slot.id : idx;
            slotId = parseInt(slotId, 10);
            if (Number.isNaN(slotId)) slotId = idx;
            fetch('/api/models/slots/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, slotId })
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    showToast('成功', '保存成功', 'success');
                } else {
                    showToast('错误', (res && res.error) ? res.error : '保存失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }
        
        function loadSelectedSlot(modelId) {
            const selectEl = document.getElementById('slotSelect');
            const slots = window.__slotsData || [];
            if (!selectEl || !slots.length) {
                showToast('错误', '未找到可读取的Slot', 'error');
                return;
            }
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot && idx < 0) {
                showToast('错误', '未选择有效的Slot', 'error');
                return;
            }
            let slotId = slot && slot.id !== undefined ? slot.id : idx;
            slotId = parseInt(slotId, 10);
            if (Number.isNaN(slotId)) slotId = idx;
            fetch('/api/models/slots/load', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, slotId })
            }).then(r => r.json()).then(res => {
                if (res && res.success) {
                    showToast('成功', '读取成功', 'success');
                } else {
                    showToast('错误', (res && res.error) ? res.error : '读取失败', 'error');
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
            });
        }

        function renderSlotsContent(slots) {
            const modal = document.getElementById('slotsModal');
            const body = document.getElementById('slotsModalContent') || (modal ? modal.querySelector('.modal-body') : null);
            if (!body) return;
            if (!slots || !slots.length) {
                body.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-database"></i></div><div class="empty-state-title">无可用Slot</div><div class="empty-state-text">当前模型没有可用的处理槽位</div></div>`;
                return;
            }
            window.__slotsData = slots;
            const prevIndex = (() => {
                const sel = document.getElementById('slotSelect');
                if (sel && sel.value !== '') {
                    const v = parseInt(sel.value, 10);
                    if (!Number.isNaN(v)) return v;
                }
                return 0;
            })();
            let html = '';
            html += `<div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">`;
            html += `<label class="form-label" for="slotSelect" style="margin:0;">选择 Slot</label>`;
            html += `<select class="form-control" id="slotSelect" style="max-width:320px;">`;
            slots.forEach((s, idx) => {
                const id = s.id !== undefined ? s.id : idx;
                const running = s.is_processing ? '处理中' : '空闲';
                const nctx = s.n_ctx !== undefined ? s.n_ctx : '';
                html += `<option value="${idx}">ID ${id} · ${running} · ctx ${nctx}</option>`;
            });
            html += `</select>`;
            html += `</div>`;
            html += `<pre id="slotJsonViewer" style="flex:1; min-height:0; overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>`;
            body.id = 'slotsModalContent';
            body.innerHTML = html;
            const selectEl = document.getElementById('slotSelect');
            if (selectEl) {
                const idx = Math.min(Math.max(prevIndex, 0), slots.length - 1);
                selectEl.selectedIndex = idx;
                selectEl.onchange = updateSlotJsonViewer;
            }
            updateSlotJsonViewer();
        }

        function updateSlotJsonViewer() {
            const slots = window.__slotsData || [];
            const selectEl = document.getElementById('slotSelect');
            const viewer = document.getElementById('slotJsonViewer');
            if (!selectEl || !viewer || !slots.length) return;
            const idx = parseInt(selectEl.value, 10) || 0;
            const slot = slots[idx];
            if (!slot) {
                viewer.textContent = '';
                return;
            }
            try {
                viewer.textContent = JSON.stringify(slot, null, 2);
            } catch (e) {
                viewer.textContent = '';
            }
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
        }

        function showModelLoadingState(modelId) {
             let loadingToast = document.getElementById('loading-toast-' + modelId);
            if (!loadingToast) {
                const toastContainer = document.getElementById('toastContainer');
                const toastHtml = `
                    <div class="toast info" id="loading-toast-${modelId}">
                        <div class="toast-icon"><i class="fas fa-spinner fa-spin"></i></div>
                        <div class="toast-content"><div class="toast-title">加载中</div><div class="toast-message">正在加载...</div></div>
                    </div>`;
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            }
        }
        function removeModelLoadingState(modelId) {
            const el = document.getElementById('loading-toast-' + modelId);
            if (el) el.remove();
        }

        function stopModel(modelId) {
             fetch('/api/models/stop', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId })
            }).then(r => r.json()).then(d => {
                if (!d.success) showToast('错误', d.error, 'error');
            });
        }

        function viewModelDetails(modelId) {
            fetch(`/api/models/details?modelId=${modelId}`).then(r => r.json()).then(data => {
                if (data.success) {
                    const model = data.model;
                    window.__modelDetailModelId = modelId;
                    showModelDetailModal(model);
                } else { showToast('错误', data.error, 'error'); }
            });
        }
        
        function showModelDetailModal(model) {
            const modalId = 'modelDetailModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content model-detail"><div class="modal-header"><h3 class="modal-title">模型详情</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body" id="${modalId}Content"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button></div></div>`;
                document.body.appendChild(modal);
            }
            const content = document.getElementById(modalId + 'Content');
            let tabs = `<div style="display:flex; gap:8px; margin-bottom:12px;">` +
                        `<button class="btn btn-secondary" id="${modalId}TabInfo">概览</button>` +
                        `<button class="btn btn-secondary" id="${modalId}TabMetrics">metrics</button>` +
                        `<button class="btn btn-secondary" id="${modalId}TabProps">props</button>` +
                        `</div>`;
            let wrapperStart = `<div style="display:flex; flex-direction:column; height:60vh; min-height:60vh;">`;
            let bodyStart = `<div style="flex:1; min-height:0;">`;
            let infoPanel = `<div id="${modalId}InfoPanel" style="height:100%;">` +
                            `<div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px; height:100%; overflow:auto;">` +
                            `<div><strong>名称:</strong></div><div>${model.name}</div>` +
                            `<div><strong>路径:</strong></div><div style="word-break:break-all;">${model.path}</div>` +
                            `<div><strong>大小:</strong></div><div>${formatFileSize(model.size)}</div>` +
                            `${model.isLoaded ? `<div><strong>状态:</strong></div><div>已启动${model.port ? `（端口 ${model.port}）` : ''}</div>` : `<div><strong>状态:</strong></div><div>未启动</div>`}` +
                            `${model.startCmd ? `<div><strong>启动命令:</strong></div><div style="word-break:break-all; font-family: monospace;">${model.startCmd}</div>` : ``}` +
                            `${(() => { let s=''; if (model.metadata) { for (const [k,v] of Object.entries(model.metadata)) { s += `<div><strong>${k}:</strong></div><div style="word-break:break-all;">${v}</div>`; } } return s; })()}` +
                            `</div>` +
                            `</div>`;
            let metricsPanel = `<div id="${modalId}MetricsPanel" style="display:none; height:100%;">` +
                               `<div style="display:flex; gap:8px; margin-bottom:8px;">` +
                               `<button class="btn btn-primary" id="${modalId}MetricsFetchBtn">请求 metrics</button>` +
                               `</div>` +
                               `<pre id="${modalId}MetricsViewer" style="height:calc(100% - 48px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>` +
                               `</div>`;
            let propsPanel = `<div id="${modalId}PropsPanel" style="display:none; height:100%;">` +
                               `<div style="display:flex; gap:8px; margin-bottom:8px;">` +
                               `<button class="btn btn-primary" id="${modalId}PropsFetchBtn">请求 props</button>` +
                               `</div>` +
                               `<pre id="${modalId}PropsViewer" style="height:calc(100% - 48px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>` +
                               `</div>`;
            let bodyEnd = `</div>`;
            let wrapperEnd = `</div>`;
            content.innerHTML = wrapperStart + tabs + bodyStart + infoPanel + metricsPanel + propsPanel + bodyEnd + wrapperEnd;
            modal.classList.add('show');
            const tabInfo = document.getElementById(modalId + 'TabInfo');
            const tabMetrics = document.getElementById(modalId + 'TabMetrics');
            const tabProps = document.getElementById(modalId + 'TabProps');
            const fetchBtn = document.getElementById(modalId + 'MetricsFetchBtn');
            const fetchPropsBtn = document.getElementById(modalId + 'PropsFetchBtn');
            if (tabInfo) tabInfo.onclick = () => openModelDetailTab('info');
            if (tabMetrics) tabMetrics.onclick = () => { openModelDetailTab('metrics'); loadModelMetrics(); };
            if (tabProps) tabProps.onclick = () => { openModelDetailTab('props'); loadModelProps(); };
            if (fetchBtn) fetchBtn.onclick = () => loadModelMetrics();
            if (fetchPropsBtn) fetchPropsBtn.onclick = () => loadModelProps();
            openModelDetailTab('info');
        }
        
        function openModelDetailTab(tab) {
            const modalId = 'modelDetailModal';
            const info = document.getElementById(modalId + 'InfoPanel');
            const metrics = document.getElementById(modalId + 'MetricsPanel');
            const props = document.getElementById(modalId + 'PropsPanel');
            const btnInfo = document.getElementById(modalId + 'TabInfo');
            const btnMetrics = document.getElementById(modalId + 'TabMetrics');
            const btnProps = document.getElementById(modalId + 'TabProps');
            if (info) info.style.display = tab === 'info' ? '' : 'none';
            if (metrics) metrics.style.display = tab === 'metrics' ? '' : 'none';
            if (props) props.style.display = tab === 'props' ? '' : 'none';
            if (btnInfo) { btnInfo.classList.remove('btn-primary'); btnInfo.classList.add(tab === 'info' ? 'btn-primary' : 'btn-secondary'); }
            if (btnMetrics) { btnMetrics.classList.remove('btn-primary'); btnMetrics.classList.add(tab === 'metrics' ? 'btn-primary' : 'btn-secondary'); }
            if (btnProps) { btnProps.classList.remove('btn-primary'); btnProps.classList.add(tab === 'props' ? 'btn-primary' : 'btn-secondary'); }
        }
        
        function loadModelMetrics() {
            const modelId = window.__modelDetailModelId;
            const viewer = document.getElementById('modelDetailModalMetricsViewer');
            if (!modelId || !viewer) return;
            viewer.textContent = '加载中...';
            fetch('/api/models/metrics?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(res => {
                    const d = res && res.success ? res.data : null;
                    const metrics = d && d.metrics ? d.metrics : null;
                    viewer.textContent = metrics ? JSON.stringify(metrics, null, 2) : JSON.stringify(res, null, 2);
                })
                .catch(() => {
                    viewer.textContent = '请求失败';
                });
        }
        
        function loadModelProps() {
            const modelId = window.__modelDetailModelId;
            const viewer = document.getElementById('modelDetailModalPropsViewer');
            if (!modelId || !viewer) return;
            viewer.textContent = '加载中...';
            fetch('/api/models/props?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(res => {
                    const d = res && res.success ? res.data : null;
                    const props = d && d.props ? d.props : null;
                    viewer.textContent = props ? JSON.stringify(props, null, 2) : JSON.stringify(res, null, 2);
                })
                .catch(() => {
                    viewer.textContent = '请求失败';
                });
        }

        function viewModelConfig(modelId) {
            fetch(`/api/models/config/get?modelId=${encodeURIComponent(modelId)}`)
                .then(r => r.json()).then(data => {
                    if (data.success) {
                        showModelConfigModal(data.data.modelId, data.data.config);
                    } else {
                        showToast('错误', data.error || '获取配置失败', 'error');
                    }
                })
                .catch(e => {
                    showToast('错误', '网络请求失败', 'error');
                });
        }

        function showModelConfigModal(modelId, config) {
            const modalId = 'modelConfigModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">启动配置</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body" id="${modalId}Content"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">取消</button><button class="btn btn-primary" onclick="submitModelConfig()">保存</button></div></div>`;
                document.body.appendChild(modal);
            }
            const submitBtnInit = document.querySelector('#modelConfigModal .btn-primary');
            if (submitBtnInit) { submitBtnInit.disabled = false; submitBtnInit.innerHTML = '保存'; }
            const content = document.getElementById(modalId + 'Content');
            const cfg = config || {};
            let html = '';
            html += `
                <form id="modelConfigForm">
                    <input type="hidden" id="configModelId" name="modelId" value="${modelId}">
                    <div class="form-group">
                        <label class="form-label">模型ID</label>
                        <div class="form-control" id="configModelIdDisplay" style="background-color:#f9fafb;">${modelId}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="configCtxSize">上下文大小 (ctx-size)</label>
                        <input type="number" class="form-control" id="configCtxSize" name="ctxSize" min="1" placeholder="例如: 2048">
                    </div>
                    <div class="settings-grid" style="height: auto; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" for="configBatchSize">批处理大小 (batch-size)</label>
                            <input type="number" class="form-control" id="configBatchSize" name="batchSize" min="1" placeholder="例如: 512">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label" for="configUbatchSize">微批处理 (ubatch-size)</label>
                            <input type="number" class="form-control" id="configUbatchSize" name="ubatchSize" min="1" placeholder="例如: 512">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="configLlamaBinPathSelect">Llama.cpp 版本</label>
                        <select class="form-control" id="configLlamaBinPathSelect" name="llamaBinPathSelect"></select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="configNoMmap" name="noMmap">
                            <label class="form-check-label" for="configNoMmap">禁用内存映射 (no-mmap)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="configMlock" name="mlock">
                            <label class="form-check-label" for="configMlock">锁定内存 (mlock)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="configEmbedding" name="embedding">
                            <label class="form-check-label" for="configEmbedding">Embedding模式</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="configReranking" name="reranking">
                            <label class="form-check-label" for="configReranking">Reranking模式</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="configFlashAttention" name="flashAttention">
                            <label class="form-check-label" for="configFlashAttention">Flash Attention</label>
                        </div>
                    </div>
                    <details style="margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem;">
                        <summary style="cursor: pointer; font-size: 0.875rem; color: var(--primary-color); font-weight: 500;">高级参数 (Temperature, Top-P, etc.)</summary>
                        <div style="padding-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label" for="configTemperature">Temperature</label>
                                <input type="number" step="0.01" class="form-control" id="configTemperature" name="temperature">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="configTopP">Top P</label>
                                <input type="number" step="0.01" class="form-control" id="configTopP" name="topP">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="configTopK">Top K</label>
                                <input type="number" class="form-control" id="configTopK" name="topK">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="configMinP">Min P</label>
                                <input type="number" step="0.01" class="form-control" id="configMinP" name="minP">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="configPresencePenalty">Presence Penalty</label>
                                <input type="number" step="0.01" class="form-control" id="configPresencePenalty" name="presencePenalty">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="configRepeatPenalty">Repeat Penalty</label>
                                <input type="number" step="0.01" class="form-control" id="configRepeatPenalty" name="repeatPenalty">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label" for="configExtraParams">额外参数</label>
                            <textarea class="form-control" id="configExtraParams" name="extraParams" rows="2" placeholder="例如: --grp-attn-n 8 --grp-attn-w 512"></textarea>
                        </div>
                    </details>
                </form>
            `;
            content.innerHTML = html;
            window.__modelConfigModelId = modelId;
            const c = cfg || {};
            if (c.ctxSize !== undefined && c.ctxSize !== null) document.getElementById('configCtxSize').value = c.ctxSize;
            if (c.batchSize !== undefined && c.batchSize !== null) document.getElementById('configBatchSize').value = c.batchSize;
            if (c.ubatchSize !== undefined && c.ubatchSize !== null) document.getElementById('configUbatchSize').value = c.ubatchSize;
            if (c.temperature !== undefined && c.temperature !== null) document.getElementById('configTemperature').value = c.temperature;
            if (c.topP !== undefined && c.topP !== null) document.getElementById('configTopP').value = c.topP;
            if (c.topK !== undefined && c.topK !== null) document.getElementById('configTopK').value = c.topK;
            if (c.minP !== undefined && c.minP !== null) document.getElementById('configMinP').value = c.minP;
            if (c.presencePenalty !== undefined && c.presencePenalty !== null) document.getElementById('configPresencePenalty').value = c.presencePenalty;
            if (c.repeatPenalty !== undefined && c.repeatPenalty !== null) document.getElementById('configRepeatPenalty').value = c.repeatPenalty;
            document.getElementById('configNoMmap').checked = !!c.noMmap;
            document.getElementById('configMlock').checked = !!c.mlock;
            document.getElementById('configEmbedding').checked = !!c.embedding;
            document.getElementById('configReranking').checked = !!c.reranking;
            document.getElementById('configFlashAttention').checked = c.flashAttention !== undefined ? c.flashAttention : true;
            document.getElementById('configExtraParams').value = c.extraParams || '';
            fetch('/api/llamacpp/list').then(r => r.json()).then(listData => {
                const select = document.getElementById('configLlamaBinPathSelect');
                const paths = (listData && listData.success && listData.data) ? (listData.data.paths || []) : [];
                select.innerHTML = paths.map(p => `<option value="${p}">${p}</option>`).join('');
                if (c.llamaBinPath) {
                    select.value = c.llamaBinPath;
                } else {
                    fetch('/api/setting').then(rs => rs.json()).then(s => {
                        const currentBin = (s && s.success && s.data) ? s.data.llamaBin : null;
                        if (currentBin && select) select.value = currentBin;
                    }).catch(()=>{});
                }
            }).finally(() => {
                modal.classList.add('show');
            });
        }

        function submitModelConfig() {
            const form = document.getElementById('modelConfigForm');
            if (!form) return;
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (['ctxSize', 'batchSize', 'ubatchSize', 'topK'].includes(key)) data[key] = parseInt(value);
                else if (['temperature', 'topP', 'minP', 'presencePenalty', 'repeatPenalty'].includes(key)) data[key] = parseFloat(value);
                else if (['noMmap', 'mlock', 'embedding', 'reranking'].includes(key)) data[key] = value === 'on';
                else data[key] = value;
            });
            data.noMmap = document.getElementById('configNoMmap').checked;
            data.mlock = document.getElementById('configMlock').checked;
            data.embedding = document.getElementById('configEmbedding').checked;
            data.reranking = document.getElementById('configReranking').checked;
            data.flashAttention = document.getElementById('configFlashAttention').checked;
            data.llamaBinPath = document.getElementById('configLlamaBinPathSelect').value;
            data.extraParams = document.getElementById('configExtraParams').value;
            const submitBtn = document.querySelector('#modelConfigModal .btn-primary');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            }
            fetch('/api/models/config/set', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if (res.success) {
                    showToast('成功', '启动配置已保存', 'success');
                    closeModal('modelConfigModal');
                } else {
                    showToast('错误', res.error || '保存失败', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '保存';
                    }
                }
            }).catch(() => {
                showToast('错误', '网络请求失败', 'error');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '保存';
                }
            });
        }

        function openModelBenchmarkDialog(modelId, modelName) {
            const modalId = 'modelBenchmarkModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 520px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-tachometer-alt"></i> 模型性能测试</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">模型</label>
                                <div class="form-control" id="benchmarkModelName" style="background-color:#f9fafb;"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="benchmarkLlamaBinPathSelect">Llama.cpp 版本</label>
                                <select class="form-control" id="benchmarkLlamaBinPathSelect"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">重复次数 (-r)</label>
                                <input type="number" class="form-control" id="benchmarkInputRepetitions" min="1" value="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">提示长度 (-p)</label>
                                <input type="text" class="form-control" id="benchmarkInputNPrompt" value="2048" placeholder="例如: 512 或 512,1024">
                            </div>
                            <div class="form-group">
                                <label class="form-label">生成长度 (-n)</label>
                                <input type="text" class="form-control" id="benchmarkInputNGen" value="32" placeholder="例如: 128 或 128,256">
                            </div>
                            <div class="form-group">
                                <label class="form-label">批量 (-b)</label>
                                <input type="text" class="form-control" id="benchmarkInputBatchSize" value="2048" placeholder="例如: 512 或 512,1024">
                            </div>
                            <div class="form-group">
                                <label class="form-label">子批 (-ub)</label>
                                <input type="text" class="form-control" id="benchmarkInputUBatchSize" value="2048" placeholder="例如: 512 或 512,1024">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prompt/生成组合 (-pg)</label>
                                <input type="text" class="form-control" id="benchmarkInputPg" placeholder="例如: 512,128 或 256,64">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Flash Attention (-fa)</label>
                                <input type="text" class="form-control" id="benchmarkInputFa" value="1" placeholder="例如: 0,1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">内存映射 (-mmp)</label>
                                <input type="text" class="form-control" id="benchmarkInputMmp" value="0" placeholder="例如: 0,1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">线程 (-t)</label>
                                <input type="text" class="form-control" id="benchmarkInputThreads" placeholder="例如: 4 或 4,8">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="benchmarkInputExtraParams">额外参数</label>
                                <textarea class="form-control" id="benchmarkInputExtraParams" rows="2" placeholder="例如: --grp-attn-n 8 --grp-attn-w 512"></textarea>
                                <small class="form-text">输入额外的命令行参数，用空格分隔</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">取消</button>
                            <button class="btn btn-primary" id="benchmarkRunBtn" onclick="submitModelBenchmark()">开始测试</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            window.__benchmarkModelId = modelId;
            window.__benchmarkModelName = modelName;
            const nameEl = document.getElementById('benchmarkModelName');
            if (nameEl) {
                nameEl.textContent = modelName || modelId;
            }
            const repInput = document.getElementById('benchmarkInputRepetitions');
            const nPromptInput = document.getElementById('benchmarkInputNPrompt');
            const nGenInput = document.getElementById('benchmarkInputNGen');
            const threadsInput = document.getElementById('benchmarkInputThreads');
            const batchInput = document.getElementById('benchmarkInputBatchSize');
            const ubatchInput = document.getElementById('benchmarkInputUBatchSize');
            const pgInput = document.getElementById('benchmarkInputPg');
            const faInput = document.getElementById('benchmarkInputFa');
            const mmpInput = document.getElementById('benchmarkInputMmp');
            const extraInput = document.getElementById('benchmarkInputExtraParams');
            if (repInput) repInput.value = repInput.value || 3;
            if (nPromptInput) nPromptInput.value = nPromptInput.value || 512;
            if (nGenInput) nGenInput.value = nGenInput.value || 128;
            if (threadsInput) threadsInput.value = '';
            if (pgInput) pgInput.value = '';
            if (extraInput) extraInput.value = '';
            // Load llama.cpp versions
            const binSelect = document.getElementById('benchmarkLlamaBinPathSelect');
            if (binSelect) {
                binSelect.innerHTML = '<option value="">加载中...</option>';
                fetch('/api/llamacpp/list')
                    .then(r => r.json())
                    .then(listData => {
                        const paths = (listData && listData.success && listData.data) ? (listData.data.paths || []) : [];
                        if (!paths.length) {
                            binSelect.innerHTML = '<option value="">未配置路径</option>';
                        } else {
                            binSelect.innerHTML = paths.map(p => `<option value="${p}">${p}</option>`).join('');
                            binSelect.value = paths[0];
                        }
                    })
                    .catch(() => {
                        binSelect.innerHTML = '<option value="">加载失败</option>';
                    })
                    .finally(() => {
                        modal.classList.add('show');
                    });
            } else {
                modal.classList.add('show');
            }
        }

        function submitModelBenchmark() {
            const modelId = window.__benchmarkModelId;
            const modelName = window.__benchmarkModelName;
            if (!modelId) {
                showToast('错误', '未选择模型', 'error');
                return;
            }
            const repInput = document.getElementById('benchmarkInputRepetitions');
            const nPromptInput = document.getElementById('benchmarkInputNPrompt');
            const nGenInput = document.getElementById('benchmarkInputNGen');
            const threadsInput = document.getElementById('benchmarkInputThreads');
            const batchInput = document.getElementById('benchmarkInputBatchSize');
            const ubatchInput = document.getElementById('benchmarkInputUBatchSize');
            const pgInput = document.getElementById('benchmarkInputPg');
            const faInput = document.getElementById('benchmarkInputFa');
            const mmpInput = document.getElementById('benchmarkInputMmp');
            const extraInput = document.getElementById('benchmarkInputExtraParams');
            const btn = document.getElementById('benchmarkRunBtn');
            const binSelect = document.getElementById('benchmarkLlamaBinPathSelect');

            let repetitions = repInput ? parseInt(repInput.value, 10) : 3;
            const p = nPromptInput ? nPromptInput.value.trim() : '';
            const n = nGenInput ? nGenInput.value.trim() : '';
            const t = threadsInput ? threadsInput.value.trim() : '';
            const batchSize = batchInput ? batchInput.value.trim() : '';
            const ubatchSize = ubatchInput ? ubatchInput.value.trim() : '';
            const pg = pgInput ? pgInput.value.trim() : '';
            const fa = faInput ? faInput.value.trim() : '';
            const mmp = mmpInput ? mmpInput.value.trim() : '';
            const extraParams = extraInput ? extraInput.value.trim() : '';
            const llamaBinPath = binSelect ? (binSelect.value || '').trim() : '';

            if (isNaN(repetitions) || repetitions <= 0) repetitions = 3;
            if (!llamaBinPath) {
                showToast('错误', '请先选择 Llama.cpp 版本路径', 'error');
                return;
            }

            const payload = { modelId: modelId };
            if (repetitions > 0) payload.repetitions = repetitions;
            if (p) payload.p = p;
            if (n) payload.n = n;
            if (t) payload.t = t;
            if (batchSize) payload.batchSize = batchSize;
            if (ubatchSize) payload.ubatchSize = ubatchSize;
            if (pg) payload.pg = pg;
            if (fa) payload.fa = fa;
            if (mmp) payload.mmp = mmp;
            if (extraParams) payload.extraParams = extraParams;
            payload.llamaBinPath = llamaBinPath;

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '测试中...';
            }
            showToast('提示', '已开始模型测试', 'info');

            fetch('/api/models/benchmark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(r => r.json())
                .then(res => {
                    if (!res || !res.success) {
                        const message = res && res.error ? res.error : '模型测试失败';
                        showToast('错误', message, 'error');
                    } else {
                        const data = res.data || {};
                        closeModal('modelBenchmarkModal');
                        showModelBenchmarkResultModal(modelId, modelName, data);
                    }
                })
                .catch(() => {
                    showToast('错误', '网络请求失败', 'error');
                })
                .then(() => {
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '开始测试';
                    }
                });
        }
 
        function openModelBenchmarkList(modelId, modelName) {
            const modalId = 'modelBenchmarkCompareModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="min-width: 70vw; max-width: 95vw;">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-file-alt"></i> 模型测试结果对比</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display:flex; gap:16px; height:60vh;">
                                <div style="width:32%; border:1px solid #e5e7eb; border-radius:0.75rem; overflow:hidden; background:#f9fafb;">
                                    <div style="padding:8px 10px; border-bottom:1px solid #e5e7eb; font-size:13px; color:#374151;">测试结果文件</div>
                                    <div id="${modalId}List" style="max-height:calc(60vh - 36px); overflow:auto; font-size:13px; color:#374151;">加载中...</div>
                                </div>
                                <div style="flex:1; display:flex; flex-direction:column; min-width:0;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                        <div id="${modalId}ModelInfo" style="font-size:14px; color:#374151;"></div>
                                        <div>
                                            <button class="btn btn-secondary" style="padding:4px 10px; font-size:12px;" onclick="clearBenchmarkResultContent()">清空内容</button>
                                        </div>
                                    </div>
                                    <pre id="${modalId}Content" style="flex:1; max-height:calc(60vh - 36px); overflow:auto; font-size:13px; background:#111827; color:#e5e7eb; padding:10px; border-radius:0.75rem;"></pre>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">关闭</button>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            }
            window.__benchmarkModelId = modelId;
            window.__benchmarkModelName = modelName;
            const listEl = document.getElementById(modalId + 'List');
            const modelInfoEl = document.getElementById(modalId + 'ModelInfo');
            if (modelInfoEl) {
                const name = modelName || modelId;
                modelInfoEl.textContent = name ? '当前模型: ' + name : '';
            }
            if (listEl) listEl.innerHTML = '加载中...';
            modal.classList.add('show');
            fetch('/api/models/benchmark/list?modelId=' + encodeURIComponent(modelId))
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        showToast('错误', d.error || '获取测试结果列表失败', 'error');
                        return;
                    }
                    const files = (d.data && d.data.files) ? d.data.files : [];
                    if (!files.length) {
                        listEl.innerHTML = '<div style="color:#666; padding:8px 10px;">未找到测试结果文件</div>';
                        return;
                    }
                    let html = '<div style="border-top:1px solid #e5e7eb;">';
                    files.forEach(item => {
                        const fn = typeof item === 'string' ? item : (item && item.name) ? item.name : '';
                        const size = (item && typeof item === 'object' && item.size != null) ? item.size : null;
                        const modified = (item && typeof item === 'object' && item.modified) ? item.modified : '';
                        const sizeText = size != null ? (typeof formatFileSize === 'function' ? formatFileSize(size) : (size + ' B')) : '';
                        html += `
                            <div class="list-row" style="display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-bottom:1px solid #e5e7eb; background:#f9fafb;">
                                <div style="display:flex; flex-direction:column; gap:4px; max-width:65%;">
                                    <span style="word-break:break-all;"><i class="fas fa-file-alt" style="margin-right:6px;"></i>${fn}</span>
                                    <span style="color:#6b7280; font-size:12px;">修改时间: ${modified || '-'}</span>
                                    <span style="color:#6b7280; font-size:12px;">大小: ${sizeText || '-'}</span>
                                </div>
                                <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
                                    <button class="btn btn-primary" style="padding:2px 10px; font-size:12px;" onclick="loadBenchmarkResult(this.dataset.fn)" data-fn="${fn}">追加</button>
                                    <button class="btn btn-secondary" style="padding:2px 10px; font-size:12px;" onclick="deleteBenchmarkResult(this.dataset.fn, this)" data-fn="${fn}">删除</button>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                    listEl.innerHTML = html;
                }).catch(() => {
                    showToast('错误', '网络错误，获取测试结果列表失败', 'error');
                });
        }

        function deleteBenchmarkResult(fileName, btn) {
            if (!fileName) {
                showToast('错误', '无效的文件名', 'error');
                return;
            }
            if (!confirm('确定要删除该测试结果文件吗？')) {
                return;
            }
            btn.disabled = true;
            fetch('/api/models/benchmark/delete?fileName=' + encodeURIComponent(fileName), {
                method: 'POST'
            }).then(r => r.json()).then(d => {
                if (!d.success) {
                    showToast('错误', d.error || '删除测试结果失败', 'error');
                    btn.disabled = false;
                    return;
                }
                const row = btn.closest('.list-row');
                if (row && row.parentElement) {
                    row.parentElement.removeChild(row);
                }
                showToast('成功', '测试结果已删除', 'success');
            }).catch(() => {
                showToast('错误', '网络错误，删除测试结果失败', 'error');
                btn.disabled = false;
            });
        }

        function clearBenchmarkResultContent() {
            const modalId = 'modelBenchmarkCompareModal';
            const contentEl = document.getElementById(modalId + 'Content');
            if (contentEl) {
                contentEl.textContent = '';
            }
        }

        function appendBenchmarkResultBlock(modelId, modelName, data) {
            const modalId = 'modelBenchmarkCompareModal';
            const contentEl = document.getElementById(modalId + 'Content');
            if (!contentEl) {
                return;
            }
            const name = modelName || modelId || '';
            const d = data || {};
            let text = '';
            const existing = contentEl.textContent || '';
            if (existing.trim().length > 0) {
                text += '\n\n';
            }
            const fileName = d.fileName || '';
            text += '==============================\n';
            if (fileName) {
                text += '文件: ' + fileName + '\n';
            }
            if (name) {
                text += '模型: ' + name + '\n';
            }
            if (d.modelId || modelId) {
                text += '模型ID: ' + (d.modelId || modelId || '') + '\n';
            }
            if (d.commandStr) {
                text += '\n命令:\n' + d.commandStr + '\n';
            } else if (d.command && d.command.length) {
                text += '\n命令:\n' + d.command.join(' ') + '\n';
            }
            if (d.exitCode != null) {
                text += '\n退出码: ' + d.exitCode + '\n';
            }
            if (d.savedPath) {
                text += '\n保存文件: ' + d.savedPath + '\n';
            }
            if (d.rawOutput) {
                text += '\n原始输出:\n' + d.rawOutput + '\n';
            }
            contentEl.textContent += text;
        }

        function loadBenchmarkResult(fileName) {
            const modelId = window.__benchmarkModelId;
            const modelName = window.__benchmarkModelName;
            if (!fileName) {
                showToast('错误', '无效的文件名', 'error');
                return;
            }
            fetch('/api/models/benchmark/get?fileName=' + encodeURIComponent(fileName))
                .then(r => r.json())
                .then(d => {
                    if (!d.success) {
                        showToast('错误', d.error || '读取测试结果失败', 'error');
                        return;
                    }
                    const data = d.data || {};
                    appendBenchmarkResultBlock(modelId, modelName, data);
                }).catch(() => {
                    showToast('错误', '网络错误，读取测试结果失败', 'error');
                });
        }

        function showModelBenchmarkResultModal(modelId, modelName, data) {
            openModelBenchmarkList(modelId, modelName);
            appendBenchmarkResultBlock(modelId, modelName, data);
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('show');
            if (id === 'consoleModal') stopConsoleAuto();
            if (id === 'loadModelModal') {
                document.getElementById('loadModelForm').reset();
                const btn = document.querySelector('#loadModelModal .btn-primary');
                if (btn) { btn.disabled = false; btn.innerHTML = '加载模型'; }
            }
            if (id === 'modelConfigModal') {
                const btn = document.querySelector('#modelConfigModal .btn-primary');
                if (btn) { btn.disabled = false; btn.innerHTML = '保存'; }
            }
        }
        
        // Window clicks
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id !== 'loadModelModal') closeModal(e.target.id);
            }
        };

        function showToast(title, msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            const html = `
                <div class="toast ${type}" id="${id}">
                    <div class="toast-icon"><i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i></div>
                    <div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${msg}</div></div>
                    <button class="toast-close" onclick="document.getElementById('${id}').remove()">&times;</button>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
            setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, 5000);
        }
        
        // Alias Logic
         function openAliasModal(modelId, originalName, currentAlias) {
            const modalId = 'aliasModal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div'); modal.id = modalId; modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content" style="max-width:500px;"><div class="modal-header"><h3 class="modal-title">设置别名</h3><button class="modal-close" onclick="closeModal('${modalId}')">&times;</button></div><div class="modal-body"><div class="form-group"><label class="form-label">原名</label><input class="form-control" id="aliasOriginalName" readonly></div><div class="form-group"><label class="form-label">别名</label><input class="form-control" id="aliasInput"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('${modalId}')">取消</button><button class="btn btn-primary" onclick="submitAlias()">保存</button></div></div>`;
                document.body.appendChild(modal);
            }
            window.__aliasEditingModelId = modelId;
            document.getElementById('aliasOriginalName').value = originalName;
            document.getElementById('aliasInput').value = currentAlias;
            modal.classList.add('show');
        }
        function submitAlias() {
            const modelId = window.__aliasEditingModelId;
            const alias = document.getElementById('aliasInput').value;
             fetch('/api/model/alias/set', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ modelId, alias })
            }).then(r => r.json()).then(d => {
                if (d.success) { showToast('成功', '别名已保存', 'success'); closeModal('aliasModal'); refreshModels(); }
                else { showToast('错误', d.error, 'error'); }
            });
        }
        
        // Settings Logic (simplified)
        function openSettingsModal() {
            loadSettings();
            loadLlamaCppList();
            document.getElementById('settingsModal').classList.add('show');
        }
        function openAddModelPathModal() {
            document.getElementById('addModelPathModal').classList.add('show');
        }
        function openAddLlamaCppPathModal() {
            document.getElementById('addLlamaCppPathModal').classList.add('show');
        }
        function loadSettings() {
             fetch('/api/setting').then(r => r.json()).then(d => {
                if (d.success) {
                    const paths = (d.data && d.data.modelPaths) ? d.data.modelPaths : [];
                    window.__modelPaths = paths;
                    renderModelPathList();
                }
            });
        }
        function renderModelPathList() {
            const c = document.getElementById('modelPathListContainer');
            const paths = window.__modelPaths || [];
            if (!paths.length) {
                c.innerHTML = `<div class="settings-empty">尚未配置任何目录</div>`;
                return;
            }
            c.innerHTML = paths.map(p => `
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-item-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <span class="settings-item-text" title="${p}">${p}</span>
                    </div>
                    <button type="button" class="btn-icon danger" onclick="removeModelPathItem('${p.replace(/\\/g, '\\\\')}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        function addModelPath() {
            const v = document.getElementById('addModelPathInput').value.trim();
            if (v) {
                if (!window.__modelPaths) window.__modelPaths = [];
                window.__modelPaths.push(v);
                renderModelPathList();
                document.getElementById('addModelPathInput').value = '';
                closeModal('addModelPathModal');
            }
        }
        function removeModelPathItem(p) {
             window.__modelPaths = window.__modelPaths.filter(x => x !== p);
             renderModelPathList();
        }
        function saveSettings() {
            fetch('/api/setting', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ modelPaths: window.__modelPaths })
            }).then(r => r.json()).then(d => {
                if(d.success) { showToast('成功', '设置已保存', 'success'); closeModal('settingsModal'); refreshModels(); }
                else showToast('错误', d.error, 'error');
            });
        }
        // LlamaCpp Path logic similar to above... (Skipped for brevity in this manual rewrite, but should be included)
        function loadLlamaCppList() {
             fetch('/api/llamacpp/list').then(r => r.json()).then(d => {
                 if (d.success) {
                     window.__llamaPaths = d.data.paths || [];
                     renderLlamaPathList();
                 }
             });
        }
        function renderLlamaPathList() {
            const c = document.getElementById('llamaCppListContainer');
            const paths = window.__llamaPaths || [];
            if (!paths.length) {
                c.innerHTML = `<div class="settings-empty">尚未配置任何路径</div>`;
                return;
            }
            c.innerHTML = paths.map(p => `
                <div class="settings-item">
                    <div class="settings-item-main">
                        <div class="settings-item-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <span class="settings-item-text" title="${p}">${p}</span>
                    </div>
                    <button type="button" class="btn-icon danger" onclick="removeLlamaCppPathItem('${p.replace(/\\/g, '\\\\')}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        function addLlamaCppPath() {
             const v = document.getElementById('addLlamaCppPathInput').value.trim();
             if(v) {
                 fetch('/api/llamacpp/add', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:v}) })
                 .then(r=>r.json()).then(d=>{ if(d.success) { loadLlamaCppList(); document.getElementById('addLlamaCppPathInput').value=''; closeModal('addLlamaCppPathModal'); } else showToast('错误', d.error, 'error'); });
             }
        }
        function removeLlamaCppPathItem(p) {
             fetch('/api/llamacpp/remove', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:p}) })
                 .then(r=>r.json()).then(d=>{ if(d.success) loadLlamaCppList(); else showToast('错误', d.error, 'error'); });
        }
        
        function shutdownService() {
            if (confirm('确定要停止服务吗？')) {
                fetch('/api/shutdown', { method: 'POST' }).then(r=>r.json()).then(d => {
                    if (d.success) {
                        document.body.innerHTML = '<div style="width: 100%;display:flex;justify-content:center;align-items:center;height:100vh;"><h1>服务已停止</h1></div>';
                    }
                });
            }
        }
        
        function filterModels(k) {
            k = k.toLowerCase();
            document.querySelectorAll('.model-item').forEach(el => {
                const name = el.querySelector('.model-name').textContent.toLowerCase();
                el.style.display = name.includes(k) ? '' : 'none';
            });
        }
        function initModelSearch() {
            document.getElementById('modelSearchInput').addEventListener('input', (e) => filterModels(e.target.value));
        }
        
        function normalizeDeviceSelection(device) {
            if (Array.isArray(device)) {
                const list = device
                    .map(v => (v === null || v === undefined) ? '' : String(v))
                    .map(v => v.trim())
                    .filter(v => v.length > 0);
                if (list.includes('All') || list.includes('-1')) return ['All'];
                return list;
            }
            if (device === null || device === undefined || device === '') return [];
            const v = String(device).trim();
            if (!v) return [];
            if (v === 'All' || v === '-1') return ['All'];
            return [v];
        }

        function normalizeMainGpu(v) {
            const n = parseInt(v, 10);
            return Number.isFinite(n) ? n : -1;
        }

        function getSelectedMainGpu() {
            const el = document.getElementById('mainGpuSelect');
            if (!el) return -1;
            const n = parseInt(el.value, 10);
            return Number.isFinite(n) ? n : -1;
        }

        function renderMainGpuSelect(devices) {
            const select = document.getElementById('mainGpuSelect');
            if (!select) return;
            const desired = normalizeMainGpu(window.__loadModelMainGpu);
            const safe = (Array.isArray(devices) && desired >= 0 && desired < devices.length) ? desired : -1;
            const options = ['<option value="-1">默认</option>'];
            if (Array.isArray(devices)) {
                for (let i = 0; i < devices.length; i++) {
                    options.push(`<option value="${i}">${i}: ${escapeHtml(devices[i])}</option>`);
                }
            }
            select.innerHTML = options.join('');
            select.value = String(safe);
        }

        function deviceKeyFromLabel(label) {
            if (label === null || label === undefined) return '';
            const s = String(label).trim();
            const match = s.match(/^([^\s:\-]+)/);
            return match ? match[1].toLowerCase() : s.toLowerCase();
        }

        function getSelectedDevicesFromChecklist() {
            const list = document.getElementById('deviceChecklist');
            if (!list) return [];
            const values = Array.from(list.querySelectorAll('input[type="checkbox"][data-device-key]:checked'))
                .map(el => el.getAttribute('data-device-key'))           // 获取原始字符串
                .map(v => {                                               // 提取前缀：Vulkan0, cuda0 等
                    if (v === null || v === undefined) return '';
                    const trimmed = String(v).trim();
                    // 按第一个冒号分割，取第一部分（设备标识符）
                    return trimmed.split(':')[0];
                })
                .filter(v => v.length > 0 && v !== 'All' && v !== '-1');  // 过滤无效值
            values.sort((a, b) => {
                const ai = parseInt(a, 10);
                const bi = parseInt(b, 10);
                if (Number.isFinite(ai) && Number.isFinite(bi)) return ai - bi;
                return a.localeCompare(b);
            });
            return values;
        }

        // GPU设备选择功能
        function loadDeviceList() {
            const list = document.getElementById('deviceChecklist');
            if (list && list.querySelector('input[type="checkbox"][data-device-key]')) {
                window.__loadModelSelectedDevices = getSelectedDevicesFromChecklist();
            }
            const mainGpuEl = document.getElementById('mainGpuSelect');
            if (mainGpuEl && mainGpuEl.options && mainGpuEl.options.length > 1) {
                window.__loadModelMainGpu = getSelectedMainGpu();
            }
            const llamaBinPath = document.getElementById('llamaBinPathSelect').value;
            
            if (!llamaBinPath) {
                if (list) list.innerHTML = '<div class="settings-empty">请先选择 Llama.cpp 版本</div>';
                renderMainGpuSelect([]);
                return;
            }
            
            // 使用GET请求，将llamaBinPath作为URL参数
            fetch(`/api/model/device/list?llamaBinPath=${encodeURIComponent(llamaBinPath)}`)
            .then(response => response.json())
            .then(data => {
                if (!list) return;
                if (!(data && data.success && data.data && Array.isArray(data.data.devices))) {
                    list.innerHTML = '<div class="settings-empty">获取设备列表失败</div>';
                    renderMainGpuSelect([]);
                    return;
                }
                const devices = data.data.devices;
                window.__availableDevices = devices;
                window.__availableDeviceCount = devices.length;
                renderMainGpuSelect(devices);
                const selected = window.__loadModelSelectedDevices || [];
                const defaultAll = selected.includes('All') || selected.includes('-1');
                const items = devices.map((device, index) => {
                    const key = deviceKeyFromLabel(device);
                    const checked = (defaultAll || selected.includes(key) || selected.includes(device)) ? 'checked' : '';
                    return `<label style="display:flex; align-items:flex-start; gap:8px; padding:6px 6px; border-radius:8px; cursor:pointer;">
                        <input type="checkbox" ${checked} data-device-key="${escapeHtml(key)}" style="margin-top: 2px;">
                        <span style="font-size: 0.9rem; color: var(--text-primary);">${escapeHtml(device)}</span>
                    </label>`;
                });
                list.innerHTML = items.length ? items.join('') : '<div class="settings-empty">未发现可用设备</div>';
            })
            .catch(error => {
                if (list) list.innerHTML = `<div class="settings-empty">获取设备列表失败：${escapeHtml(error && error.message ? error.message : '')}</div>`;
                renderMainGpuSelect([]);
            });
        }
    </script>
</body>
</html>
